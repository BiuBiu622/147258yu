/**
 * æ¸¸æˆè‡ªåŠ¨ç™»å½•æŒ‚æœºæ’ä»¶ - ä¸»ç¨‹åº
 * å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œä¸å½±å“åŸé¡¹ç›®
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { exec } from 'child_process';
import { promisify } from 'util';
import { æ›´æ–°è´¦å·çŠ¶æ€ } from '../../å·¥å…·/è´¦å·çŠ¶æ€.js';  // âœ… å¯¼å…¥æ›´æ–°è´¦å·çŠ¶æ€å‡½æ•°

const execAsync = promisify(exec);
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// é¡¹ç›®æ ¹ç›®å½•ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
const é¡¹ç›®æ ¹ç›®å½• = path.join(__dirname, '../..');

// æ—¥å¿—æ–‡ä»¶è·¯å¾„
const æ—¥å¿—æ–‡ä»¶è·¯å¾„ = path.join(__dirname, 'hangup.log');

// è®°å½•ä¸Šæ¬¡æ¸…ç©ºæ—¥å¿—çš„æ—¥æœŸ
let ä¸Šæ¬¡æ¸…ç©ºæ—¥å¿—æ—¥æœŸ = null;

// æ£€æŸ¥å¹¶æ¸…ç©ºæ—¥å¿—ï¼ˆæ¯å¤©0ç‚¹åæ¸…ç©ºä¸€æ¬¡ï¼‰
function æ£€æŸ¥å¹¶æ¸…ç©ºæ—¥å¿—() {
  const ç°åœ¨ = new Date();
  const ä»Šå¤©æ—¥æœŸ = ç°åœ¨.toDateString(); // ä¾‹å¦‚: "Mon Nov 27 2025"
  
  // å¦‚æœä¸Šæ¬¡æ¸…ç©ºæ—¥æœŸä¸ºç©ºï¼Œæˆ–è€…æ—¥æœŸå·²å˜åŒ–ï¼ˆè·¨å¤©äº†ï¼‰ï¼Œæ¸…ç©ºæ—¥å¿—
  if (ä¸Šæ¬¡æ¸…ç©ºæ—¥å¿—æ—¥æœŸ === null || ä¸Šæ¬¡æ¸…ç©ºæ—¥å¿—æ—¥æœŸ !== ä»Šå¤©æ—¥æœŸ) {
    try {
      // æ¸…ç©ºæ—¥å¿—æ–‡ä»¶ï¼ˆå†™å…¥ç©ºå†…å®¹ï¼‰
      fs.writeFileSync(æ—¥å¿—æ–‡ä»¶è·¯å¾„, '', 'utf-8');
      ä¸Šæ¬¡æ¸…ç©ºæ—¥å¿—æ—¥æœŸ = ä»Šå¤©æ—¥æœŸ;
      console.log(`[æ—¥å¿—æ¸…ç†] å·²æ¸…ç©ºæ—¥å¿—æ–‡ä»¶ï¼ˆæ–°çš„ä¸€å¤©ï¼š${ä»Šå¤©æ—¥æœŸ}ï¼‰`);
    } catch (error) {
      console.error('[æ—¥å¿—æ¸…ç†] æ¸…ç©ºæ—¥å¿—æ–‡ä»¶å¤±è´¥:', error.message);
    }
  }
}

// å†™æ—¥å¿—å‡½æ•°
function å†™æ—¥å¿—(å†…å®¹) {
  // âœ… æ¯æ¬¡å†™æ—¥å¿—å‰æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç©ºï¼ˆæ¯å¤©0ç‚¹åæ¸…ç©ºä¸€æ¬¡ï¼‰
  æ£€æŸ¥å¹¶æ¸…ç©ºæ—¥å¿—();
  
  const æ—¶é—´æˆ³ = new Date().toLocaleString('zh-CN');
  const æ—¥å¿—è¡Œ = `[${æ—¶é—´æˆ³}] ${å†…å®¹}\n`;
  
  // è¾“å‡ºåˆ°æ§åˆ¶å°
  console.log(å†…å®¹);
  
  // è¿½åŠ åˆ°æ—¥å¿—æ–‡ä»¶
  try {
    fs.appendFileSync(æ—¥å¿—æ–‡ä»¶è·¯å¾„, æ—¥å¿—è¡Œ, 'utf-8');
  } catch (error) {
    console.error('å†™æ—¥å¿—å¤±è´¥:', error.message);
  }
}

// è¯»å–é…ç½®
function è¯»å–é…ç½®() {
  const configPath = path.join(__dirname, 'config.json');
  return JSON.parse(fs.readFileSync(configPath, 'utf-8'));
}

// è¯»å–æŒ‚æœºè´¦å·åˆ—è¡¨
function è¯»å–æŒ‚æœºè´¦å·åˆ—è¡¨() {
  const configPath = path.join(é¡¹ç›®æ ¹ç›®å½•, 'data/game-hangup-config.json');
  if (!fs.existsSync(configPath)) return {};
  return JSON.parse(fs.readFileSync(configPath, 'utf-8'));
}

// è¯»å–çª—å£çŠ¶æ€
function è¯»å–çª—å£çŠ¶æ€() {
  const statusPath = path.join(__dirname, 'window-status.json');
  if (!fs.existsSync(statusPath)) return {};
  return JSON.parse(fs.readFileSync(statusPath, 'utf-8'));
}

// ä¿å­˜çª—å£çŠ¶æ€
function ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€) {
  const statusPath = path.join(__dirname, 'window-status.json');
  fs.writeFileSync(statusPath, JSON.stringify(çŠ¶æ€, null, 2), 'utf-8');
}

// è¯»å–è°ƒåº¦è®°å½•ï¼ˆåˆ¤æ–­ä»»åŠ¡æ—¶é—´ï¼‰
function è¯»å–è°ƒåº¦è®°å½•() {
  const recordPath = path.join(é¡¹ç›®æ ¹ç›®å½•, 'data/task-schedule-record.json');
  if (!fs.existsSync(recordPath)) return {};
  return JSON.parse(fs.readFileSync(recordPath, 'utf-8'));
}

// è®¡ç®—è´¦å·ä¸‹æ¬¡ä»»åŠ¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ - åŸºäºè°ƒåº¦å™¨é€»è¾‘
function è®¡ç®—ä¸‹æ¬¡ä»»åŠ¡æ—¶é—´(è´¦å·åç§°) {
  const è®°å½• = è¯»å–è°ƒåº¦è®°å½•();
  const ç°åœ¨ = Date.now();
  let æœ€è¿‘ä»»åŠ¡æ—¶é—´ = Infinity;
  
  // å®šä¹‰æ‰€æœ‰ä»»åŠ¡çš„æ£€æµ‹é€»è¾‘ï¼ˆå¤åˆ¶è°ƒåº¦å™¨çš„é€»è¾‘ï¼‰
  const ä»»åŠ¡åˆ—è¡¨ = [
    {
      åç§°: 'æ¯æ—¥ä»»åŠ¡',
      æ‰§è¡Œé—´éš”: 24 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        // æ¯æ—¥ä»»åŠ¡: æ¯å¤©30åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
        if (!ä¸Šæ¬¡) return 0;
        const è·ç¦» = ç°åœ¨ - new Date(ä¸Šæ¬¡).getTime();
        const ä¸‹æ¬¡ = 30 * 60 * 1000 - è·ç¦»;
        return ä¸‹æ¬¡ > 0 ? ä¸‹æ¬¡ : 0;
      }
    },
    {
      åç§°: 'ç›ç½æœºå™¨',
      æ‰§è¡Œé—´éš”: 6 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        if (!ä¸Šæ¬¡) return 0;
        const è·ç¦» = ç°åœ¨ - new Date(ä¸Šæ¬¡).getTime();
        const ä¸‹æ¬¡ = 6 * 60 * 60 * 1000 - è·ç¦»;
        return ä¸‹æ¬¡ > 0 ? ä¸‹æ¬¡ : 0;
      }
    },
    {
      åç§°: 'æŒ‚æœºå¥–åŠ±',
      æ‰§è¡Œé—´éš”: 6 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        if (!ä¸Šæ¬¡) return 0;
        const è·ç¦» = ç°åœ¨ - new Date(ä¸Šæ¬¡).getTime();
        const ä¸‹æ¬¡ = 6 * 60 * 60 * 1000 - è·ç¦»;
        return ä¸‹æ¬¡ > 0 ? ä¸‹æ¬¡ : 0;
      }
    },
    {
      åç§°: 'BOSSæˆ˜æ–—',
      æ‰§è¡Œé—´éš”: 24 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        const ç°åœ¨æ—¶é—´ = new Date();
        const å°æ—¶ = ç°åœ¨æ—¶é—´.getHours();
        
        // 0ç‚¹æ‰§è¡Œ
        if (å°æ—¶ === 0) return 0;
        
        // è®¡ç®—åˆ°ä»Šæ™š0ç‚¹çš„æ—¶é—´
        const æ˜å¤©0ç‚¹ = new Date(ç°åœ¨æ—¶é—´);
        æ˜å¤©0ç‚¹.setDate(æ˜å¤©0ç‚¹.getDate() + 1);
        æ˜å¤©0ç‚¹.setHours(0, 0, 0, 0);
        return æ˜å¤©0ç‚¹.getTime() - ç°åœ¨;
      }
    },
    {
      åç§°: 'ç«æŠ€åœº',
      æ‰§è¡Œé—´éš”: 24 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        const ç°åœ¨æ—¶é—´ = new Date();
        const å°æ—¶ = ç°åœ¨æ—¶é—´.getHours();
        
        // 8-21ç‚¹æ‰§è¡Œ
        if (å°æ—¶ >= 8 && å°æ—¶ < 22) return 0;
        
        // è®¡ç®—åˆ°æ˜å¤©8ç‚¹çš„æ—¶é—´
        const æ˜å¤©8ç‚¹ = new Date(ç°åœ¨æ—¶é—´);
        if (å°æ—¶ >= 22) {
          æ˜å¤©8ç‚¹.setDate(æ˜å¤©8ç‚¹.getDate() + 1);
        }
        æ˜å¤©8ç‚¹.setHours(8, 0, 0, 0);
        return æ˜å¤©8ç‚¹.getTime() - ç°åœ¨;
      }
    },
    {
      åç§°: 'ä¿±ä¹éƒ¨ç­¾åˆ°',
      æ‰§è¡Œé—´éš”: 24 * 60 * 60 * 1000,
      æ£€æµ‹: (ä¸Šæ¬¡) => {
        if (!ä¸Šæ¬¡) return 0;
        const ä¸Šæ¬¡æ—¶é—´ = new Date(ä¸Šæ¬¡);
        const ç°åœ¨æ—¶é—´ = new Date();
        
        // åŒä¸€å¤©å·²æ‰§è¡Œ
        if (ç°åœ¨æ—¶é—´.toDateString() === ä¸Šæ¬¡æ—¶é—´.toDateString()) {
          // è®¡ç®—åˆ°æ˜å¤©0ç‚¹
          const æ˜å¤©0ç‚¹ = new Date(ç°åœ¨æ—¶é—´);
          æ˜å¤©0ç‚¹.setDate(æ˜å¤©0ç‚¹.getDate() + 1);
          æ˜å¤©0ç‚¹.setHours(0, 0, 0, 0);
          return æ˜å¤©0ç‚¹.getTime() - ç°åœ¨;
        }
        return 0;
      }
    }
  ];
  
  // éå†æ‰€æœ‰ä»»åŠ¡ï¼Œæ‰¾æœ€è¿‘çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
  for (const ä»»åŠ¡ of ä»»åŠ¡åˆ—è¡¨) {
    const è´¦å·è®°å½• = è®°å½•[ä»»åŠ¡.åç§°]?.accounts?.[è´¦å·åç§°];
    if (!è´¦å·è®°å½•) continue;
    
    const ä¸Šæ¬¡æ‰§è¡Œ = è´¦å·è®°å½•.lastExecutionTime;
    const ä¸‹æ¬¡æ‰§è¡Œæ¯«ç§’ = ä»»åŠ¡.æ£€æµ‹(ä¸Šæ¬¡æ‰§è¡Œ);
    
    if (ä¸‹æ¬¡æ‰§è¡Œæ¯«ç§’ < æœ€è¿‘ä»»åŠ¡æ—¶é—´) {
      æœ€è¿‘ä»»åŠ¡æ—¶é—´ = ä¸‹æ¬¡æ‰§è¡Œæ¯«ç§’;
    }
  }
  
  // è¿”å›åˆ†é’Ÿæ•°
  return æœ€è¿‘ä»»åŠ¡æ—¶é—´ === Infinity ? Infinity : æœ€è¿‘ä»»åŠ¡æ—¶é—´ / (60 * 1000);
}

// è·å–è´¦å·æœ€è¿‘ä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
function è·å–æœ€è¿‘ä»»åŠ¡æ‰§è¡Œæ—¶é—´(è´¦å·åç§°) {
  const è®°å½• = è¯»å–è°ƒåº¦è®°å½•();
  let æœ€è¿‘æ‰§è¡Œ = 0;
  
  for (const [ä»»åŠ¡åç§°, ä»»åŠ¡æ•°æ®] of Object.entries(è®°å½•)) {
    const è´¦å·è®°å½• = ä»»åŠ¡æ•°æ®?.accounts?.[è´¦å·åç§°];
    if (è´¦å·è®°å½•?.lastExecutionTime) {
      const æ‰§è¡Œæ—¶é—´ = new Date(è´¦å·è®°å½•.lastExecutionTime).getTime();
      if (æ‰§è¡Œæ—¶é—´ > æœ€è¿‘æ‰§è¡Œ) {
        æœ€è¿‘æ‰§è¡Œ = æ‰§è¡Œæ—¶é—´;
      }
    }
  }
  
  if (æœ€è¿‘æ‰§è¡Œ === 0) return Infinity;
  
  const ç°åœ¨ = Date.now();
  return (ç°åœ¨ - æœ€è¿‘æ‰§è¡Œ) / (60 * 1000);
}

// è·å–è´¦å·æœ€è¿‘æ‰§è¡Œæ—¶é—´æˆ³ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
function è·å–è´¦å·æœ€è¿‘æ‰§è¡Œæ—¶é—´æˆ³(è´¦å·åç§°) {
  const è®°å½• = è¯»å–è°ƒåº¦è®°å½•();
  let æœ€è¿‘æ‰§è¡Œ = 0;
  let æœ€è¿‘ä»»åŠ¡åç§° = '';
  
  // âœ… éå†æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ä»»åŠ¡ï¼Œå¦‚"å’¸å°†å¡”"ï¼‰
  for (const [ä»»åŠ¡åç§°, ä»»åŠ¡æ•°æ®] of Object.entries(è®°å½•)) {
    const è´¦å·è®°å½• = ä»»åŠ¡æ•°æ®?.accounts?.[è´¦å·åç§°];
    if (è´¦å·è®°å½•?.lastExecutionTime) {
      const æ‰§è¡Œæ—¶é—´ = new Date(è´¦å·è®°å½•.lastExecutionTime).getTime();
      if (æ‰§è¡Œæ—¶é—´ > æœ€è¿‘æ‰§è¡Œ) {
        æœ€è¿‘æ‰§è¡Œ = æ‰§è¡Œæ—¶é—´;
        æœ€è¿‘ä»»åŠ¡åç§° = ä»»åŠ¡åç§°; // è®°å½•æœ€è¿‘ä»»åŠ¡åç§°
      }
    }
  }
  
  return æœ€è¿‘æ‰§è¡Œ;
}

// æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡æ ‡é¢˜åŒ¹é…ï¼‰
async function æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°) {
  try {
    const BINæ–‡ä»¶å = `${è´¦å·åç§°}.bin`;
    const ahkScript = `
SetTitleMatchMode, 2
IfWinExist, ${BINæ–‡ä»¶å}
{
    ExitApp, 1
}
ExitApp, 0
`;
    
    const tempScriptPath = path.join(__dirname, `check-${è´¦å·åç§°}.ahk`);
    fs.writeFileSync(tempScriptPath, '\ufeff' + ahkScript, 'utf-8');
    
    try {
      await execAsync(`"${è¯»å–é…ç½®().AutoHotkeyè·¯å¾„}" "${tempScriptPath}"`);
      // é€€å‡ºç 0 = çª—å£ä¸å­˜åœ¨
      fs.unlinkSync(tempScriptPath);
      return false;
    } catch (error) {
      // é€€å‡ºç 1 = çª—å£å­˜åœ¨
      fs.unlinkSync(tempScriptPath);
      return true;
    }
  } catch (error) {
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] æ£€æŸ¥çª—å£å¤±è´¥: ${error.message}`);
    return false;
  }
}

// å…³é—­æ¸¸æˆçª—å£ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
async function å…³é—­æ¸¸æˆçª—å£(è´¦å·åç§°, é‡è¯•æ¬¡æ•° = 0) {
  try {
    const é…ç½® = è¯»å–é…ç½®();
    const çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] å…³é—­æ¸¸æˆçª—å£...`);
    
    // é€šè¿‡è¿›ç¨‹IDå…³é—­
    if (çŠ¶æ€[è´¦å·åç§°]?.è¿›ç¨‹ID) {
      try {
        await execAsync(`taskkill /PID ${çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID} /F`);
      } catch (error) {
        å†™æ—¥å¿—(`[${è´¦å·åç§°}] é€šè¿‡PIDå…³é—­å¤±è´¥ï¼Œå°è¯•æŒ‰åç§°å…³é—­`);
      }
    }
    
    // éªŒè¯æ˜¯å¦å…³é—­æˆåŠŸ
    await new Promise(resolve => setTimeout(resolve, 1000));
    const çª—å£ä»å­˜åœ¨ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
    
    if (çª—å£ä»å­˜åœ¨) {
      if (é‡è¯•æ¬¡æ•° < 3) {
        å†™æ—¥å¿—(`[${è´¦å·åç§°}] å…³é—­å¤±è´¥ï¼Œé‡è¯• ${é‡è¯•æ¬¡æ•° + 1}/3`);
        return await å…³é—­æ¸¸æˆçª—å£(è´¦å·åç§°, é‡è¯•æ¬¡æ•° + 1);
      } else {
        å†™æ—¥å¿—(`[${è´¦å·åç§°}] âš ï¸ 3æ¬¡å…³é—­å¤±è´¥ï¼Œå¼ºåˆ¶æ€æ­»æ‰€æœ‰è¿›ç¨‹`);
        await execAsync('taskkill /f /im "é²¨é±¼ä¹‹ç‹å®¢æˆ·ç«¯.exe"');
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
    
    // æ›´æ–°çŠ¶æ€
    çŠ¶æ€[è´¦å·åç§°].çª—å£å·²æ‰“å¼€ = false;
    çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID = null;
    ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] çª—å£å·²å…³é—­`);
    return true;
  } catch (error) {
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] å…³é—­çª—å£å¤±è´¥: ${error.message}`);
    return false;
  }
}

// å¯åŠ¨æ¸¸æˆå¹¶ç™»å½•
async function å¯åŠ¨æ¸¸æˆ(è´¦å·åç§°, çª—å£åºå· = 0) {
  try {
    const é…ç½® = è¯»å–é…ç½®();
    
    // âœ… å…ˆæ£€æŸ¥çª—å£çŠ¶æ€ï¼Œé¿å…é‡å¤ç™»å½•
    const å½“å‰çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
    if (å½“å‰çŠ¶æ€[è´¦å·åç§°]?.çª—å£å·²æ‰“å¼€) {
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] çª—å£å·²æ‰“å¼€ï¼Œè·³è¿‡ç™»å½•`);
      return false;
    }
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] å¼€å§‹å¯åŠ¨æ¸¸æˆ...`);
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] æ¸¸æˆEXE: ${é…ç½®.æ¸¸æˆEXEè·¯å¾„}`);
    
    const çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
    
    // BINæ–‡ä»¶è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰
    const BINæ–‡ä»¶è·¯å¾„ = path.join(é¡¹ç›®æ ¹ç›®å½•, `BINæ–‡ä»¶/${è´¦å·åç§°}.bin`);
    
    if (!fs.existsSync(BINæ–‡ä»¶è·¯å¾„)) {
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] BINæ–‡ä»¶ä¸å­˜åœ¨: ${BINæ–‡ä»¶è·¯å¾„}`);
      return;
    }
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] BINè·¯å¾„: ${BINæ–‡ä»¶è·¯å¾„}`);
    
    // ç”ŸæˆAHKè„šæœ¬ï¼ˆå¡«å……è·¯å¾„+åŒé‡ç¡®è®¤æ‰“å¼€ï¼‰
    const ahkScript = `
Run, "${é…ç½®.æ¸¸æˆEXEè·¯å¾„}"
Sleep, 2000
WinWait, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶, , 10
WinActivate, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
Sleep, 500
ControlSetText, Edit1, ${BINæ–‡ä»¶è·¯å¾„}
Sleep, 300
Send, !o
Sleep, 200
Send, {Enter}
`;
    
    const tempScriptPath = path.join(__dirname, `temp-${è´¦å·åç§°}.ahk`);
    fs.writeFileSync(tempScriptPath, '\ufeff' + ahkScript, 'utf-8'); // UTF-8 BOM
    
    // æ‰§è¡ŒAHKè„šæœ¬
    const result = await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${tempScriptPath}"`);
    
    // å»¶è¿Ÿåè·å–è¿›ç¨‹ID
    await new Promise(resolve => setTimeout(resolve, 8000));  // âœ… æ”¹ä¸º8ç§’ï¼Œç­‰å¾…æ¸¸æˆå¯åŠ¨
    
    // è·å–æœ€æ–°å¯åŠ¨çš„è¿›ç¨‹IDï¼ˆé€šè¿‡åˆ›å»ºæ—¶é—´æ’åºï¼‰
    let pid = null;
    try {
      const processListResult = await execAsync('wmic process where name="é²¨é±¼ä¹‹ç‹å®¢æˆ·ç«¯.exe" get ProcessId,CreationDate /format:csv');
      const lines = processListResult.stdout.trim().split('\n').filter(l => l.includes(',') && !l.startsWith('Node'));
      
      if (lines.length > 0) {
        // è·å–æœ€åä¸€ä¸ªï¼ˆæœ€æ–°å¯åŠ¨çš„ï¼‰
        const lastLine = lines[lines.length - 1];
        const pidMatch = lastLine.match(/,(\d+),/);
        pid = pidMatch ? parseInt(pidMatch[1]) : null;
      }
    } catch (error) {
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] è·å–è¿›ç¨‹IDå¤±è´¥: ${error.message}`);
    }
    
    // âœ… è¿›ç¨‹IDä¸æ˜¯å¿…éœ€çš„ï¼Œåªç”¨äºè¾…åŠ©å…³é—­
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] è¿›ç¨‹ID: ${pid || 'æœªè·å–ï¼ˆä½†ä¸å½±å“åŠŸèƒ½ï¼‰'}`);
    
    // âœ… éªŒè¯çª—å£æ˜¯å¦æˆåŠŸæ‰“å¼€ï¼ˆå…ˆéªŒè¯ï¼Œå†ç‚¹å‡»æŒ‰é’®ï¼‰
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] éªŒè¯çª—å£æ˜¯å¦æ‰“å¼€...`);
    await new Promise(resolve => setTimeout(resolve, 3000)); // ç­‰å¾…3ç§’
    
    const çª—å£æ‰“å¼€æˆåŠŸ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
    
    if (!çª—å£æ‰“å¼€æˆåŠŸ) {
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] âš ï¸ çª—å£æœªæˆåŠŸæ‰“å¼€ï¼Œå¯èƒ½å¡åœ¨é€‰æ‹©å¯¹è¯æ¡†`);
      
      // âœ… åªå…³é—­å½“å‰è´¦å·çš„çª—å£ï¼Œä¸è¦å½±å“å…¶ä»–è´¦å·
      const é…ç½® = è¯»å–é…ç½®();
      const BINæ–‡ä»¶å = `${è´¦å·åç§°}.bin`;
      
      const closeScript = `
SetTitleMatchMode, 2
IfWinExist, ${BINæ–‡ä»¶å}
{
    WinClose, ${BINæ–‡ä»¶å}
    Sleep, 500
    IfWinExist, ${BINæ–‡ä»¶å}
    {
        WinKill, ${BINæ–‡ä»¶å}
    }
}
IfWinExist, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
{
    WinClose, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    Sleep, 500
    IfWinExist, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    {
        WinKill, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    }
}
`;
      
      const closeScriptPath = path.join(__dirname, `close-${è´¦å·åç§°}.ahk`);
      try {
        fs.writeFileSync(closeScriptPath, '\ufeff' + closeScript, 'utf-8');
        await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${closeScriptPath}"`);
        fs.unlinkSync(closeScriptPath);
      } catch (error) {
        if (fs.existsSync(closeScriptPath)) {
          fs.unlinkSync(closeScriptPath);
        }
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      if (çŠ¶æ€[è´¦å·åç§°]) {
        çŠ¶æ€[è´¦å·åç§°].çª—å£å·²æ‰“å¼€ = false;
        çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID = null;
        ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
      }
      
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] å·²æ¸…ç†å¤±è´¥çš„å¯åŠ¨çª—å£`);
      return false;
    }
    
    // âœ… çª—å£æ‰“å¼€æˆåŠŸï¼Œç­‰å¾…30ç§’è®©æ¸¸æˆå®Œå…¨åŠ è½½
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] çª—å£å·²æ‰“å¼€ï¼Œç­‰å¾…30ç§’è®©æ¸¸æˆå®Œå…¨åŠ è½½...`);
    await new Promise(resolve => setTimeout(resolve, 30000)); // ç­‰å¾…30ç§’
    
    // âœ… ç‚¹å‡»2æ¬¡â€œå…³æ¸²æŸ“â€æŒ‰é’®ï¼ˆåæ ‡456, 48ï¼‰
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] ç‚¹å‡»å…³æ¸²æŸ“æŒ‰é’®...`);
    const clickRenderScript = `
; ç‚¹å‡»2æ¬¡å…³æ¸²æŸ“æŒ‰é’®
Click, 456, 48
Sleep, 1000
Click, 456, 48
`;
    
    const clickRenderPath = path.join(__dirname, `click-render-${è´¦å·åç§°}.ahk`);
    let å…³æ¸²æŸ“æˆåŠŸ = false;
    try {
      fs.writeFileSync(clickRenderPath, '\ufeff' + clickRenderScript, 'utf-8');
      await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${clickRenderPath}"`);
      fs.unlinkSync(clickRenderPath);
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] å·²ç‚¹å‡»å…³æ¸²æŸ“`);
      å…³æ¸²æŸ“æˆåŠŸ = true;
    } catch (error) {
      å†™æ—¥å¿—(`[${è´¦å·åç§°}] ç‚¹å‡»å…³æ¸²æŸ“å¤±è´¥: ${error.message}`);
      if (fs.existsSync(clickRenderPath)) {
        fs.unlinkSync(clickRenderPath);
      }
    }
    
    // âœ… æ›´æ–°å…³æ¸²æŸ“çŠ¶æ€åˆ°å‰ç«¯
    æ›´æ–°è´¦å·çŠ¶æ€(è´¦å·åç§°, {
      autoLogin: {
        å…³æ¸²æŸ“: å…³æ¸²æŸ“æˆåŠŸ,
        å…³æ¸²æŸ“æ—¶é—´: new Date().toISOString()
      }
    });
    
    // âœ… ç°åœ¨è°ƒæ•´çª—å£å¤§å°å’Œä½ç½®
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] è°ƒæ•´çª—å£å¤§å°å’Œä½ç½®...`);
    
    const çª—å£å®½åº¦ = 148;
    const çª—å£é«˜åº¦ = 288;
    const æ¯è¡Œçª—å£æ•° = Math.floor(1920 / çª—å£å®½åº¦);
    
    const è¡Œå· = Math.floor(çª—å£åºå· / æ¯è¡Œçª—å£æ•°);
    const åˆ—å· = çª—å£åºå· % æ¯è¡Œçª—å£æ•°;
    
    const x = åˆ—å· * çª—å£å®½åº¦;
    const y = è¡Œå· * çª—å£é«˜åº¦;
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] è°ƒæ•´çª—å£: ä½ç½®(${x}, ${y}), å¤§å°(${çª—å£å®½åº¦}x${çª—å£é«˜åº¦})`);
    
    const BINæ–‡ä»¶å = `${è´¦å·åç§°}.bin`;
    const resizeScript = `
SetTitleMatchMode, 2
WinWait, ${BINæ–‡ä»¶å}, , 10
IfWinExist, ${BINæ–‡ä»¶å}
{
    WinActivate, ${BINæ–‡ä»¶å}
    Sleep, 200
    WinMove, ${BINæ–‡ä»¶å}, , ${x}, ${y}, ${çª—å£å®½åº¦}, ${çª—å£é«˜åº¦}
}
`;
    const resizeScriptPath = path.join(__dirname, `resize-${è´¦å·åç§°}.ahk`);
    fs.writeFileSync(resizeScriptPath, '\ufeff' + resizeScript, 'utf-8');
    await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${resizeScriptPath}"`);
    fs.unlinkSync(resizeScriptPath);
    
    // æ›´æ–°çŠ¶æ€
    if (!çŠ¶æ€[è´¦å·åç§°]) çŠ¶æ€[è´¦å·åç§°] = {};
    çŠ¶æ€[è´¦å·åç§°].çª—å£å·²æ‰“å¼€ = true;
    çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID = pid;
    çŠ¶æ€[è´¦å·åç§°].æœ€åæ“ä½œæ—¶é—´ = new Date().toISOString();
    ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
    
    // æ¸…ç†ä¸´æ—¶è„šæœ¬
    fs.unlinkSync(tempScriptPath);
    
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] æ¸¸æˆå·²å¯åŠ¨ï¼Œè¿›ç¨‹ID: ${pid || 'æœªè·å–'}`);
    
    // è¿”å›trueè¡¨ç¤ºæˆåŠŸç™»å½•
    return true;
  } catch (error) {
    å†™æ—¥å¿—(`[${è´¦å·åç§°}] å¯åŠ¨æ¸¸æˆå¤±è´¥: ${error.message}`);
    return false;
  }
}

// ä¸»å¾ªç¯
async function ä¸»å¾ªç¯() {
  å†™æ—¥å¿—('');
  å†™æ—¥å¿—('========================================');
  å†™æ—¥å¿—('  æ¸¸æˆè‡ªåŠ¨ç™»å½•æŒ‚æœºæ’ä»¶å·²å¯åŠ¨');
  å†™æ—¥å¿—('========================================');
  å†™æ—¥å¿—('');
  
  const é…ç½® = è¯»å–é…ç½®();
  
  if (!é…ç½®.å¯ç”¨è‡ªåŠ¨ç™»å½•) {
    å†™æ—¥å¿—('è‡ªåŠ¨ç™»å½•å·²ç¦ç”¨');
    return;
  }
  
  å†™æ—¥å¿—(`æ£€æµ‹é—´éš”: ${é…ç½®.æ£€æµ‹é—´éš”ç§’}ç§’`);
  å†™æ—¥å¿—(`æ¸¸æˆè·¯å¾„: ${é…ç½®.æ¸¸æˆEXEè·¯å¾„}`);
  å†™æ—¥å¿—('ğŸ”§ å‘¨äº”å‡Œæ™¨4:40-7:30ç»´æŠ¤æ—¶æ®µ');
  å†™æ—¥å¿—('');
  
  // å¯åŠ¨æ—¶å…³é—­æ‰€æœ‰æ¸¸æˆè¿›ç¨‹
  å†™æ—¥å¿—('[å¯åŠ¨] å…³é—­æ‰€æœ‰æ¸¸æˆè¿›ç¨‹ï¼Œé˜²æ­¢æ„å¤–...');
  try {
    await execAsync('taskkill /f /im "é²¨é±¼ä¹‹ç‹å®¢æˆ·ç«¯.exe" 2>nul');
    å†™æ—¥å¿—('[å¯åŠ¨] æ¸¸æˆè¿›ç¨‹å·²å…¨éƒ¨å…³é—­');
  } catch (error) {
    å†™æ—¥å¿—('[å¯åŠ¨] æ— æ¸¸æˆè¿›ç¨‹è¿è¡Œ');
  }
  å†™æ—¥å¿—('');
  
  // è®°å½•æ¯ä¸ªè´¦å·çš„æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³
  const è´¦å·æœ€è¿‘ä»»åŠ¡æ—¶é—´ = {};
  
// è®°å½•å·²ç™»å½•è´¦å·æ•°é‡ï¼ˆç”¨äºçª—å£æ’åˆ—ï¼‰- å…¨å±€å˜é‡
let å…¨å±€å·²ç™»å½•è´¦å·æ•° = 0;

// âœ… å…¨å±€ç™»å½•é”ï¼šé˜²æ­¢å¹¶å‘ç™»å½•
let æ­£åœ¨ç™»å½• = false;

// âœ… å¾…ç™»å½•é˜Ÿåˆ—
const å¾…ç™»å½•é˜Ÿåˆ— = [];

// âœ… å¤„ç†ç™»å½•é˜Ÿåˆ—
async function å¤„ç†ç™»å½•é˜Ÿåˆ—() {
  // å¦‚æœæ­£åœ¨ç™»å½•ï¼Œè·³è¿‡
  if (æ­£åœ¨ç™»å½•) {
    return;
  }
  
  // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè·³è¿‡
  if (å¾…ç™»å½•é˜Ÿåˆ—.length === 0) {
    return;
  }
  
  // è®¾ç½®é”
  æ­£åœ¨ç™»å½• = true;
  
  // è·å–é˜Ÿåˆ—ç¬¬ä¸€ä¸ªè´¦å·
  const è´¦å·åç§° = å¾…ç™»å½•é˜Ÿåˆ—.shift();
  
  try {
    å†™æ—¥å¿—(``);
    å†™æ—¥å¿—(`âœ… [é˜Ÿåˆ—] å¼€å§‹ç™»å½•: [${è´¦å·åç§°}]ï¼Œå‰©ä½™é˜Ÿåˆ—: ${å¾…ç™»å½•é˜Ÿåˆ—.length}`);
    
    // è·å–å½“å‰çª—å£æ•°ä½œä¸ºåºå·
    const å½“å‰çª—å£æ•° = await è·å–å½“å‰çª—å£æ•°();
    const ç™»å½•æˆåŠŸ = await å¯åŠ¨æ¸¸æˆ(è´¦å·åç§°, å½“å‰çª—å£æ•°);
    
    if (ç™»å½•æˆåŠŸ) {
      å†™æ—¥å¿—(`âœ… [${è´¦å·åç§°}] ç™»å½•å®Œæˆï¼Œç­‰å¾…1åˆ†é’Ÿåå¤„ç†ä¸‹ä¸ªè´¦å·...`);
      await new Promise(resolve => setTimeout(resolve, 60000)); // ç­‰å¾…1åˆ†é’Ÿ
      å†™æ—¥å¿—(`âœ… [${è´¦å·åç§°}] ç­‰å¾…å®Œæˆ`);
    } else {
      å†™æ—¥å¿—(`âŒ [${è´¦å·åç§°}] ç™»å½•å¤±è´¥`);
    }
  } catch (error) {
    å†™æ—¥å¿—(`âŒ [${è´¦å·åç§°}] ç™»å½•å¼‚å¸¸: ${error.message}`);
  } finally {
    // é‡Šæ”¾é”
    æ­£åœ¨ç™»å½• = false;
    å†™æ—¥å¿—(`âœ… [é˜Ÿåˆ—] [${è´¦å·åç§°}] å¤„ç†å®Œæˆï¼Œé‡Šæ”¾é”`);
    å†™æ—¥å¿—(``);
  }
}

// è·å–å½“å‰å®é™…æ‰“å¼€çš„çª—å£æ•°ï¼ˆæ”¹ä¸ºç»Ÿè®¡çª—å£è€Œéè¿›ç¨‹ï¼‰
async function è·å–å½“å‰çª—å£æ•°() {
  try {
    const é…ç½® = è¯»å–é…ç½®();
    
    // âœ… ä½¿ç”¨AHKç»Ÿè®¡çª—å£æ•°é‡ï¼ˆè€Œéè¿›ç¨‹æ•°é‡ï¼‰
    const ahkScript = `
SetTitleMatchMode, 2
winCount := 0

; æŸ¥æ‰¾æ‰€æœ‰åŒ…å«".bin"çš„çª—å£ï¼ˆæ¸¸æˆçª—å£æ ‡é¢˜æ ¼å¼ï¼‰
WinGet, windows, List
Loop, %windows%
{
    WinGetTitle, title, % "ahk_id " windows%A_Index%
    ; å¦‚æœçª—å£æ ‡é¢˜åŒ…å«".bin"ï¼Œè®¤ä¸ºæ˜¯æ¸¸æˆçª—å£
    if (InStr(title, ".bin"))
    {
        winCount++
    }
}

FileAppend, %winCount%, *
ExitApp
`;
    
    const tempScriptPath = path.join(__dirname, 'count-windows.ahk');
    fs.writeFileSync(tempScriptPath, '\ufeff' + ahkScript, 'utf-8');
    
    try {
      const result = await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${tempScriptPath}"`);
      fs.unlinkSync(tempScriptPath);
      
      const count = parseInt(result.stdout.trim()) || 0;
      
      // âœ… è°ƒè¯•ï¼šè¾“å‡ºç»Ÿè®¡ç»“æœ
      if (count > 0) {
        å†™æ—¥å¿—(`  [è°ƒè¯•] æ£€æµ‹åˆ°çš„æ¸¸æˆçª—å£æ•°: ${count}`);
      }
      
      return count;
    } catch (error) {
      if (fs.existsSync(tempScriptPath)) {
        fs.unlinkSync(tempScriptPath);
      }
      return 0;
    }
  } catch {
    return 0;
  }
}
  
  setInterval(async () => {
    try {
      const ç°åœ¨ = new Date();
      const å½“å‰æ—¶é—´ = ç°åœ¨.toLocaleTimeString('zh-CN');
      const å½“å‰å°æ—¶ = ç°åœ¨.getHours();
      const å½“å‰åˆ†é’Ÿ = ç°åœ¨.getMinutes();
      const å½“å‰æ˜ŸæœŸ = ç°åœ¨.getDay(); // 0=å‘¨æ—¥, 5=å‘¨äº”
      
      å†™æ—¥å¿—(`[${å½“å‰æ—¶é—´}] å¼€å§‹æ£€æµ‹...`);
      
      // å‘¨äº”å‡Œæ™¨4:40-7:30ç»´æŠ¤æ—¶æ®µï¼ˆå®¹é”™æ—¶é—´ï¼‰
      if (å½“å‰æ˜ŸæœŸ === 5) {
        const å½“å‰æ—¶é—´åˆ†é’Ÿæ•° = å½“å‰å°æ—¶ * 60 + å½“å‰åˆ†é’Ÿ;
        const ç»´æŠ¤å¼€å§‹åˆ†é’Ÿæ•° = 4 * 60 + 40; // 4:40 = 280åˆ†é’Ÿ
        const ç»´æŠ¤ç»“æŸåˆ†é’Ÿæ•° = 7 * 60 + 30; // 7:30 = 450åˆ†é’Ÿ
        
        if (å½“å‰æ—¶é—´åˆ†é’Ÿæ•° >= ç»´æŠ¤å¼€å§‹åˆ†é’Ÿæ•° && å½“å‰æ—¶é—´åˆ†é’Ÿæ•° < ç»´æŠ¤ç»“æŸåˆ†é’Ÿæ•°) {
          å†™æ—¥å¿—('  ğŸ”§ å‘¨äº”å‡Œæ™¨4:40-7:30ç»´æŠ¤æ—¶æ®µï¼Œè·³è¿‡');
          å†™æ—¥å¿—('');
          
          // å¦‚æœæœ‰çª—å£æ‰“å¼€ï¼Œå…³é—­å®ƒä»¬
          const ç»´æŠ¤çª—å£æ•° = await è·å–å½“å‰çª—å£æ•°();
          if (ç»´æŠ¤çª—å£æ•° > 0) {
            å†™æ—¥å¿—('  å…³é—­æ‰€æœ‰æ¸¸æˆçª—å£ï¼ˆç»´æŠ¤æ—¶æ®µï¼‰...');
            await execAsync('taskkill /f /im "é²¨é±¼ä¹‹ç‹å®¢æˆ·ç«¯.exe"');
            await new Promise(resolve => setTimeout(resolve, 2000));
            ä¿å­˜çª—å£çŠ¶æ€({});
            å†™æ—¥å¿—('  å·²å…³é—­æ‰€æœ‰çª—å£');
          }
          å†™æ—¥å¿—('');
          return;
        }
      }
      
      // âœ… æ¯æ¬¡å¾ªç¯éƒ½è¯»å–æœ€æ–°çš„æŒ‚æœºé…ç½®
      const æŒ‚æœºè´¦å· = è¯»å–æŒ‚æœºè´¦å·åˆ—è¡¨();
      
      // âœ… å…ˆå…³é—­AHKé”™è¯¯çª—å£
      await å…³é—­AHKé”™è¯¯çª—å£();
      
      // âœ… å†æ¸…ç†å¡ä½çš„å¯¹è¯æ¡†ï¼Œç„¶åç»Ÿè®¡çª—å£æ•°
      await æ¸…ç†BINé€‰æ‹©å¯¹è¯æ¡†();
      await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…500msè®©è¿›ç¨‹å®Œå…¨é€€å‡º
      
      // å¼€å§‹æ£€æµ‹å‰ï¼Œæ£€æŸ¥çª—å£æ€»æ•°
      const å½“å‰çª—å£æ€»æ•° = await è·å–å½“å‰çª—å£æ•°();
      const å¯ç”¨è´¦å·æ•° = Object.values(æŒ‚æœºè´¦å·).filter(v => v).length;
      
      å†™æ—¥å¿—(`  å¯ç”¨æŒ‚æœºè´¦å·æ•°: ${å¯ç”¨è´¦å·æ•°}`);
      å†™æ—¥å¿—(`  å½“å‰çª—å£æ€»æ•°: ${å½“å‰çª—å£æ€»æ•°}`);
      
      // æ£€æµ‹é€»è¾‘ï¼šçª—å£æ•° > å¯ç”¨è´¦å·æ•°
      if (å½“å‰çª—å£æ€»æ•° > å¯ç”¨è´¦å·æ•° && å¯ç”¨è´¦å·æ•° > 0) {
        å†™æ—¥å¿—(`  âš ï¸ çª—å£æ•°è¶…å‡ºé¢„æœŸï¼ˆ${å½“å‰çª—å£æ€»æ•°} > ${å¯ç”¨è´¦å·æ•°}ï¼‰ï¼Œå¼ºåˆ¶æ¸…ç†æ‰€æœ‰çª—å£`);
        await execAsync('taskkill /f /im "é²¨é±¼ä¹‹ç‹å®¢æˆ·ç«¯.exe"');
        await new Promise(resolve => setTimeout(resolve, 3000));
        // æ¸…ç©ºæ‰€æœ‰çŠ¶æ€
        ä¿å­˜çª—å£çŠ¶æ€({});
        å†™æ—¥å¿—('  å·²æ¸…ç†æ‰€æœ‰è¿›ç¨‹');
      }
      
      if (å¯ç”¨è´¦å·æ•° === 0) {
        å†™æ—¥å¿—('  æ— å¯ç”¨æŒ‚æœºçš„è´¦å·ï¼Œè·³è¿‡');
        å†™æ—¥å¿—('');
        return;
      }
      
      // éå†æ‰€æœ‰è´¦å·ï¼ˆæ— è®ºå¼€å…³çŠ¶æ€ï¼‰
      for (const [è´¦å·åç§°, æ˜¯å¦å¯ç”¨] of Object.entries(æŒ‚æœºè´¦å·)) {
        const æ£€æŸ¥å¼€å§‹ = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
        å†™æ—¥å¿—(`  [${è´¦å·åç§°}] [${æ£€æŸ¥å¼€å§‹}] å¼€å§‹æ£€æŸ¥...`);
        
        // æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨
        const çª—å£å­˜åœ¨ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
        
        // å¦‚æœæœªå¯ç”¨æŒ‚æœºï¼Œä½†çª—å£å­˜åœ¨ï¼Œå…³é—­çª—å£
        if (!æ˜¯å¦å¯ç”¨) {
          if (çª—å£å­˜åœ¨) {
            å†™æ—¥å¿—(`    æœªå¯ç”¨æŒ‚æœºä½†çª—å£å­˜åœ¨ï¼Œå…³é—­çª—å£`);
            await å…³é—­æ¸¸æˆçª—å£(è´¦å·åç§°);
          } else {
            å†™æ—¥å¿—(`    æœªå¯ç”¨æŒ‚æœºï¼Œè·³è¿‡`);
          }
          continue;
        }
        
        // ä»¥ä¸‹æ˜¯å¯ç”¨æŒ‚æœºçš„é€»è¾‘
        
        // è·å–æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³
        const æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ = è·å–è´¦å·æœ€è¿‘æ‰§è¡Œæ—¶é—´æˆ³(è´¦å·åç§°);
        
        if (æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ === 0) {
          å†™æ—¥å¿—(`    âš ï¸  æ— ä»»åŠ¡è®°å½•ï¼Œè·³è¿‡`);
          continue;
        }
        
        const ç°åœ¨ = Date.now();
        const ä»»åŠ¡è·ç¦»æ¯«ç§’ = ç°åœ¨ - æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³;
        const ä»»åŠ¡è·ç¦»åˆ†é’Ÿ = ä»»åŠ¡è·ç¦»æ¯«ç§’ / 60000;
        
        å†™æ—¥å¿—(`    æœ€è¿‘ä»»åŠ¡: ${Math.floor(ä»»åŠ¡è·ç¦»åˆ†é’Ÿ)}åˆ†é’Ÿå‰`);
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ç­‰å¾…ç™»å½•
        const çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
        if (çŠ¶æ€[è´¦å·åç§°]?.ç­‰å¾…ç™»å½•æ—¶é—´) {
          const ç­‰å¾…ç»“æŸæ—¶é—´ = çŠ¶æ€[è´¦å·åç§°].ç­‰å¾…ç™»å½•æ—¶é—´;
          const å‰©ä½™ç­‰å¾…æ¯«ç§’ = ç­‰å¾…ç»“æŸæ—¶é—´ - ç°åœ¨;
          
          if (å‰©ä½™ç­‰å¾…æ¯«ç§’ > 0) {
            const å‰©ä½™åˆ†é’Ÿ = Math.ceil(å‰©ä½™ç­‰å¾…æ¯«ç§’ / 60000);
            å†™æ—¥å¿—(`    â³ ç­‰å¾…ç™»å½•ä¸­ï¼Œå‰©ä½™ ${å‰©ä½™åˆ†é’Ÿ} åˆ†é’Ÿ`);
            
            // âœ… ç­‰å¾…æœŸé—´ä¹Ÿæ˜¯ç¦»çº¿çŠ¶æ€
            æ›´æ–°è´¦å·çŠ¶æ€(è´¦å·åç§°, {
              autoLogin: {
                åœ¨çº¿çŠ¶æ€: 'ç¦»çº¿',
                ç¦»çº¿åŸå› : `ç­‰å¾…ç™»å½•ï¼ˆå‰©ä½™${å‰©ä½™åˆ†é’Ÿ}åˆ†é’Ÿï¼‰`,
                æ›´æ–°æ—¶é—´: new Date().toISOString()
              }
            });
            
            continue;
          } else {
            // ç­‰å¾…æ—¶é—´å·²åˆ°ï¼Œæ¸…é™¤æ ‡è®°
            delete çŠ¶æ€[è´¦å·åç§°].ç­‰å¾…ç™»å½•æ—¶é—´;
            ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
            å†™æ—¥å¿—(`    âœ… ç­‰å¾…æ—¶é—´å·²åˆ°`);
            
            // æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å…ˆå…³é—­
            const çª—å£ä»å­˜åœ¨ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
            if (çª—å£ä»å­˜åœ¨) {
              å†™æ—¥å¿—(`    çª—å£ä»å­˜åœ¨ï¼Œå…ˆå…³é—­`);
              await å…³é—­æ¸¸æˆçª—å£(è´¦å·åç§°);
              await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
            }
          }
        }
        
        // æ£€æµ‹æ˜¯å¦åœ¨5åˆ†é’Ÿå†…æœ‰ä»»åŠ¡ï¼ˆå¯èƒ½è¢«é¡¶å·ï¼‰
        if (ä»»åŠ¡è·ç¦»åˆ†é’Ÿ < 5) {
          å†™æ—¥å¿—(`    ğŸ”´ 5åˆ†é’Ÿå†…æœ‰ä»»åŠ¡ï¼Œå¯èƒ½è¢«é¡¶å·`);
          
          // å¦‚æœçª—å£å­˜åœ¨ï¼Œå…³é—­å®ƒ
          if (çª—å£å­˜åœ¨) {
            å†™æ—¥å¿—(`    å…³é—­çª—å£`);
            await å…³é—­æ¸¸æˆçª—å£(è´¦å·åç§°);
          }
          
          // è®¾ç½®ç­‰å¾…ç™»å½•æ—¶é—´ = ä»»åŠ¡æ—¶é—´ + 5åˆ†é’Ÿ
          const ç­‰å¾…ç™»å½•æ—¶é—´ = æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ + 5 * 60 * 1000;
          const å‰©ä½™ç­‰å¾… = Math.ceil((ç­‰å¾…ç™»å½•æ—¶é—´ - ç°åœ¨) / 60000);
          
          if (!çŠ¶æ€[è´¦å·åç§°]) çŠ¶æ€[è´¦å·åç§°] = {};
          çŠ¶æ€[è´¦å·åç§°].ç­‰å¾…ç™»å½•æ—¶é—´ = ç­‰å¾…ç™»å½•æ—¶é—´;
          ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
          
          å†™æ—¥å¿—(`    â³ ç­‰å¾… ${å‰©ä½™ç­‰å¾…} åˆ†é’Ÿåå†ç™»å½•`);
          continue;
        }
        
        // æ­£å¸¸æ£€æµ‹ï¼šä»»åŠ¡è·ç¦»è¶…è¿‡5åˆ†é’Ÿ
        if (çª—å£å­˜åœ¨) {
          å†™æ—¥å¿—(`    çª—å£å·²å­˜åœ¨ï¼ŒæŒ‚æœºä¸­`);
          
          // âœ… æ›´æ–°åœ¨çº¿çŠ¶æ€
          æ›´æ–°è´¦å·çŠ¶æ€(è´¦å·åç§°, {
            autoLogin: {
              åœ¨çº¿çŠ¶æ€: 'åœ¨çº¿',
              æŒ‚æœºä¸­: true,
              æ›´æ–°æ—¶é—´: new Date().toISOString()
            }
          });
          
        } else {
          å†™æ—¥å¿—(`    çª—å£ä¸å­˜åœ¨ï¼Œå‡†å¤‡ç™»å½•`);
          
          // åŒæ­¥çŠ¶æ€ï¼šçª—å£å®é™…ä¸å­˜åœ¨ï¼Œæ¸…é™¤çŠ¶æ€æ ‡è®°
          const çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
          if (çŠ¶æ€[è´¦å·åç§°]?.çª—å£å·²æ‰“å¼€) {
            çŠ¶æ€[è´¦å·åç§°].çª—å£å·²æ‰“å¼€ = false;
            çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID = null;
            ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
            å†™æ—¥å¿—(`    åŒæ­¥çŠ¶æ€ï¼šæ¸…é™¤å·²æ‰“å¼€æ ‡è®°`);
          }
          
          // âœ… æ›´æ–°ç¦»çº¿çŠ¶æ€ï¼ˆåº”è¯¥æ‰“å¼€ä½†æ²¡æœ‰æ‰“å¼€ï¼‰
          æ›´æ–°è´¦å·çŠ¶æ€(è´¦å·åç§°, {
            autoLogin: {
              åœ¨çº¿çŠ¶æ€: 'ç¦»çº¿',
              ç¦»çº¿åŸå› : 'çª—å£æœªæ‰“å¼€',
              æŒ‚æœºä¸­: false,
              æ›´æ–°æ—¶é—´: new Date().toISOString()
            }
          });
          
          // âœ… åŠ å…¥ç™»å½•é˜Ÿåˆ—ï¼Œè€Œä¸æ˜¯ç›´æ¥ç™»å½•
          if (!å¾…ç™»å½•é˜Ÿåˆ—.includes(è´¦å·åç§°)) {
            å¾…ç™»å½•é˜Ÿåˆ—.push(è´¦å·åç§°);
            å†™æ—¥å¿—(`    âœ… å·²åŠ å…¥ç™»å½•é˜Ÿåˆ—ï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦: ${å¾…ç™»å½•é˜Ÿåˆ—.length}`);
          } else {
            å†™æ—¥å¿—(`    âš ï¸ å·²åœ¨é˜Ÿåˆ—ä¸­ï¼Œè·³è¿‡`);
          }
        }
      }
      
      // æ¸…ç†æ— æ•ˆçª—å£çŠ¶æ€
      await æ¸…ç†æ— æ•ˆçª—å£();
      
      // âœ… æ¸…ç†å¡ä½çš„é€‰æ‹©å¯¹è¯æ¡†
      await æ¸…ç†BINé€‰æ‹©å¯¹è¯æ¡†();
      
      å†™æ—¥å¿—(`[${å½“å‰æ—¶é—´}] æ£€æµ‹å®Œæˆ`);
      
      // âœ… å¤„ç†ç™»å½•é˜Ÿåˆ—ï¼ˆåœ¨æ£€æµ‹å®Œæˆåï¼‰
      await å¤„ç†ç™»å½•é˜Ÿåˆ—();
      
      // è¾“å‡ºçŠ¶æ€æ±‡æ€»
      å†™æ—¥å¿—('');
      å†™æ—¥å¿—('========== è´¦å·çŠ¶æ€æ±‡æ€» ==========');
      
      // âœ… ä½¿ç”¨å·²è¯»å–çš„æŒ‚æœºè´¦å·å˜é‡ï¼Œä¸å†é‡å¤è¯»å–
      const çª—å£çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
      const è°ƒåº¦è®°å½• = è¯»å–è°ƒåº¦è®°å½•();
      
      for (const [è´¦å·åç§°, æ˜¯å¦å¯ç”¨] of Object.entries(æŒ‚æœºè´¦å·)) {
        å†™æ—¥å¿—(`  [${è´¦å·åç§°}]`);
        å†™æ—¥å¿—(`    æŒ‚æœºå¼€å…³: ${æ˜¯å¦å¯ç”¨ ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²å…³é—­'}`);
        
        if (æ˜¯å¦å¯ç”¨) {
          // æ£€æŸ¥çª—å£çŠ¶æ€
          const çª—å£å­˜åœ¨ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
          å†™æ—¥å¿—(`    çª—å£çŠ¶æ€: ${çª—å£å­˜åœ¨ ? 'âœ… å·²æ‰“å¼€' : 'âŒ æœªæ‰“å¼€'}`);
          
          // è¿›ç¨‹ID
          if (çª—å£çŠ¶æ€[è´¦å·åç§°]?.è¿›ç¨‹ID) {
            å†™æ—¥å¿—(`    è¿›ç¨‹ID: ${çª—å£çŠ¶æ€[è´¦å·åç§°].è¿›ç¨‹ID}`);
          }
          
          // ç­‰å¾…ç™»å½•æ—¶é—´
          if (çª—å£çŠ¶æ€[è´¦å·åç§°]?.ç­‰å¾…ç™»å½•æ—¶é—´) {
            const å‰©ä½™æ¯«ç§’ = çª—å£çŠ¶æ€[è´¦å·åç§°].ç­‰å¾…ç™»å½•æ—¶é—´ - Date.now();
            if (å‰©ä½™æ¯«ç§’ > 0) {
              const å‰©ä½™åˆ†é’Ÿ = Math.ceil(å‰©ä½™æ¯«ç§’ / 60000);
              å†™æ—¥å¿—(`    ç­‰å¾…çŠ¶æ€: â³ ç­‰å¾…ç™»å½• (${å‰©ä½™åˆ†é’Ÿ}åˆ†é’Ÿ)`);
            }
          }
          
          // æœ€è¿‘ä»»åŠ¡æ—¶é—´
          let æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ = 0;
          let æœ€è¿‘ä»»åŠ¡åç§° = '';
          
          for (const [ä»»åŠ¡åç§°, ä»»åŠ¡æ•°æ®] of Object.entries(è°ƒåº¦è®°å½•)) {
            const è´¦å·è®°å½• = ä»»åŠ¡æ•°æ®?.accounts?.[è´¦å·åç§°];
            if (è´¦å·è®°å½•?.lastExecutionTime) {
              const æ‰§è¡Œæ—¶é—´ = new Date(è´¦å·è®°å½•.lastExecutionTime).getTime();
              if (æ‰§è¡Œæ—¶é—´ > æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³) {
                æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ = æ‰§è¡Œæ—¶é—´;
                æœ€è¿‘ä»»åŠ¡åç§° = ä»»åŠ¡åç§°;
              }
            }
          }
          
          if (æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³ > 0) {
            const è·ç¦»åˆ†é’Ÿ = Math.floor((Date.now() - æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³) / 60000);
            const æœ€è¿‘ä»»åŠ¡æ—¶é—´ = new Date(æœ€è¿‘ä»»åŠ¡æ—¶é—´æˆ³).toLocaleString('zh-CN');
            å†™æ—¥å¿—(`    æœ€è¿‘ä»»åŠ¡: ${æœ€è¿‘ä»»åŠ¡åç§°} (${è·ç¦»åˆ†é’Ÿ}åˆ†é’Ÿå‰)`);
            å†™æ—¥å¿—(`    æ‰§è¡Œæ—¶é—´: ${æœ€è¿‘ä»»åŠ¡æ—¶é—´}`);
          } else {
            å†™æ—¥å¿—(`    æœ€è¿‘ä»»åŠ¡: æ— è®°å½•`);
          }
        }
        
        å†™æ—¥å¿—('');
      }
      
      å†™æ—¥å¿—('==================================');
      å†™æ—¥å¿—('');
      
    } catch (error) {
      å†™æ—¥å¿—('ä¸»å¾ªç¯é”™è¯¯: ' + error.message);
    }
  }, é…ç½®.æ£€æµ‹é—´éš”ç§’ * 1000);
}

// æ¸…ç†æ— æ•ˆçª—å£çŠ¶æ€
async function æ¸…ç†æ— æ•ˆçª—å£() {
  const çŠ¶æ€ = è¯»å–çª—å£çŠ¶æ€();
  const æŒ‚æœºè´¦å· = è¯»å–æŒ‚æœºè´¦å·åˆ—è¡¨();
  let å·²æ¸…ç† = false;
  
  for (const [è´¦å·åç§°, æ•°æ®] of Object.entries(çŠ¶æ€)) {
    if (æ•°æ®.çª—å£å·²æ‰“å¼€) {
      // æ£€æŸ¥çª—å£æ˜¯å¦è¿˜å­˜åœ¨
      const çª—å£å­˜åœ¨ = await æ£€æŸ¥çª—å£æ˜¯å¦å­˜åœ¨(è´¦å·åç§°);
      if (!çª—å£å­˜åœ¨) {
        æ•°æ®.çª—å£å·²æ‰“å¼€ = false;
        æ•°æ®.è¿›ç¨‹ID = null;
        å·²æ¸…ç† = true;
      }
    }
  }
  
  if (å·²æ¸…ç†) {
    ä¿å­˜çª—å£çŠ¶æ€(çŠ¶æ€);
  }
}

// âœ… æ¸…ç†å¡ä½çš„BINé€‰æ‹©å¯¹è¯æ¡†
async function æ¸…ç†BINé€‰æ‹©å¯¹è¯æ¡†() {
  try {
    const é…ç½® = è¯»å–é…ç½®();
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨â€œè¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶â€çª—å£
    const ahkScript = `
SetTitleMatchMode, 2
IfWinExist, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
{
    ; çª—å£å­˜åœ¨ï¼Œå…³é—­å®ƒ
    WinClose, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    Sleep, 500
    ; å¦‚æœè¿˜åœ¨ï¼Œå¼ºåˆ¶å…³é—­
    IfWinExist, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    {
        WinKill, è¯·é€‰æ‹©éœ€è¦è¿è¡Œçš„BINæ–‡ä»¶
    }
    ExitApp, 1
}
ExitApp, 0
`;
    
    const tempScriptPath = path.join(__dirname, 'cleanup-dialog.ahk');
    fs.writeFileSync(tempScriptPath, '\ufeff' + ahkScript, 'utf-8');
    
    try {
      await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${tempScriptPath}"`);
      // é€€å‡ºç 0 = æ— å¯¹è¯æ¡†
      fs.unlinkSync(tempScriptPath);
    } catch (error) {
      // é€€å‡ºç 1 = å·²å…³é—­å¯¹è¯æ¡†
      fs.unlinkSync(tempScriptPath);
      å†™æ—¥å¿—('âœ… å·²æ¸…ç†å¡ä½çš„BINé€‰æ‹©å¯¹è¯æ¡†');
    }
  } catch (error) {
    // å¿½ç•¥é”™è¯¯
  }
}

// âœ… å…³é—­AHKé”™è¯¯å¼¹çª—
async function å…³é—­AHKé”™è¯¯çª—å£() {
  try {
    const é…ç½® = è¯»å–é…ç½®();
    
    // æ£€æŸ¥å¹¶å…³é—­AHKé”™è¯¯çª—å£
    const ahkScript = `
SetTitleMatchMode, 2
closed := 0

; å…³é—­å„ç§å¯èƒ½çš„é”™è¯¯çª—å£
; 1. AHKè„šæœ¬é”™è¯¯çª—å£ï¼ˆé€šè¿‡çª—å£ç±»åï¼‰
IfWinExist, ahk_class #32770
{
    WinGetTitle, title
    ; æ£€æŸ¥æ˜¯å¦åŒ…å«.ahkæˆ–Erroræˆ–Script
    if (InStr(title, ".ahk") || InStr(title, "Error") || InStr(title, "Script"))
    {
        WinClose
        Sleep, 200
        closed++
    }
}

; 2. æ£€æŸ¥æ‰€æœ‰çª—å£ï¼ŒåŒ¹é…å¤šç§é”™è¯¯ç‰¹å¾
WinGet, windows, List
Loop, %windows%
{
    WinGetTitle, title, % "ahk_id " windows%A_Index%
    
    ; åŒ¹é…è§„åˆ™ï¼š
    ; - åŒ…å«"Script file not found"
    ; - åŒ…å«"check-"ä¸”åŒ…å«".ahk"ï¼ˆä¸´æ—¶è„šæœ¬ï¼‰
    ; - åŒ…å«"resize-"ä¸”åŒ…å«".ahk"ï¼ˆä¸´æ—¶è„šæœ¬ï¼‰
    ; - åŒ…å«"temp-"ä¸”åŒ…å«".ahk"ï¼ˆä¸´æ—¶è„šæœ¬ï¼‰
    ; - åŒ…å«"cleanup-"ä¸”åŒ…å«".ahk"ï¼ˆä¸´æ—¶è„šæœ¬ï¼‰
    ; - åŒ…å«"count-"ä¸”åŒ…å«".ahk"ï¼ˆä¸´æ—¶è„šæœ¬ï¼‰
    if (InStr(title, "Script file not found") 
        || (InStr(title, "check-") && InStr(title, ".ahk")) 
        || (InStr(title, "resize-") && InStr(title, ".ahk"))
        || (InStr(title, "temp-") && InStr(title, ".ahk"))
        || (InStr(title, "cleanup-") && InStr(title, ".ahk"))
        || (InStr(title, "count-") && InStr(title, ".ahk")))
    {
        WinClose, % "ahk_id " windows%A_Index%
        Sleep, 200
        closed++
    }
}

; 3. âœ… å…³é—­æ‰€æœ‰AutoHotkeyè¿›ç¨‹çš„é”™è¯¯çª—å£ï¼ˆé€šè¿‡è¿›ç¨‹åï¼‰
WinGet, ahkWindows, List, ahk_exe AutoHotkey.exe
Loop, %ahkWindows%
{
    WinGetTitle, title, % "ahk_id " ahkWindows%A_Index%
    ; å¦‚æœçª—å£æ ‡é¢˜åŒ…å«.ahkï¼Œè®¤ä¸ºæ˜¯é”™è¯¯çª—å£
    if (InStr(title, ".ahk"))
    {
        WinClose, % "ahk_id " ahkWindows%A_Index%
        Sleep, 200
        closed++
    }
}

if (closed > 0)
    ExitApp, 1
else
    ExitApp, 0
`;
    
    const tempScriptPath = path.join(__dirname, 'cleanup-error.ahk');
    fs.writeFileSync(tempScriptPath, '\ufeff' + ahkScript, 'utf-8');
    
    try {
      await execAsync(`"${é…ç½®.AutoHotkeyè·¯å¾„}" "${tempScriptPath}"`);
      // é€€å‡ºç 0 = æ— é”™è¯¯çª—å£
      fs.unlinkSync(tempScriptPath);
    } catch (error) {
      // é€€å‡ºç 1 = å·²å…³é—­é”™è¯¯çª—å£
      fs.unlinkSync(tempScriptPath);
      å†™æ—¥å¿—('âœ… å·²å…³é—­AHKé”™è¯¯å¼¹çª—');
    }
  } catch (error) {
    // å¿½ç•¥é”™è¯¯
  }
}

// å¯åŠ¨
ä¸»å¾ªç¯().catch(error => {
  console.error('æ’ä»¶å¯åŠ¨å¤±è´¥:', error);
  process.exit(1);
});
