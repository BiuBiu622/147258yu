<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…·ç®±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #c9d1d9; min-height: 100vh; }
        
        /* ä¸»å®¹å™¨ */
        .main-container { max-width: 1400px; margin: 0 auto; padding: 16px 24px; }
        
        /* è¿æ¥é¢æ¿ */
        .connection-panel { background: #161b22; border: 1px solid #21262d; border-radius: 10px; padding: 14px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .connection-panel label { color: #8b949e; font-size: 13px; }
        .connection-panel select { background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 12px; border-radius: 6px; font-size: 13px; min-width: 180px; }
        .connection-panel select:focus { outline: none; border-color: #1d9bf0; }
        
        .status-badge { padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-badge.connected { background: rgba(35, 134, 54, 0.2); color: #3fb950; }
        .status-badge.disconnected { background: rgba(248, 81, 73, 0.2); color: #f85149; }
        .status-badge.connecting { background: rgba(210, 153, 34, 0.2); color: #d29922; }
        .status-badge.stopped { background: rgba(139, 148, 158, 0.2); color: #8b949e; }
        
        .btn { padding: 8px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; transition: all 0.15s; font-weight: 500; }
        .btn-primary { background: #1d9bf0; color: white; }
        .btn-primary:hover { background: #1a8cd8; }
        .btn-primary:disabled { background: #30363d; color: #8b949e; cursor: not-allowed; }
        .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
        .btn-secondary:hover { background: #30363d; }
        
        /* å·¥å…·å¡ç‰‡ç½‘æ ¼ */
        .tools-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 18px; }
        
        /* å·¥å…·å¡ç‰‡ */
        .tool-card { background: #161b22; border: 1px solid #21262d; border-radius: 10px; overflow: hidden; }
        .tool-card-header { padding: 12px 16px; border-bottom: 1px solid #21262d; display: flex; align-items: center; justify-content: space-between; background: #1c2128; }
        .tool-card-title { display: flex; align-items: center; gap: 8px; }
        .tool-card-title .icon { font-size: 22px; }
        .tool-card-title h3 { font-size: 14px; font-weight: 600; color: #e6edf3; }
        .tool-card-body { padding: 14px 16px; }
        .tool-card-footer { padding: 12px 16px; border-top: 1px solid #21262d; display: flex; gap: 10px; }
        .tool-card-footer .btn { flex: 1; }
        
        /* å®ç®±åŠ©æ‰‹ */
        .box-total { background: #0d1117; border-radius: 6px; padding: 10px; text-align: center; margin-bottom: 12px; }
        .box-total .label { color: #8b949e; font-size: 12px; }
        .box-total .value { color: #58a6ff; font-size: 18px; font-weight: 600; margin-left: 6px; }
        
        .box-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .box-item { background: #0d1117; border-radius: 6px; padding: 10px 6px; text-align: center; }
        .box-item .icon { font-size: 26px; margin-bottom: 4px; }
        .box-item .type { font-size: 11px; color: #8b949e; margin-bottom: 2px; }
        .box-item .count { font-size: 13px; font-weight: 600; color: #c9d1d9; }
        
        .controls-row { display: flex; gap: 8px; }
        .controls-row select { flex: 1; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 10px; border-radius: 6px; font-size: 12px; }
        
        /* é’“é±¼åŠ©æ‰‹ */
        .fish-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
        .fish-item { background: #0d1117; border-radius: 6px; padding: 12px; text-align: center; }
        .fish-item .icon { font-size: 30px; margin-bottom: 4px; }
        .fish-item .type { font-size: 11px; color: #8b949e; margin-bottom: 2px; }
        .fish-item .count { font-size: 14px; font-weight: 600; color: #c9d1d9; }
        
        /* æ‹›å‹ŸåŠ©æ‰‹ */
        .recruit-info { background: #0d1117; border-radius: 6px; padding: 14px; text-align: center; margin-bottom: 12px; }
        .recruit-info .icon { font-size: 30px; margin-bottom: 4px; }
        .recruit-info .label { font-size: 11px; color: #8b949e; }
        .recruit-info .value { font-size: 16px; font-weight: 600; color: #c9d1d9; }
        
        /* æ—¥å¿—åŒºåŸŸ */
        .log-panel { background: #0d1117; border: 1px solid #21262d; border-radius: 6px; margin-top: 10px; max-height: 80px; overflow-y: auto; font-size: 11px; }
        .log-item { padding: 5px 8px; border-bottom: 1px solid #21262d; font-family: monospace; }
        .log-item:last-child { border-bottom: none; }
        .log-item.success { color: #3fb950; }
        .log-item.error { color: #f85149; }
        .log-item.info { color: #8b949e; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- è¿æ¥é¢æ¿ -->
        <div class="connection-panel">
            <label>é€‰æ‹©è´¦å·ï¼š</label>
            <select id="accountSelect">
                <option value="">-- è¯·é€‰æ‹©è´¦å· --</option>
            </select>
            <span id="connectionStatus" class="status-badge disconnected">æœªè¿æ¥</span>
            <button id="connectBtn" class="btn btn-primary" onclick="connectAccount()">è¿æ¥</button>
            <button id="reconnectBtn" class="btn btn-secondary" onclick="reconnectAccount()" style="display:none;">é‡è¿</button>
            <button id="disconnectBtn" class="btn btn-secondary" onclick="disconnectAccount()" style="display:none;">æ–­å¼€</button>
        </div>
        
        <!-- å·¥å…·å¡ç‰‡ç½‘æ ¼ -->
        <div class="tools-grid">
            <!-- å®ç®±åŠ©æ‰‹ -->
            <div class="tool-card">
                <div class="tool-card-header">
                    <div class="tool-card-title">
                        <span class="icon">ğŸ“¦</span>
                        <h3>å®ç®±åŠ©æ‰‹</h3>
                    </div>
                    <span id="boxStatus" class="status-badge stopped">å·²åœæ­¢</span>
                </div>
                <div class="tool-card-body">
                    <div class="box-total">
                        <span class="label">å®ç®±æ€»ç§¯åˆ†ï¼š</span>
                        <span class="value" id="boxTotalPoints">0</span>
                    </div>
                    <div class="box-list">
                        <div class="box-item"><div class="icon">ğŸªµ</div><div class="type">æœ¨è´¨å®ç®±</div><div class="count" id="woodBox">0</div></div>
                        <div class="box-item"><div class="icon">ğŸ¥‰</div><div class="type">é’é“œå®ç®±</div><div class="count" id="bronzeBox">0</div></div>
                        <div class="box-item"><div class="icon">ğŸ¥‡</div><div class="type">é»„é‡‘å®ç®±</div><div class="count" id="goldBox">0</div></div>
                        <div class="box-item"><div class="icon">ğŸ’</div><div class="type">é“‚é‡‘å®ç®±</div><div class="count" id="platinumBox">0</div></div>
                    </div>
                    <div class="controls-row">
                        <select id="boxType">
                            <option value="2001">æœ¨è´¨å®ç®±</option>
                            <option value="2002">é’é“œå®ç®±</option>
                            <option value="2003">é»„é‡‘å®ç®±</option>
                            <option value="2004">é“‚é‡‘å®ç®±</option>
                        </select>
                        <select id="boxCount">
                            <option value="10">10</option>
                            <option value="100">100</option>
                            <option value="1000">1000</option>
                            <option value="2000">2000</option>
                            <option value="5000">5000</option>
                        </select>
                    </div>
                    <div class="log-panel" id="boxLog"></div>
                </div>
                <div class="tool-card-footer">
                    <button class="btn btn-primary" id="openBoxBtn" onclick="openBoxes()">å¼€å¯å®ç®±</button>
                    <button class="btn btn-secondary" onclick="claimBoxPoints()">é¢†å–å®ç®±ç§¯åˆ†</button>
                </div>
            </div>
            
            <!-- é’“é±¼åŠ©æ‰‹ -->
            <div class="tool-card">
                <div class="tool-card-header">
                    <div class="tool-card-title">
                        <span class="icon">ğŸ£</span>
                        <h3>é’“é±¼åŠ©æ‰‹</h3>
                    </div>
                    <span id="fishStatus" class="status-badge stopped">å·²åœæ­¢</span>
                </div>
                <div class="tool-card-body">
                    <div class="fish-list">
                        <div class="fish-item"><div class="icon">ğŸŸ</div><div class="type">æ™®é€šé±¼ç«¿</div><div class="count" id="normalRod">0</div></div>
                        <div class="fish-item"><div class="icon">ğŸ </div><div class="type">é»„é‡‘é±¼ç«¿</div><div class="count" id="goldRod">0</div></div>
                    </div>
                    <div class="controls-row">
                        <select id="fishType">
                            <option value="1">æ™®é€šé±¼ç«¿</option>
                            <option value="2">é»„é‡‘é±¼ç«¿</option>
                        </select>
                        <select id="fishCount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                        </select>
                    </div>
                    <div class="log-panel" id="fishLog"></div>
                </div>
                <div class="tool-card-footer">
                    <button class="btn btn-primary" id="startFishBtn" onclick="startFishing()">å¼€å§‹é’“é±¼</button>
                </div>
            </div>
            
            <!-- æ‹›å‹ŸåŠ©æ‰‹ -->
            <div class="tool-card">
                <div class="tool-card-header">
                    <div class="tool-card-title">
                        <span class="icon">ğŸ°</span>
                        <h3>æ‹›å‹ŸåŠ©æ‰‹</h3>
                    </div>
                    <span id="recruitStatus" class="status-badge stopped">å·²åœæ­¢</span>
                </div>
                <div class="tool-card-body">
                    <div class="recruit-info">
                        <div class="icon">ğŸ«</div>
                        <div class="label">æ‹›å‹Ÿä»¤</div>
                        <div class="value" id="recruitTicket">0</div>
                    </div>
                    <div class="controls-row">
                        <select id="recruitCount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="log-panel" id="recruitLog"></div>
                </div>
                <div class="tool-card-footer">
                    <button class="btn btn-primary" id="startRecruitBtn" onclick="startRecruit()">å¼€å§‹æ‹›å‹Ÿ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        const API_BASE = window.location.origin;
        let tokens = [];
        let ws = null;
        let roleInfo = null;
        let currentSeq = 1;
        
        // ==================== BONåè®®è§£ç  ====================
        const BON = {
            DataReader: class {
                constructor(bytes) {
                    this._data = bytes || new Uint8Array(0);
                    this.position = 0;
                }
                readUInt8() { return this._data[this.position++]; }
                readInt32() {
                    const v = this._data[this.position++] | (this._data[this.position++] << 8) | 
                              (this._data[this.position++] << 16) | (this._data[this.position++] << 24);
                    return v | 0;
                }
                readInt64() {
                    const lo = this.readInt32();
                    let _lo = lo < 0 ? lo + 0x100000000 : lo;
                    const hi = this.readInt32();
                    return _lo + 0x100000000 * hi;
                }
                readFloat32() {
                    const view = new DataView(this._data.buffer, this._data.byteOffset, this._data.byteLength);
                    const v = view.getFloat32(this.position, true);
                    this.position += 4;
                    return v;
                }
                readFloat64() {
                    const view = new DataView(this._data.buffer, this._data.byteOffset, this._data.byteLength);
                    const v = view.getFloat64(this.position, true);
                    this.position += 8;
                    return v;
                }
                read7BitInt() {
                    let value = 0, shift = 0, b = 0;
                    do {
                        b = this.readUInt8();
                        value |= (b & 0x7F) << shift;
                        shift += 7;
                    } while ((b & 0x80) !== 0);
                    return value >>> 0;
                }
                readUTF() {
                    const len = this.read7BitInt();
                    const str = new TextDecoder('utf8').decode(this._data.subarray(this.position, this.position + len));
                    this.position += len;
                    return str;
                }
                readUint8Array(length) {
                    const out = this._data.slice(this.position, this.position + length);
                    this.position += length;
                    return out;
                }
            },
            decode: function(bytes) {
                const dr = new BON.DataReader(bytes);
                const strArr = [];
                const _decode = function() {
                    const tag = dr.readUInt8();
                    switch (tag) {
                        case 0: return null;
                        case 1: return dr.readInt32();
                        case 2: return dr.readInt64();
                        case 3: return dr.readFloat32();
                        case 4: return dr.readFloat64();
                        case 5: { const s = dr.readUTF(); strArr.push(s); return s; }
                        case 6: return dr.readUInt8() === 1;
                        case 7: return dr.readUint8Array(dr.read7BitInt());
                        case 8: {
                            const count = dr.read7BitInt();
                            const obj = {};
                            for (let i = 0; i < count; i++) {
                                const k = _decode();
                                obj[k] = _decode();
                            }
                            return obj;
                        }
                        case 9: {
                            const len = dr.read7BitInt();
                            const arr = new Array(len);
                            for (let i = 0; i < len; i++) arr[i] = _decode();
                            return arr;
                        }
                        case 99: return strArr[dr.read7BitInt()];
                        default: return null;
                    }
                };
                return _decode();
            }
        };
        
        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            try {
                const res = await fetch(API_BASE + '/api/tokens');
                const data = await res.json();
                if (data.success) {
                    tokens = data.tokens;
                    const select = document.getElementById('accountSelect');
                    tokens.forEach(function(t) {
                        const opt = document.createElement('option');
                        opt.value = t.name;
                        opt.textContent = t.name;
                        select.appendChild(opt);
                    });
                    
                    // æ£€æŸ¥URLå‚æ•°
                    const urlParams = new URLSearchParams(window.location.search);
                    const accountName = urlParams.get('account');
                    if (accountName) {
                        select.value = accountName;
                        setTimeout(function() { connectAccount(); }, 300);
                    }
                }
            } catch (e) {
                console.error('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // ==================== WebSocketè¿æ¥ ====================
        function connectAccount() {
            const select = document.getElementById('accountSelect');
            const accountName = select.value;
            if (!accountName) {
                alert('è¯·å…ˆé€‰æ‹©è´¦å·');
                return;
            }
            
            const tokenData = tokens.find(function(t) { return t.name === accountName; });
            if (!tokenData) {
                alert('è´¦å·ä¸å­˜åœ¨');
                return;
            }
            
            updateStatus('connecting');
            
            const wsUrl = 'wss://game.nicemoe.cn?token=' + encodeURIComponent(tokenData.token);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocketå·²è¿æ¥');
                updateStatus('connected');
                setTimeout(function() {
                    sendCommand('role_getroleinfo', {});
                }, 500);
            };
            
            ws.onmessage = async function(event) {
                try {
                    const data = event.data;
                    let message;
                    
                    if (data instanceof Blob) {
                        const buffer = await data.arrayBuffer();
                        const bytes = new Uint8Array(buffer);
                        message = BON.decode(bytes);
                    } else {
                        message = JSON.parse(data);
                    }
                    
                    handleMessage(message);
                } catch (e) {
                    console.error('æ¶ˆæ¯è§£æå¤±è´¥:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocketå·²æ–­å¼€');
                updateStatus('disconnected');
            };
            
            ws.onerror = function(e) {
                console.error('WebSocketé”™è¯¯:', e);
                updateStatus('disconnected');
            };
        }
        
        function reconnectAccount() {
            if (ws) ws.close();
            connectAccount();
        }
        
        function disconnectAccount() {
            if (ws) {
                ws.close();
                ws = null;
            }
            roleInfo = null;
            updateStatus('disconnected');
            updateToolsData();
        }
        
        function updateStatus(status) {
            const badge = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const reconnectBtn = document.getElementById('reconnectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            badge.className = 'status-badge ' + status;
            
            if (status === 'connected') {
                badge.textContent = 'å·²è¿æ¥';
                connectBtn.style.display = 'none';
                reconnectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
            } else if (status === 'connecting') {
                badge.textContent = 'è¿æ¥ä¸­...';
                connectBtn.disabled = true;
            } else {
                badge.textContent = 'æœªè¿æ¥';
                connectBtn.style.display = 'inline-block';
                connectBtn.disabled = false;
                reconnectBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
            }
        }
        
        // ==================== æ¶ˆæ¯å¤„ç† ====================
        function handleMessage(message) {
            const cmd = message.cmd || '';
            
            let body = message.body;
            if (body instanceof Uint8Array) {
                body = BON.decode(body);
            } else if (body && typeof body === 'object' && !body.role) {
                const keys = Object.keys(body).map(function(k) { return parseInt(k); }).sort(function(a, b) { return a - b; });
                if (keys.length > 0 && keys[0] === 0) {
                    const arr = new Uint8Array(keys.length);
                    keys.forEach(function(k, i) { arr[i] = body[k]; });
                    body = BON.decode(arr);
                }
            }
            
            if (cmd.includes('getroleinfo') || cmd === 'role_getroleinforesp') {
                roleInfo = body;
                console.log('è§’è‰²ä¿¡æ¯:', roleInfo);
                updateToolsData();
            }
            
            if (cmd === 'item_openboxresp') {
                addLog('boxLog', 'å®ç®±å¼€å¯æˆåŠŸ', 'success');
            }
            
            if (cmd === 'item_batchclaimboxpointrewardresp') {
                addLog('boxLog', 'ç§¯åˆ†é¢†å–æˆåŠŸ', 'success');
                setTimeout(function() { sendCommand('role_getroleinfo', {}); }, 300);
            }
            
            if (cmd === 'artifact_lotteryresp') {
                addLog('fishLog', 'é’“é±¼æˆåŠŸ', 'success');
            }
            
            if (cmd === 'hero_recruitresp') {
                addLog('recruitLog', 'æ‹›å‹ŸæˆåŠŸ', 'success');
            }
        }
        
        function sendCommand(cmd, params) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocketæœªè¿æ¥');
                return null;
            }
            
            const seq = currentSeq++;
            const message = { cmd: cmd, body: params || {}, seq: seq };
            ws.send(JSON.stringify(message));
            console.log('å‘é€å‘½ä»¤:', cmd, params);
            return seq;
        }

        // ==================== æ›´æ–°å·¥å…·æ•°æ® ====================
        function updateToolsData() {
            if (!roleInfo || !roleInfo.role) {
                document.getElementById('boxTotalPoints').textContent = '0';
                document.getElementById('woodBox').textContent = '0';
                document.getElementById('bronzeBox').textContent = '0';
                document.getElementById('goldBox').textContent = '0';
                document.getElementById('platinumBox').textContent = '0';
                document.getElementById('normalRod').textContent = '0';
                document.getElementById('goldRod').textContent = '0';
                document.getElementById('recruitTicket').textContent = '0';
                return;
            }
            
            const items = roleInfo.role.items || {};
            
            // å®ç®±æ•°æ®
            const woodBox = (items[2001] && items[2001].quantity) || 0;
            const bronzeBox = (items[2002] && items[2002].quantity) || 0;
            const goldBox = (items[2003] && items[2003].quantity) || 0;
            const platinumBox = (items[2004] && items[2004].quantity) || 0;
            const totalPoints = woodBox * 1 + bronzeBox * 10 + goldBox * 20 + platinumBox * 50;
            
            document.getElementById('boxTotalPoints').textContent = totalPoints;
            document.getElementById('woodBox').textContent = woodBox;
            document.getElementById('bronzeBox').textContent = bronzeBox;
            document.getElementById('goldBox').textContent = goldBox;
            document.getElementById('platinumBox').textContent = platinumBox;
            
            // é’“é±¼æ•°æ® (é±¼ç«¿é“å…·IDéœ€è¦ç¡®è®¤)
            const normalRod = (items[3001] && items[3001].quantity) || 0;
            const goldRod = (items[3002] && items[3002].quantity) || 0;
            document.getElementById('normalRod').textContent = normalRod;
            document.getElementById('goldRod').textContent = goldRod;
            
            // æ‹›å‹Ÿä»¤
            const recruitTicket = (items[1008] && items[1008].quantity) || 0;
            document.getElementById('recruitTicket').textContent = recruitTicket;
        }
        
        // ==================== å®ç®±æ“ä½œ ====================
        var isOpeningBox = false;
        
        async function openBoxes() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥è´¦å·');
                return;
            }
            if (isOpeningBox) return;
            
            var boxType = parseInt(document.getElementById('boxType').value);
            var boxCount = parseInt(document.getElementById('boxCount').value);
            var btn = document.getElementById('openBoxBtn');
            
            isOpeningBox = true;
            btn.disabled = true;
            btn.textContent = 'å¼€å¯ä¸­...';
            document.getElementById('boxStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('boxStatus').className = 'status-badge running';
            
            addLog('boxLog', 'å¼€å§‹å¼€å¯ ' + boxCount + ' ä¸ªå®ç®±...', 'info');
            
            try {
                var batches = Math.floor(boxCount / 10);
                var remainder = boxCount % 10;
                
                for (var i = 0; i < batches; i++) {
                    sendCommand('item_openbox', { itemId: boxType, number: 10 });
                    await sleep(300);
                }
                
                if (remainder > 0) {
                    sendCommand('item_openbox', { itemId: boxType, number: remainder });
                }
                
                await sleep(500);
                sendCommand('item_batchclaimboxpointreward', {});
                await sleep(500);
                sendCommand('role_getroleinfo', {});
                
                addLog('boxLog', 'å®ç®±å¼€å¯å®Œæ¯•ï¼', 'success');
            } catch (e) {
                addLog('boxLog', 'å¼€å¯å¤±è´¥: ' + e.message, 'error');
            } finally {
                isOpeningBox = false;
                btn.disabled = false;
                btn.textContent = 'å¼€å¯å®ç®±';
                document.getElementById('boxStatus').textContent = 'å·²åœæ­¢';
                document.getElementById('boxStatus').className = 'status-badge stopped';
            }
        }
        
        function claimBoxPoints() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥è´¦å·');
                return;
            }
            addLog('boxLog', 'é¢†å–å®ç®±ç§¯åˆ†...', 'info');
            sendCommand('item_batchclaimboxpointreward', {});
        }
        
        // ==================== é’“é±¼æ“ä½œ ====================
        var isFishing = false;
        
        async function startFishing() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥è´¦å·');
                return;
            }
            if (isFishing) return;
            
            var fishType = parseInt(document.getElementById('fishType').value);
            var fishCount = parseInt(document.getElementById('fishCount').value);
            var btn = document.getElementById('startFishBtn');
            
            isFishing = true;
            btn.disabled = true;
            btn.textContent = 'é’“é±¼ä¸­...';
            document.getElementById('fishStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('fishStatus').className = 'status-badge running';
            
            addLog('fishLog', 'å¼€å§‹é’“é±¼ ' + fishCount + ' æ¬¡...', 'info');
            
            try {
                for (var i = 0; i < fishCount; i++) {
                    sendCommand('artifact_lottery', { lotteryNumber: 1, newFree: true, type: fishType });
                    await sleep(350);
                }
                
                await sleep(500);
                sendCommand('role_getroleinfo', {});
                
                addLog('fishLog', 'é’“é±¼å®Œæ¯•ï¼', 'success');
            } catch (e) {
                addLog('fishLog', 'é’“é±¼å¤±è´¥: ' + e.message, 'error');
            } finally {
                isFishing = false;
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹é’“é±¼';
                document.getElementById('fishStatus').textContent = 'å·²åœæ­¢';
                document.getElementById('fishStatus').className = 'status-badge stopped';
            }
        }
        
        // ==================== æ‹›å‹Ÿæ“ä½œ ====================
        var isRecruiting = false;
        
        async function startRecruit() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('è¯·å…ˆè¿æ¥è´¦å·');
                return;
            }
            if (isRecruiting) return;
            
            var recruitCount = parseInt(document.getElementById('recruitCount').value);
            var btn = document.getElementById('startRecruitBtn');
            
            isRecruiting = true;
            btn.disabled = true;
            btn.textContent = 'æ‹›å‹Ÿä¸­...';
            document.getElementById('recruitStatus').textContent = 'è¿è¡Œä¸­';
            document.getElementById('recruitStatus').className = 'status-badge running';
            
            addLog('recruitLog', 'å¼€å§‹æ‹›å‹Ÿ ' + recruitCount + ' æ¬¡...', 'info');
            
            try {
                for (var i = 0; i < recruitCount; i++) {
                    sendCommand('hero_recruit', { byClub: false, recruitNumber: 1, recruitType: 1 });
                    await sleep(350);
                }
                
                await sleep(500);
                sendCommand('role_getroleinfo', {});
                
                addLog('recruitLog', 'æ‹›å‹Ÿå®Œæ¯•ï¼', 'success');
            } catch (e) {
                addLog('recruitLog', 'æ‹›å‹Ÿå¤±è´¥: ' + e.message, 'error');
            } finally {
                isRecruiting = false;
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹æ‹›å‹Ÿ';
                document.getElementById('recruitStatus').textContent = 'å·²åœæ­¢';
                document.getElementById('recruitStatus').className = 'status-badge stopped';
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        function addLog(panelId, message, type) {
            var logPanel = document.getElementById(panelId);
            if (!logPanel) return;
            
            var time = new Date().toLocaleTimeString();
            var item = document.createElement('div');
            item.className = 'log-item ' + (type || 'info');
            item.textContent = '[' + time + '] ' + message;
            logPanel.appendChild(item);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            while (logPanel.children.length > 15) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }
        
        function sleep(ms) {
            return new Promise(function(resolve) { setTimeout(resolve, ms); });
        }
        
        // ==================== å¯åŠ¨ ====================
        init();
    </script>
</body>
</html>
