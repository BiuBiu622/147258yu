<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOSSå¡”åŠ©æˆ˜</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 20px;
      min-height: calc(100vh - 40px);
    }

    .header {
      grid-column: 1 / -1;
      text-align: center;
      color: white;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* å·¦ä¾§é…ç½®åŒº */
    .left-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* å³ä¾§çŠ¶æ€åŒº */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    /* è¡¨å•ç»„ */
    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-group select,
    .form-group input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* å°å·é€‰æ‹©åŒº */
    .scouts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    /* å¤§å·å¡ç‰‡å®¹å™¨ */
    .masters-container {
      max-height: 400px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    /* å¤§å·å¡ç‰‡ */
    .master-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .master-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .master-card.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .master-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .master-card-header input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }

    .master-card-name {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .master-card-formation {
      padding: 4px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 12px;
      background: white;
      cursor: pointer;
    }

    .master-card-formation:focus {
      outline: none;
      border-color: #667eea;
    }

    .master-card-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }

    .master-stat {
      text-align: center;
    }

    .master-stat-label {
      font-size: 10px;
      color: #999;
      margin-bottom: 2px;
    }

    .master-stat-value {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
    }

    .master-stat-value.success {
      color: #4ec9b0;
    }

    .master-stat-value.error {
      color: #f48771;
    }

    .master-stat-value.remain {
      color: #ce9178;
      /* æ”¹æˆæ©™è‰²ï¼Œæ›´æ¸…æ™° */
    }

    .scout-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scout-checkbox:hover {
      background: #f0f0ff;
      transform: translateX(2px);
    }

    .scout-checkbox input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .scout-checkbox label {
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      margin: 0;
      flex: 1;
    }

    .scout-checkbox select {
      margin-left: 8px;
      padding: 2px 6px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 11px;
      background: white;
      cursor: pointer;
      flex-shrink: 0;
    }

    .scout-checkbox select:focus {
      outline: none;
      border-color: #667eea;
    }

    /* å±‚æ•°é€‰æ‹©æ¡† */
    .floor-checkbox {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .floor-checkbox:hover {
      background: #f0f0ff;
    }

    .floor-checkbox input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }

    /* å±‚æ•°è¿‡æ»¤ */
    .floor-filter {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
    }

    .floor-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* æŒ‰é’® */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #ff4757;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #ee5a6f;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ä¸Šä¼ æŒ‰é’® */
    .upload-btn {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-btn:hover {
      background: #5568d3;
    }

    /* çŠ¶æ€å¡ç‰‡ */
    .status-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .status-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      border-radius: 10px;
      color: white;
      text-align: center;
    }

    .status-card .label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .status-card .value {
      font-size: 24px;
      font-weight: 700;
    }

    /* æ—¥å¿—åŒºåŸŸ */
    .log-panel {
      height: 500px;
      max-height: 500px;
      background: #1e1e1e;
      border-radius: 10px;
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      color: #d4d4d4;
    }

    .log-line {
      padding: 3px 0;
      line-height: 1.5;
    }

    .log-line.info {
      color: #9cdcfe;
    }

    .log-line.success {
      color: #4ec9b0;
    }

    .log-line.warn {
      color: #dcdcaa;
    }

    .log-line.error {
      color: #f48771;
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }

    .log-panel::-webkit-scrollbar-track {
      background: #2d2d2d;
    }

    .log-panel::-webkit-scrollbar-thumb {
      background: #555;
    }

    /* æç¤ºæ–‡æœ¬ */
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }

    .upload-status {
      font-size: 12px;
      margin-left: 10px;
    }

    /* ç«–å±/ç§»åŠ¨ç«¯å“åº”å¼ */
    @media (max-width: 1100px) {
      body {
        padding: 10px;
      }

      .container {
        grid-template-columns: 1fr;
        min-height: auto;
        gap: 15px;
      }

      .header {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .left-panel {
        gap: 15px;
        padding: 15px;
      }

      .status-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .status-card {
        padding: 12px;
      }

      .status-card .value {
        font-size: 20px;
      }

      .log-panel {
        min-height: 300px;
        max-height: 400px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">ğŸ° BOSSå¡”åŠ©æˆ˜</div>

    <!-- å·¦ä¾§é…ç½®åŒº -->
    <div class="left-panel">
      <!-- å¤§å·é…ç½® -->
      <div>
        <div class="panel-title">å¤§å·é…ç½® <span style="font-size: 12px; color: #999;">(å¯å¤šé€‰)</span></div>
        <div>
          <input type="file" id="master-bin-upload" accept=".bin" multiple style="display: none;"
            onchange="uploadMasterBins()">
          <button class="upload-btn" onclick="document.getElementById('master-bin-upload').click()">
            ğŸ“¤ ä¸Šä¼ å¤§å·BIN
          </button>
          <span id="master-upload-status" class="upload-status"></span>
        </div>
        <div class="masters-container" id="masters-grid" style="margin-top: 10px;">
          <div style="text-align: center; color: #999;">åŠ è½½ä¸­...</div>
        </div>
        <div class="hint">
          <button onclick="selectAllMasters()"
            style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨é€‰</button> |
          <button onclick="selectNoneMasters()"
            style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨ä¸é€‰</button>
        </div>
      </div>

      <!-- å°å·é…ç½® -->
      <div>
        <div class="panel-title">å°å·é…ç½® <span style="font-size: 12px; color: #999;">(å¯å¤šé€‰)</span></div>
        <div>
          <input type="file" id="scout-bin-upload" accept=".bin" multiple style="display: none;"
            onchange="uploadScoutBins()">
          <button class="upload-btn" onclick="document.getElementById('scout-bin-upload').click()">
            ğŸ“¤ ä¸Šä¼ å°å·BIN
          </button>
          <span id="scout-upload-status" class="upload-status"></span>
        </div>
        <div class="scouts-grid" id="scouts-grid" style="margin-top: 10px;">
          <div style="grid-column: 1/-1; text-align: center; color: #999;">åŠ è½½ä¸­...</div>
        </div>
        <div class="hint">
          <button onclick="selectAllScouts()"
            style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨é€‰</button> |
          <button onclick="selectNoneScouts()"
            style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨ä¸é€‰</button> |
          <button onclick="initScouts()"
            style="border: none; background: none; color: #f59e0b; cursor: pointer; font-size: 12px; font-weight: 600;">ğŸ”§
            åˆå§‹åŒ–BOSSå¡”æƒé™</button>
        </div>
      </div>

      <!-- å±‚æ•°è¿‡æ»¤ -->
      <div>
        <div class="panel-title">å±‚æ•°è¿‡æ»¤</div>
        <div class="floor-filter">
          <label class="checkbox-label">
            <input type="checkbox" id="floor-filter-enable">
            <span>å¯ç”¨å±‚æ•°è¿‡æ»¤</span>
          </label>
          <div style="margin-top: 10px;">
            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">é€‰æ‹©è¦æ‰“çš„å±‚æ•°ï¼š</div>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
              <label class="floor-checkbox"><input type="checkbox" value="1" class="floor-item"> 1å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="2" class="floor-item"> 2å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="4" class="floor-item"> 4å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="5" class="floor-item"> 5å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="7" class="floor-item"> 7å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="8" class="floor-item"> 8å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="10" class="floor-item"> 10å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="11" class="floor-item"> 11å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="13" class="floor-item"> 13å±‚</label>
              <label class="floor-checkbox"><input type="checkbox" value="14" class="floor-item"> 14å±‚</label>
            </div>
          </div>
          <div class="hint" style="margin-top: 10px;">
            ğŸ’¡ è·³è¿‡å±‚ï¼š-1(å·²è¿‡å…³), 3/6/9/12(BOSSå±‚), 15å±‚
          </div>
          <div style="margin-top: 8px;">
            <button onclick="selectAllFloors()"
              style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨é€‰</button> |
            <button onclick="selectNoneFloors()"
              style="border: none; background: none; color: #667eea; cursor: pointer; font-size: 12px;">å…¨ä¸é€‰</button>
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶æŒ‰é’® -->
      <div class="btn-group">
        <button class="btn btn-primary" id="btn-start" onclick="startAssist()">å¯åŠ¨</button>
        <button class="btn btn-danger" id="btn-stop" onclick="stopAssist()" disabled>åœæ­¢</button>
      </div>
    </div>

    <!-- å³ä¾§çŠ¶æ€å’Œæ—¥å¿—åŒº -->
    <div class="right-panel">
      <!-- çŠ¶æ€å¡ç‰‡ -->
      <div class="panel" style="padding: 15px;">
        <div class="status-cards">
          <div class="status-card">
            <div class="label">è¿è¡ŒçŠ¶æ€</div>
            <div class="value" id="status-running">åœæ­¢</div>
          </div>
          <div class="status-card">
            <div class="label">å½“å‰å¤§å·</div>
            <div class="value" id="status-master" style="font-size: 14px;">ç¦»çº¿</div>
          </div>
          <div class="status-card">
            <div class="label">å‰©ä½™æ¬¡æ•°</div>
            <div class="value" id="status-remain">0</div>
          </div>
          <div class="status-card">
            <div class="label">å°å·åœ¨çº¿</div>
            <div class="value" id="status-scouts">0/0</div>
          </div>
        </div>
      </div>

      <!-- è¿è¡Œæ—¥å¿— -->
      <div class="panel" style="display: flex; flex-direction: column; min-height: 0;">
        <div class="panel-title">è¿è¡Œæ—¥å¿—</div>
        <div class="log-panel" id="log-panel">
          <div class="log-line info">[ç³»ç»Ÿ] ç­‰å¾…å¯åŠ¨...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let statusTimer = null;
    let logTimer = null;

    // é¡µé¢åŠ è½½
    window.onload = async function () {
      await loadMasters();  // å…ˆåŠ è½½å¤§å·åˆ—è¡¨
      await loadScouts();   // å†åŠ è½½å°å·åˆ—è¡¨
      await loadConfig();   // æœ€ååŠ è½½é…ç½®ï¼ˆæ¢å¤å‹¾é€‰çŠ¶æ€ï¼‰
      startStatusPolling();

      // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¦‚æœæ˜¯åˆ™æ¢å¤æ—¥å¿—è½®è¯¢
      try {
        const resp = await fetch('/api/boss-assist/status');
        const status = await resp.json();
        if (status.running) {
          document.getElementById('btn-start').disabled = true;
          document.getElementById('btn-stop').disabled = false;
          startLogPolling();
        }
      } catch (e) {
        console.error('æ£€æŸ¥è¿è¡ŒçŠ¶æ€å¤±è´¥:', e);
      }
    };

    // åŠ è½½é…ç½®ï¼ˆæ¢å¤å‹¾é€‰çŠ¶æ€ï¼‰
    async function loadConfig() {
      try {
        const resp = await fetch('/api/boss-assist/config');
        const config = await resp.json();

        // æ¢å¤å¤§å·é€‰æ‹©å’Œé˜µå®¹é…ç½®
        if (config.å¤§å·?.é€‰ä¸­åˆ—è¡¨) {
          config.å¤§å·.é€‰ä¸­åˆ—è¡¨.forEach(masterName => {
            const checkbox = document.getElementById(`master-${masterName}`);
            if (checkbox) {
              checkbox.checked = true;
              toggleMasterCard(checkbox);
            }
          });
        }

        // æ¢å¤å¤§å·é˜µå®¹é…ç½®
        if (config.å¤§å·?.é˜µå®¹é…ç½®) {
          for (const [masterName, formationId] of Object.entries(config.å¤§å·.é˜µå®¹é…ç½®)) {
            const select = document.querySelector(`.master-formation[data-master="${masterName}"]`);
            if (select) {
              select.value = formationId;
            }
          }
        }

        // æ¢å¤å±‚æ•°è¿‡æ»¤é…ç½®
        if (config.å±‚æ•°è¿‡æ»¤) {
          document.getElementById('floor-filter-enable').checked = config.å±‚æ•°è¿‡æ»¤.å¯ç”¨ || false;

          // æ¢å¤é€‰ä¸­çš„å±‚æ•°
          if (config.å±‚æ•°è¿‡æ»¤.å…è®¸å±‚æ•° && Array.isArray(config.å±‚æ•°è¿‡æ»¤.å…è®¸å±‚æ•°)) {
            config.å±‚æ•°è¿‡æ»¤.å…è®¸å±‚æ•°.forEach(floor => {
              const checkbox = document.querySelector(`.floor-item[value="${floor}"]`);
              if (checkbox) checkbox.checked = true;
            });
          } else {
            // é»˜è®¤å…¨é€‰
            document.querySelectorAll('.floor-item').forEach(cb => cb.checked = true);
          }
        } else {
          // é»˜è®¤å…¨é€‰
          document.querySelectorAll('.floor-item').forEach(cb => cb.checked = true);
        }

        // æ¢å¤å°å·é€‰æ‹©é…ç½®
        if (config.å°å·?.é€‰ä¸­åˆ—è¡¨) {
          config.å°å·.é€‰ä¸­åˆ—è¡¨.forEach(scoutName => {
            const checkbox = document.getElementById(`scout-${scoutName}`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        }
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
      }
    }

    // åŠ è½½å¤§å·åˆ—è¡¨
    async function loadMasters() {
      try {
        const resp = await fetch('/api/boss-assist/masters');
        const masters = await resp.json();

        const grid = document.getElementById('masters-grid');
        if (masters.length === 0) {
          grid.innerHTML = '<div style="text-align: center; color: #999;">æ— å¤§å·BINæ–‡ä»¶</div>';
        } else {
          grid.innerHTML = masters.map(m => {
            return `
              <div class="master-card" data-master="${m.name}">
                <div class="master-card-header">
                  <input type="checkbox" id="master-${m.name}" value="${m.name}" 
                         onchange="toggleMasterCard(this)" onclick="event.stopPropagation()">
                  <div class="master-card-name">${m.name}</div>
                  <select class="master-card-formation master-formation" data-master="${m.name}" 
                          onclick="event.stopPropagation()">
                    <option value="">é»˜è®¤</option>
                    <option value="1">é˜µå®¹1</option>
                    <option value="2">é˜µå®¹2</option>
                    <option value="3">é˜µå®¹3</option>
                    <option value="4">é˜µå®¹4</option>
                    <option value="5">é˜µå®¹5</option>
                  </select>
                </div>
                <div class="master-card-stats">
                  <div class="master-stat">
                    <div class="master-stat-label">åŠ©æˆ˜</div>
                    <div class="master-stat-value" id="master-${m.name}-total">0</div>
                  </div>
                  <div class="master-stat">
                    <div class="master-stat-label">æˆåŠŸ</div>
                    <div class="master-stat-value success" id="master-${m.name}-success">0</div>
                  </div>
                  <div class="master-stat">
                    <div class="master-stat-label">å¤±è´¥</div>
                    <div class="master-stat-value error" id="master-${m.name}-fail">0</div>
                  </div>
                  <div class="master-stat">
                    <div class="master-stat-label">å‰©ä½™</div>
                    <div class="master-stat-value remain" id="master-${m.name}-remain">-</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶
          document.querySelectorAll('.master-card').forEach(card => {
            card.addEventListener('click', function (e) {
              if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                toggleMasterCard(checkbox);
              }
            });
          });
        }
      } catch (e) {
        console.error('åŠ è½½å¤§å·åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    // åˆ‡æ¢å¤§å·å¡ç‰‡é€‰ä¸­çŠ¶æ€
    function toggleMasterCard(checkbox) {
      const card = checkbox.closest('.master-card');
      if (checkbox.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    }

    // åŠ è½½å°å·åˆ—è¡¨
    async function loadScouts() {
      try {
        const resp = await fetch('/api/boss-assist/scouts');
        const scouts = await resp.json();

        const grid = document.getElementById('scouts-grid');
        if (scouts.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999;">æ— å°å·BINæ–‡ä»¶</div>';
        } else {
          grid.innerHTML = scouts.map(s => {
            const checked = window.selectedScouts && window.selectedScouts.includes(s.name) ? 'checked' : '';
            return `
              <div class="scout-checkbox">
                <input type="checkbox" id="scout-${s.name}" value="${s.name}" ${checked}>
                <label for="scout-${s.name}">${s.name}</label>
              </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.error('åŠ è½½å°å·åˆ—è¡¨å¤±è´¥:', e);
      }
    }

    // å…¨é€‰å¤§å·
    function selectAllMasters() {
      document.querySelectorAll('#masters-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    // å…¨ä¸é€‰å¤§å·
    function selectNoneMasters() {
      document.querySelectorAll('#masters-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    // å…¨é€‰å°å·
    function selectAllScouts() {
      document.querySelectorAll('#scouts-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    // å…¨ä¸é€‰å°å·
    function selectNoneScouts() {
      document.querySelectorAll('#scouts-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    // è½®è¯¢å®šæ—¶å™¨
    let initLogPollTimer = null;

    // åˆå§‹åŒ–å°å·BOSSå¡”æƒé™
    async function initScouts() {
      if (!confirm('ç¡®å®šè¦ä¸ºæ‰€æœ‰é€‰ä¸­çš„å°å·åˆå§‹åŒ–BOSSå¡”æƒé™å—ï¼Ÿ\n\nè¿™å°†ä¸ºæ¯ä¸ªå°å·æ‰§è¡Œä¸€æ¬¡æ¯æ—¥å’¸ç‹ä»»åŠ¡ï¼Œè§£é”BOSSå¡”æ¨èé˜Ÿä¼åŠŸèƒ½ã€‚\n\nåç«¯ä»»åŠ¡å°†å¼‚æ­¥æ‰§è¡Œï¼Œæ‚¨å¯ä»¥å…³é—­ç½‘é¡µï¼Œä»»åŠ¡ä¸ä¼šä¸­æ–­ã€‚')) {
        return;
      }

      const btn = event.target || document.querySelector('button[onclick="initScouts()"]');
      const originalText = btn.textContent;

      try {
        btn.disabled = true;
        btn.textContent = 'ğŸš€ å¯åŠ¨ä¸­...';

        const resp = await fetch('/api/boss-assist/init-scouts', { method: 'POST' });
        const result = await resp.json();

        if (result.success) {
          showInitLogModal();
          startInitLogPolling(btn, originalText);
        } else {
          alert('âŒ å¯åŠ¨å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
          btn.disabled = false;
          btn.textContent = originalText;
        }
      } catch (e) {
        btn.disabled = false;
        btn.textContent = originalText;
        alert('âŒ è¯·æ±‚å¤±è´¥ï¼š' + e.message);
        console.error(e);
      }
    }

    // æ˜¾ç¤ºæ—¥å¿—å¼¹çª—
    function showInitLogModal() {
      if (document.querySelector('.log-modal-overlay')) return;

      const div = document.createElement('div');
      div.style.cssText = "position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;justify-content:center;align-items:center;";

      div.innerHTML = `
            <div style="background:white;padding:20px;border-radius:8px;width:700px;display:flex;flex-direction:column;box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <h3 style="margin:0;">åˆå§‹åŒ–è¿è¡Œæ—¥å¿— (å®æ—¶)</h3>
                    <button onclick="closeInitLogModal()" style="border:none;background:none;font-size:20px;cursor:pointer;">&times;</button>
                </div>
                <div id="init-log-container" style="height:500px;overflow:auto;background:#1e1e1e;color:#d4d4d4;padding:15px;border-radius:4px;font-family:Consolas, monospace;white-space:pre-wrap;">æ­£åœ¨è¿æ¥æ—¥å¿—æµ...</div>
                <div style="margin-top:15px;text-align:right;">
                    <span id="init-status-text" style="margin-right:10px;color:#666;">è¿è¡Œä¸­...</span>
                    <button onclick="closeInitLogModal()" style="padding:8px 20px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer;">åå°è¿è¡Œ/å…³é—­</button>
                </div>
            </div>
        `;
      div.className = 'log-modal-overlay';
      document.body.appendChild(div);
    }

    function closeInitLogModal() {
      const el = document.querySelector('.log-modal-overlay');
      if (el) el.remove();
      // å…³é—­çª—å£æ—¶åœæ­¢å‰ç«¯è½®è¯¢ï¼Œå‡å°‘è¯·æ±‚
      if (initLogPollTimer) clearInterval(initLogPollTimer);
    }

    function startInitLogPolling(btn, originalText) {
      if (initLogPollTimer) clearInterval(initLogPollTimer);

      const poll = async () => {
        try {
          const res = await fetch('/api/boss-assist/init-logs');
          const data = await res.json();

          const container = document.getElementById('init-log-container');
          const statusText = document.getElementById('init-status-text');

          // æ›´æ–°æ—¥å¿—å†…å®¹
          if (data.logs && container) {
            const html = data.logs.map(l => `[${l.time}] ${l.type === 'error' ? 'âŒ ' : ''}${l.message}`).join('\n');
            if (container.innerHTML !== html) {
              container.innerHTML = html;
              container.scrollTop = container.scrollHeight;
            }
          }

          // æ›´æ–°çŠ¶æ€
          if (data.running === false) {
            clearInterval(initLogPollTimer);
            if (statusText) {
              statusText.textContent = "âœ… ä»»åŠ¡å·²ç»“æŸ";
              statusText.style.color = "green";
            }
            if (btn) {
              btn.disabled = false;
              btn.textContent = originalText;
            }
          } else {
            if (statusText) statusText.textContent = "â³ è¿è¡Œä¸­...";
            if (btn) btn.textContent = 'â³ è¿è¡Œä¸­...';
          }

        } catch (e) { console.error(e); }
      };

      // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      poll();
      initLogPollTimer = setInterval(poll, 1500);
    }

    // å…¨é€‰å±‚æ•°
    function selectAllFloors() {
      document.querySelectorAll('.floor-item').forEach(cb => cb.checked = true);
    }

    // å…¨ä¸é€‰å±‚æ•°
    function selectNoneFloors() {
      document.querySelectorAll('.floor-item').forEach(cb => cb.checked = false);
    }

    // è·å–é€‰ä¸­çš„å¤§å·åŠå…¶é˜µå®¹é…ç½®
    function getSelectedMastersWithFormations() {
      const checkboxes = document.querySelectorAll('#masters-grid input[type="checkbox"]:checked');
      const masters = Array.from(checkboxes).map(cb => cb.value);

      const formations = {};
      document.querySelectorAll('.master-formation').forEach(select => {
        const masterName = select.getAttribute('data-master');
        const formationId = select.value;
        if (formationId) {
          formations[masterName] = parseInt(formationId);
        }
      });

      return { masters, formations };
    }

    // è·å–é€‰ä¸­çš„å¤§å·ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
    function getSelectedMasters() {
      const checkboxes = document.querySelectorAll('#masters-grid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // è·å–é€‰ä¸­çš„å°å·
    function getSelectedScouts() {
      const checkboxes = document.querySelectorAll('#scouts-grid input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // è·å–é€‰ä¸­çš„å±‚æ•°
    function getSelectedFloors() {
      const checkboxes = document.querySelectorAll('.floor-item:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    // ä¿å­˜é…ç½®
    async function saveConfig() {
      const { masters, formations } = getSelectedMastersWithFormations();
      const selectedScouts = getSelectedScouts();
      const selectedFloors = getSelectedFloors();

      const config = {
        å¤§å·: {
          é€‰ä¸­åˆ—è¡¨: masters,
          é˜µå®¹é…ç½®: formations
        },
        å°å·: {
          é€‰ä¸­åˆ—è¡¨: selectedScouts
        },
        å±‚æ•°è¿‡æ»¤: {
          å¯ç”¨: document.getElementById('floor-filter-enable').checked,
          å…è®¸å±‚æ•°: selectedFloors
        }
      };

      try {
        await fetch('/api/boss-assist/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
      } catch (e) {
        console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
      }
    }

    // ä¸Šä¼ å¤§å·BIN
    async function uploadMasterBins() {
      const fileInput = document.getElementById('master-bin-upload');
      const files = fileInput.files;

      if (files.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      const statusEl = document.getElementById('master-upload-status');
      statusEl.textContent = 'ä¸Šä¼ ä¸­...';
      statusEl.style.color = '#667eea';

      try {
        const formData = new FormData();
        formData.append('type', 'master');
        for (let i = 0; i < files.length; i++) {
          formData.append('binFile', files[i]);
        }

        const resp = await fetch('/api/boss-assist/upload-bin', {
          method: 'POST',
          body: formData
        });

        const result = await resp.json();

        if (result.success) {
          statusEl.textContent = `âœ“ æˆåŠŸä¸Šä¼  ${result.count} ä¸ª`;
          statusEl.style.color = '#4ec9b0';
          fileInput.value = '';
          await loadMasters();
          setTimeout(() => { statusEl.textContent = ''; }, 3000);
        } else {
          statusEl.textContent = 'âœ— ' + (result.error || 'ä¸Šä¼ å¤±è´¥');
          statusEl.style.color = '#f48771';
        }
      } catch (e) {
        statusEl.textContent = 'âœ— ' + e.message;
        statusEl.style.color = '#f48771';
      }
    }

    // ä¸Šä¼ å°å·BIN
    async function uploadScoutBins() {
      const fileInput = document.getElementById('scout-bin-upload');
      const files = fileInput.files;

      if (files.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      const statusEl = document.getElementById('scout-upload-status');
      statusEl.textContent = 'ä¸Šä¼ ä¸­...';
      statusEl.style.color = '#667eea';

      try {
        const formData = new FormData();
        formData.append('type', 'scout');
        for (let i = 0; i < files.length; i++) {
          formData.append('binFile', files[i]);
        }

        const resp = await fetch('/api/boss-assist/upload-bin', {
          method: 'POST',
          body: formData
        });

        const result = await resp.json();

        if (result.success) {
          statusEl.textContent = `âœ“ æˆåŠŸä¸Šä¼  ${result.count} ä¸ª`;
          statusEl.style.color = '#4ec9b0';
          fileInput.value = '';
          await loadScouts();
          setTimeout(() => { statusEl.textContent = ''; }, 3000);
        } else {
          statusEl.textContent = 'âœ— ' + (result.error || 'ä¸Šä¼ å¤±è´¥');
          statusEl.style.color = '#f48771';
        }
      } catch (e) {
        statusEl.textContent = 'âœ— ' + e.message;
        statusEl.style.color = '#f48771';
      }
    }

    // å¯åŠ¨
    async function startAssist() {
      const selectedMasters = getSelectedMasters();
      if (selectedMasters.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¤§å·');
        return;
      }

      const selectedScouts = getSelectedScouts();
      if (selectedScouts.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå°å·');
        return;
      }

      await saveConfig();

      document.getElementById('btn-start').disabled = true;
      document.getElementById('log-panel').innerHTML = '';

      try {
        const resp = await fetch('/api/boss-assist/start', { method: 'POST' });
        const result = await resp.json();

        if (result.success) {
          document.getElementById('btn-stop').disabled = false;
          startLogPolling();
        } else {
          document.getElementById('btn-start').disabled = false;
        }
      } catch (e) {
        document.getElementById('btn-start').disabled = false;
      }
    }

    // åœæ­¢
    async function stopAssist() {
      document.getElementById('btn-stop').disabled = true;

      try {
        await fetch('/api/boss-assist/stop', { method: 'POST' });
        document.getElementById('btn-start').disabled = false;
        stopLogPolling();
      } catch (e) {
        document.getElementById('btn-stop').disabled = false;
      }
    }

    // çŠ¶æ€è½®è¯¢
    function startStatusPolling() {
      updateStatus();
      statusTimer = setInterval(updateStatus, 2000);
    }

    async function updateStatus() {
      try {
        const resp = await fetch('/api/boss-assist/status');
        const status = await resp.json();

        document.getElementById('status-running').textContent = status.running ? 'è¿è¡Œä¸­' : 'åœæ­¢';

        // æ˜¾ç¤ºå½“å‰å¤§å·å’Œè¿›åº¦
        if (status.masterName) {
          const progress = status.masterTotal > 1 ? ` (${status.masterIndex + 1}/${status.masterTotal})` : '';
          document.getElementById('status-master').textContent = status.masterName + progress;
        } else {
          document.getElementById('status-master').textContent = 'ç¦»çº¿';
        }

        document.getElementById('status-remain').textContent = status.masterRemainCount || 0;
        document.getElementById('status-scouts').textContent = `${status.scoutConnected || 0}/${status.scoutCount || 0}`;

        // æ›´æ–°æ‰€æœ‰å¤§å·å¡ç‰‡çš„ç»Ÿè®¡æ•°æ®
        if (status.masterStats) {
          for (const [masterName, stats] of Object.entries(status.masterStats)) {
            const totalEl = document.getElementById(`master-${masterName}-total`);
            const successEl = document.getElementById(`master-${masterName}-success`);
            const failEl = document.getElementById(`master-${masterName}-fail`);

            if (totalEl) totalEl.textContent = stats.total || 0;
            if (successEl) successEl.textContent = stats.success || 0;
            if (failEl) failEl.textContent = stats.fail || 0;
          }
        }

        // æ›´æ–°å½“å‰å¤§å·çš„å‰©ä½™æ¬¡æ•°
        if (status.masterName) {
          const remainEl = document.getElementById(`master-${status.masterName}-remain`);
          if (remainEl) {
            remainEl.textContent = status.masterRemainCount || 0;
          }
        }

        document.getElementById('btn-start').disabled = status.running;
        document.getElementById('btn-stop').disabled = !status.running;
      } catch (e) {
        console.error('è·å–çŠ¶æ€å¤±è´¥:', e);
      }
    }

    // æ—¥å¿—è½®è¯¢
    function startLogPolling() {
      fetchLogs();  // ç«‹å³åŠ è½½ä¸€æ¬¡
      logTimer = setInterval(fetchLogs, 1000);  // æ¯ç§’åˆ·æ–°
    }

    function stopLogPolling() {
      if (logTimer) {
        clearInterval(logTimer);
        logTimer = null;
      }
    }

    async function fetchLogs() {
      try {
        const resp = await fetch('/api/boss-assist/logs?since=0');
        const data = await resp.json();

        const panel = document.getElementById('log-panel');

        if (!data.logs || data.logs.length === 0) {
          panel.innerHTML = '<div class="log-line info">[ç³»ç»Ÿ] ç­‰å¾…æ—¥å¿—...</div>';
          return;
        }

        // åªå–æœ€å100æ¡æ—¥å¿—
        const recentLogs = data.logs.slice(-100);

        // å®Œå…¨é‡æ–°æ¸²æŸ“
        let html = '';
        recentLogs.forEach(log => {
          const timeStr = log.time || '';
          const className = 'log-line ' + (log.type || 'info');
          const message = escapeHtml(log.message);
          html += `<div class="${className}">[${timeStr}] ${message}</div>`;
        });

        panel.innerHTML = html;
        panel.scrollTop = panel.scrollHeight;
      } catch (e) {
        console.error('è·å–æ—¥å¿—å¤±è´¥:', e);
      }
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>

</html>