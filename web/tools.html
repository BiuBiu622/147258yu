<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å…·ç®±</title>
    <link rel="stylesheet" href="css/tools.css">
</head>
<body>
    <div class="main-container">
        <!-- è¿æ¥é¢æ¿ -->
        <div class="connection-panel">
            <label>é€‰æ‹©è´¦å·ï¼š</label>
            <select id="accountSelect">
                <option value="">-- è¯·é€‰æ‹©è´¦å· --</option>
            </select>
            <span id="connectionStatus" class="status-badge disconnected">æœªè¿æ¥</span>
            <button id="connectBtn" class="btn btn-primary" onclick="connectAccount()">è¿æ¥</button>
            <button id="disconnectBtn" class="btn btn-secondary" onclick="disconnectAccount()" style="display:none;">æ–­å¼€</button>
        </div>
        
        <!-- èº«ä»½ç‰Œ -->
        <div class="identity-card" id="identityCard" style="display:none;">
            <div class="identity-header">
                <img src="icons/sfp.png" alt="èº«ä»½ç‰Œ" class="identity-icon">
                <div class="identity-info">
                    <h3>èº«ä»½ç‰Œ</h3>
                    <p>è§’è‰²ä¸èµ„æºæ¦‚è§ˆ</p>
                </div>
            </div>
            <div class="role-profile" id="roleProfile">
                <div class="avatar-container">
                    <img id="roleAvatar" src="" alt="è§’è‰²å¤´åƒ" class="role-avatar">
                </div>
                <div class="role-info">
                    <div class="role-name" id="roleName">æœªçŸ¥è§’è‰²</div>
                    <div class="role-stats">
                        <span class="level">Lv.<span id="roleLevel">1</span></span>
                        <span class="power">æˆ˜åŠ› <span id="rolePower">0</span></span>
                    </div>
                </div>
                <div class="rank-section">
                    <span class="rank-icon" id="rankIcon">ğŸŒ±</span>
                    <span class="rank-title" id="rankTitle">åˆå‡ºèŒ…åº</span>
                </div>
            </div>
            <div class="resources-grid" id="resourcesGrid">
                <!-- èµ„æºåˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="resources-toggle">
                <button class="toggle-btn" id="toggleResourcesBtn" onclick="toggleResources()">å±•å¼€å…¨éƒ¨</button>
            </div>
        </div>
        
        <!-- å·¥å…·å¡ç‰‡ç½‘æ ¼ -->
        <div class="tools-grid">
            <!-- å®ç®±åŠ©æ‰‹ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/zsbx.png" alt="å®ç®±å›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>å®ç®±åŠ©æ‰‹</h3>
                    </div>
                    <div class="status-badge" id="boxStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="total-points">
                        <span class="label">å®ç®±æ€»ç§¯åˆ†ï¼š</span>
                        <span class="value" id="boxTotalPoints">0</span>
                    </div>
                    <div class="item-list box-list">
                        <div class="item">
                            <img src="icons/mzbx.png" alt="æœ¨è´¨å®ç®±">
                            <div class="item-info">
                                <div class="item-type">æœ¨è´¨å®ç®±</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="box2001">0</span></div>
                            </div>
                        </div>
                        <div class="item">
                            <img src="icons/qtbx.png" alt="é’é“œå®ç®±">
                            <div class="item-info">
                                <div class="item-type">é’é“œå®ç®±</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="box2002">0</span></div>
                            </div>
                        </div>
                        <div class="item">
                            <img src="icons/hjbx.png" alt="é»„é‡‘å®ç®±">
                            <div class="item-info">
                                <div class="item-type">é»„é‡‘å®ç®±</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="box2003">0</span></div>
                            </div>
                        </div>
                        <div class="item">
                            <img src="icons/bjbx.png" alt="é“‚é‡‘å®ç®±">
                            <div class="item-info">
                                <div class="item-type">é“‚é‡‘å®ç®±</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="box2004">0</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="selects">
                        <select id="boxType">
                            <option value="2001">æœ¨è´¨å®ç®±</option>
                            <option value="2002">é’é“œå®ç®±</option>
                            <option value="2003">é»„é‡‘å®ç®±</option>
                            <option value="2004">é“‚é‡‘å®ç®±</option>
                        </select>
                        <select id="boxCount">
                            <option value="10">10</option>
                            <option value="100" selected>100</option>
                            <option value="1000">1000</option>
                            <option value="2000">2000</option>
                            <option value="5000">5000</option>
                            <option value="10000">10000</option>
                        </select>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="openBoxes()">å¼€å¯å®ç®±</button>
                    <button class="action-btn primary" onclick="claimBoxPoints()">é¢†å–å®ç®±ç§¯åˆ†</button>
                </div>
            </div>
            
            <!-- é’“é±¼åŠ©æ‰‹ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/hjyg.png" alt="é’“é±¼å›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>é’“é±¼åŠ©æ‰‹</h3>
                    </div>
                    <div class="status-badge" id="fishStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="item-list fish-list">
                        <div class="item">
                            <img src="icons/ptyg.png" alt="æ™®é€šé±¼ç«¿">
                            <div class="item-info">
                                <div class="item-type">æ™®é€šé±¼ç«¿</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="fish1011">0</span></div>
                            </div>
                        </div>
                        <div class="item">
                            <img src="icons/hjyg.png" alt="é»„é‡‘é±¼ç«¿">
                            <div class="item-info">
                                <div class="item-type">é»„é‡‘é±¼ç«¿</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="fish1012">0</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="selects">
                        <select id="fishType">
                            <option value="1">æ™®é€šé±¼ç«¿</option>
                            <option value="2">é»„é‡‘é±¼ç«¿</option>
                        </select>
                        <select id="fishCount">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="80">80</option>
                            <option value="100" selected>100</option>
                            <option value="160">160</option>
                        </select>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="startFishing()">å¼€å§‹é’“é±¼</button>
                </div>
            </div>
            
            <!-- æ‹›å‹ŸåŠ©æ‰‹ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/zml.png" alt="æ‹›å‹Ÿå›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>æ‹›å‹ŸåŠ©æ‰‹</h3>
                    </div>
                    <div class="status-badge" id="recruitStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="item-list recruit-list">
                        <div class="item">
                            <img src="icons/zml.png" alt="æ‹›å‹Ÿä»¤">
                            <div class="item-info">
                                <div class="item-type">æ‹›å‹Ÿä»¤</div>
                                <div class="item-count">æ•°é‡ï¼š<span id="recruit1001">0</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="selects">
                        <select id="recruitCount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="400">400</option>
                        </select>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="startRecruit()">å¼€å§‹æ‹›å‹Ÿ</button>
                </div>
            </div>
            
            <!-- æ¶ˆè€—æ´»åŠ¨è¿›åº¦ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">ğŸ“Š</div>
                    <div class="status-title">
                        <h3>æ¶ˆè€—æ´»åŠ¨è¿›åº¦</h3>
                    </div>
                </div>
                <div class="card-content">
                    <div class="activity-items">
                        <div class="activity-item-row">
                            <span class="label">é»„é‡‘é“å…·æ•°é‡ï¼š</span>
                            <span class="value" id="activityGoldItem">0</span>
                            <span class="label" style="margin-left:16px;">æ™®é€šé“å…·æ•°é‡ï¼š</span>
                            <span class="value" id="activityItem">0</span>
                        </div>
                        <div class="selects" style="margin:8px 0;">
                            <span class="label">ä½¿ç”¨æ•°é‡ï¼š</span>
                            <select id="activityCount">
                                <option value="1">1</option>
                                <option value="4" selected>4</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
                            <button class="action-btn primary" onclick="openActivityItem()">æ‰“å¼€æ™®é€šé“å…·</button>
                        </div>
                    </div>
                    <div class="progress-list" id="activityProgressList">
                        <div class="progress-item">
                            <div class="progress-header"><span>æ‹›å‹Ÿ</span><span id="progressRecruit">0/80</span></div>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progressRecruitBar" style="width:0%"></div></div>
                            <div class="progress-footer" id="progressRecruitFooter">ä¸‹ä¸€æ¡£: 80 (è¿˜éœ€ 80)</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header"><span>å®ç®±</span><span id="progressBox">0/2000</span></div>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progressBoxBar" style="width:0%"></div></div>
                            <div class="progress-footer" id="progressBoxFooter">ä¸‹ä¸€æ¡£: 2000 (è¿˜éœ€ 2000)</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header"><span>æ•è·</span><span id="progressCapture">0/25</span></div>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progressCaptureBar" style="width:0%"></div></div>
                            <div class="progress-footer" id="progressCaptureFooter">ä¸‹ä¸€æ¡£: 25 (è¿˜éœ€ 25)</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header"><span>ç›ç½</span><span id="progressBottle">0/60</span></div>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progressBottleBar" style="width:0%;background:#52c41a;"></div></div>
                            <div class="progress-footer" id="progressBottleFooter">ä¸‹ä¸€æ¡£: 60 (è¿˜éœ€ 60)</div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header"><span>é‡‘ç –</span><span id="progressDiamond">0/50000</span></div>
                            <div class="progress-bar-container"><div class="progress-bar-fill" id="progressDiamondBar" style="width:0%"></div></div>
                            <div class="progress-footer" id="progressDiamondFooter">ä¸‹ä¸€æ¡£: 50000 (è¿˜éœ€ 50000)</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å‡æ˜ŸåŠ©æ‰‹ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/ta.png" alt="å‡æ˜Ÿå›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>å‡æ˜ŸåŠ©æ‰‹</h3>
                        <p>å‡æ˜Ÿã€å›¾é‰´å‡æ˜Ÿã€é¢†å–å¥–åŠ±</p>
                    </div>
                    <div class="status-badge" id="starStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="setting-row">
                        <span class="label">å»¶è¿Ÿ(ms)ï¼š</span>
                        <select id="starDelay">
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="300" selected>300</option>
                            <option value="500">500</option>
                        </select>
                        <span class="label" style="margin-left:16px;">è‹±é›„æ•°é‡ï¼š</span>
                        <span id="heroCount">62</span>
                    </div>
                    <div class="progress-row" style="margin-top:12px;">
                        <div class="progress-bar-container" style="flex:1;"><div class="progress-bar-fill" id="starProgressBar" style="width:0%"></div></div>
                        <span id="starProgressText" style="margin-left:8px;font-size:13px;color:#64748b;">0/0 0%</span>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="startHeroUpgrade()">å‡æ˜Ÿ</button>
                    <button class="action-btn primary" onclick="startBookUpgrade()">å›¾é‰´</button>
                    <button class="action-btn primary" onclick="startClaimRewards()">é¢†å¥–</button>
                    <button class="action-btn secondary" id="stopStarBtn" onclick="stopStarTask()" disabled>åœæ­¢</button>
                </div>
            </div>
            
            <!-- æ­¦å°†å‡çº§ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/ta.png" alt="å‡çº§å›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>æ­¦å°†å‡çº§</h3>
                        <p>æ­¦å°†å‡çº§,æ–¹ä¾¿å¡é€Ÿ</p>
                    </div>
                    <div class="status-badge" id="heroUpgradeStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="setting-row">
                        <span class="label">æ­¦å°†é€‰æ‹©ï¼š</span>
                        <select id="heroSelect" style="flex:1;" onchange="onHeroSelect()">
                            <option value="">-- è¯·é€‰æ‹©æ­¦å°† --</option>
                        </select>
                    </div>
                    <div id="heroDetailPanel" style="display:none;margin-top:12px;">
                        <div class="hero-detail">
                            <img id="heroDetailAvatar" src="" alt="æ­¦å°†å¤´åƒ" class="hero-avatar">
                            <div class="hero-stats">
                                <div>æ”»å‡»ï¼š<span id="heroAttack">0</span></div>
                                <div>é€Ÿåº¦ï¼š<span id="heroSpeed">0</span></div>
                            </div>
                        </div>
                        <div class="setting-row" style="margin-top:8px;">
                            <span class="label">å‡çº§ç­‰çº§ï¼š</span>
                            <select id="heroLevelNum">
                                <option value="1">1</option>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="levelHeroUpgrade()">å‡çº§</button>
                    <button class="action-btn primary" onclick="orderHeroUpgrade()">è¿›é˜¶</button>
                </div>
            </div>
            
            <!-- ç«æŠ€åœºåŠ©æ‰‹ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="status-icon">
                        <img src="icons/jjc.png" alt="ç«æŠ€åœºå›¾æ ‡">
                    </div>
                    <div class="status-title">
                        <h3>ç«æŠ€åœºåŠ©æ‰‹</h3>
                    </div>
                    <div class="status-badge" id="arenaStatus">
                        <div class="status-dot"></div>
                        <span>å·²åœæ­¢</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="total-points">
                        <span class="label">å’¸ç¥é—¨ç¥¨æ•°é‡ï¼š</span>
                        <span class="value" id="arenaTicket">0</span>
                    </div>
                    <div class="selects" style="margin-top:12px;">
                        <span class="label">æˆ˜æ–—æ¬¡æ•°ï¼š</span>
                        <select id="arenaCount">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                            <option value="2000">2000</option>
                            <option value="5000">5000</option>
                            <option value="10000">10000</option>
                        </select>
                    </div>
                </div>
                <div class="card-action">
                    <button class="action-btn primary" onclick="startArenaFight()">å¼€å§‹æˆ˜æ–—</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toastContainer"></div>

    <script>
        // ==================== Toast æç¤º ====================
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ==================== å…¨å±€å˜é‡ ====================
        let tokens = [];
        let currentAccount = null;
        let isConnected = false;
        let roleInfo = null;
        let resourcesExpanded = false;
        
        // æˆ˜åŠ›ç­‰çº§é…ç½®
        const powerRanks = [
            { min: 0, max: 1_000_000, title: "åˆå‡ºèŒ…åº", icon: "ğŸŒ±", class: "rank-beginner" },
            { min: 1_000_000, max: 10_000_000, title: "å°æœ‰åæ°”", icon: "âš”ï¸", class: "rank-known" },
            { min: 10_000_000, max: 100_000_000, title: "å‡ºå…¥æ±Ÿæ¹–", icon: "ğŸ—¡ï¸", class: "rank-veteran" },
            { min: 100_000_000, max: 500_000_000, title: "çºµæ¨ªå››æ–¹", icon: "ğŸ¹", class: "rank-master" },
            { min: 500_000_000, max: 2_000_000_000, title: "ç›–ä¸–è±ªæ°", icon: "âš¡", class: "rank-hero" },
            { min: 2_000_000_000, max: 4_000_000_000, title: "ä¸€æ–¹æ­é›„", icon: "ğŸ‘‘", class: "rank-overlord" },
            { min: 4_000_000_000, max: 6_000_000_000, title: "ç¥ç¨æ±Ÿæ¹–", icon: "ğŸ”±", class: "rank-supreme" },
            { min: 6_000_000_000, max: 9_000_000_000, title: "ç‹¬éœ¸å¤©ä¸‹", icon: "âšœï¸", class: "rank-emperor" },
            { min: 9_000_000_000, max: 15_000_000_000, title: "ä¸ä¸–ä¹‹å°Š", icon: "ğŸ’", class: "rank-legend" },
            { min: 15_000_000_000, max: Infinity, title: "æ— æè‡³å°Š", icon: "ğŸŒŸ", class: "rank-infinite" },
        ];
        
        // èµ„æºIDæ˜ å°„
        const resourceMap = [
            { id: 'gold', label: 'é‡‘å¸', key: 'gold' },
            { id: 'diamond', label: 'é‡‘ç –', key: 'diamond' },
            { id: 1011, label: 'æ™®é€šé±¼ç«¿' },
            { id: 1012, label: 'é‡‘é±¼ç«¿' },
            { id: 1013, label: 'çç ' },
            { id: 1017, label: 'å¤æ´»ä¸¹' },
            { id: 1001, label: 'æ‹›å‹Ÿä»¤' },
            { id: 1006, label: 'ç²¾é“' },
            { id: 1023, label: 'å½©ç‰' },
            { id: 1003, label: 'è¿›é˜¶çŸ³' },
            { id: 10002, label: 'è“ç‰' },
            { id: 10003, label: 'çº¢ç‰' },
            { id: 10101, label: 'å››åœ£ç¢ç‰‡' },
            { id: 3001, label: 'é‡‘å¸è¢‹å­' },
            { id: 3002, label: 'é‡‘ç –è¢‹å­' },
            { id: 3005, label: 'ç´«è‰²éšæœºç¢ç‰‡' },
            { id: 3006, label: 'æ©™è‰²éšæœºç¢ç‰‡' },
            { id: 3007, label: 'çº¢è‰²éšæœºç¢ç‰‡' },
            { id: 3008, label: 'ç²¾é“è¢‹å­' },
            { id: 3009, label: 'è¿›é˜¶è¢‹å­' },
            { id: 3010, label: 'æ¢¦é­‡è¢‹å­' },
            { id: 3011, label: 'ç™½ç‰è¢‹å­' },
            { id: 3012, label: 'æ‰³æ‰‹è¢‹å­' },
            { id: 3020, label: 'èšå®ç›†' },
            { id: 3021, label: 'è±ªåèšå®ç›†' },
            { id: 3201, label: 'çº¢è‰²ä¸‡èƒ½ç¢ç‰‡' },
            { id: 3302, label: 'æ©™è‰²ä¸‡èƒ½ç¢ç‰‡' },
            { id: 1019, label: 'ç›é›' },
            { id: 1016, label: 'æ™¶çŸ³' },
            { id: 1020, label: 'çš®è‚¤å¸' },
            { id: 1021, label: 'æ‰«è¡é­”æ¯¯' },
            { id: 1022, label: 'ç™½ç‰' },
            { id: 1033, label: 'è´å£³' },
            { id: 1035, label: 'é‡‘ç›é›' },
            { id: 1007, label: 'ç«æŠ€åœºé—¨ç¥¨' },
            { id: 2001, label: 'æœ¨åˆ¶å®ç®±' },
            { id: 2002, label: 'é’é“œå®ç®±' },
            { id: 2003, label: 'é»„é‡‘å®ç®±' },
            { id: 2004, label: 'é“‚é‡‘å®ç®±' },
            { id: 2005, label: 'é’»çŸ³å®ç®±' },
            { id: 35002, label: 'åˆ·æ–°åˆ¸' },
            { id: 35009, label: 'é›¶ä»¶' },
            { id: 1008, label: 'æœ¨æŸ´ç«æŠŠ' },
            { id: 1009, label: 'é’é“œç«æŠŠ' },
            { id: 1010, label: 'å’¸ç¥ç«æŠŠ' },
            { id: 1014, label: 'å†›å›¢å¸' },
            { id: 1026, label: 'æ‰³æ‰‹' },
            { id: 2101, label: 'åŠ©å¨å¸' },
        ];
        
        // ==================== åˆå§‹åŒ– ====================
        async function init() {
            try {
                const res = await fetch('/data/tokens.json?t=' + Date.now());
                if (!res.ok) throw new Error('æ— æ³•åŠ è½½è´¦å·åˆ—è¡¨');
                tokens = await res.json();
                
                const select = document.getElementById('accountSelect');
                tokens.forEach(function(t) {
                    const opt = document.createElement('option');
                    opt.value = t.name;
                    opt.textContent = t.name;
                    select.appendChild(opt);
                });
                
                const urlParams = new URLSearchParams(window.location.search);
                const accountName = urlParams.get('account');
                if (accountName) {
                    select.value = accountName;
                    setTimeout(connectAccount, 300);
                }
            } catch (e) {
                console.error('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', e);
                showToast('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        // ==================== æ›´æ–°é“å…·æ•°é‡æ˜¾ç¤º ====================
        function updateItemCounts(roleInfo) {
            if (!roleInfo || !roleInfo.role || !roleInfo.role.items) return;
            
            const items = roleInfo.role.items;
            
            // å®ç®±æ•°é‡
            const box2001 = items[2001]?.quantity || 0;
            const box2002 = items[2002]?.quantity || 0;
            const box2003 = items[2003]?.quantity || 0;
            const box2004 = items[2004]?.quantity || 0;
            
            document.getElementById('box2001').textContent = box2001;
            document.getElementById('box2002').textContent = box2002;
            document.getElementById('box2003').textContent = box2003;
            document.getElementById('box2004').textContent = box2004;
            
            // å®ç®±æ€»ç§¯åˆ†
            const totalPoints = box2001 * 1 + box2002 * 10 + box2003 * 20 + box2004 * 50;
            document.getElementById('boxTotalPoints').textContent = totalPoints;
            
            // é±¼ç«¿æ•°é‡
            document.getElementById('fish1011').textContent = items[1011]?.quantity || 0;
            document.getElementById('fish1012').textContent = items[1012]?.quantity || 0;
            
            // æ‹›å‹Ÿä»¤æ•°é‡
            document.getElementById('recruit1001').textContent = items[1001]?.quantity || 0;
            
            // æ´»åŠ¨é“å…·æ•°é‡
            document.getElementById('activityItem').textContent = items[5261]?.quantity || 0;
            document.getElementById('activityGoldItem').textContent = items[5262]?.quantity || 0;
            
            // ç«æŠ€åœºé—¨ç¥¨æ•°é‡
            document.getElementById('arenaTicket').textContent = items[1007]?.quantity || 0;
            
            // æ›´æ–°èº«ä»½ç‰Œ
            updateIdentityCard(roleInfo);
            
            // æ›´æ–°æ­¦å°†åˆ—è¡¨
            updateHeroSelect(roleInfo);
        }
        
        // ==================== èº«ä»½ç‰Œç›¸å…³ ====================
        function formatNumber(num) {
            const n = Number(num || 0);
            const yi = 100_000_000;
            const wan = 10_000;
            if (n >= yi) return (n / yi).toFixed(1) + "äº¿";
            if (n >= wan) return (n / wan).toFixed(1) + "ä¸‡";
            return n.toLocaleString();
        }
        
        function getRankInfo(power) {
            const p = Number(power || 0);
            return powerRanks.find(r => p >= r.min && p < r.max) || powerRanks[0];
        }
        
        function updateIdentityCard(roleInfo) {
            if (!roleInfo || !roleInfo.role) {
                document.getElementById('identityCard').style.display = 'none';
                return;
            }
            
            const role = roleInfo.role;
            const items = role.items || {};
            
            // æ˜¾ç¤ºèº«ä»½ç‰Œ
            document.getElementById('identityCard').style.display = 'block';
            
            // æ›´æ–°è§’è‰²ä¿¡æ¯
            document.getElementById('roleName').textContent = role.name || 'æœªçŸ¥è§’è‰²';
            document.getElementById('roleLevel').textContent = role.level || 1;
            document.getElementById('rolePower').textContent = formatNumber(role.power || role.fighting || 0);
            
            // å¤´åƒ
            const avatar = document.getElementById('roleAvatar');
            if (role.headImg) {
                avatar.src = role.headImg;
            } else {
                avatar.src = 'icons/default-avatar.png';
            }
            avatar.onerror = function() { this.src = 'icons/default-avatar.png'; };
            
            // æˆ˜åŠ›ç­‰çº§
            const rank = getRankInfo(role.power || role.fighting || 0);
            document.getElementById('rankIcon').textContent = rank.icon;
            document.getElementById('rankTitle').textContent = rank.title;
            
            // æ›´æ–°è§’è‰²åŒºåŸŸèƒŒæ™¯
            const roleProfile = document.getElementById('roleProfile');
            roleProfile.className = 'role-profile ' + rank.class;
            
            // æ„å»ºèµ„æºåˆ—è¡¨
            const resources = [];
            
            // é‡‘å¸å’Œé‡‘ç –
            resources.push({ label: 'é‡‘å¸', value: formatNumber(role.gold || 0), raw: role.gold || 0 });
            resources.push({ label: 'é‡‘ç –', value: formatNumber(role.diamond || 0), raw: role.diamond || 0 });
            
            // ä»itemsè·å–å…¶ä»–èµ„æº
            resourceMap.forEach(res => {
                if (typeof res.id === 'number') {
                    const item = items[res.id];
                    const qty = item?.quantity || 0;
                    resources.push({ label: res.label, value: formatNumber(qty), raw: qty });
                }
            });
            
            // æ’åºï¼šéé›¶åœ¨å‰
            resources.sort((a, b) => (b.raw > 0 ? 1 : 0) - (a.raw > 0 ? 1 : 0));
            
            // æ¸²æŸ“èµ„æºç½‘æ ¼
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = resources.map(r => `
                <div class="res-item">
                    <span class="label">${r.label}</span>
                    <span class="value">${r.value}</span>
                </div>
            `).join('');
        }
        
        function toggleResources() {
            resourcesExpanded = !resourcesExpanded;
            const grid = document.getElementById('resourcesGrid');
            const btn = document.getElementById('toggleResourcesBtn');
            
            if (resourcesExpanded) {
                grid.classList.add('expanded');
                btn.textContent = 'æ”¶èµ·';
            } else {
                grid.classList.remove('expanded');
                btn.textContent = 'å±•å¼€å…¨éƒ¨';
            }
        }

        // ==================== è¿æ¥ç®¡ç† ====================
        async function connectAccount() {
            const select = document.getElementById('accountSelect');
            const accountName = select.value;
            if (!accountName) {
                showToast('è¯·å…ˆé€‰æ‹©è´¦å·', 'warning');
                return;
            }
            
            currentAccount = tokens.find(t => t.name === accountName);
            if (!currentAccount) {
                showToast('è´¦å·ä¸å­˜åœ¨', 'error');
                return;
            }
            
            updateConnectionStatus('connecting');
            
            try {
                const res = await fetch('/api/tools/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: accountName })
                });
                
                const data = await res.json();
                if (data.success) {
                    isConnected = true;
                    roleInfo = data.roleInfo;
                    updateConnectionStatus('connected');
                    updateItemCounts(roleInfo);
                    showToast('è¿æ¥æˆåŠŸ', 'success');
                    // åŠ è½½æ´»åŠ¨ä¿¡æ¯
                    loadActivityInfo();
                } else {
                    updateConnectionStatus('disconnected');
                    showToast('è¿æ¥å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                updateConnectionStatus('disconnected');
                showToast('è¿æ¥å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function disconnectAccount() {
            if (!currentAccount) return;
            
            try {
                await fetch('/api/tools/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name })
                });
            } catch (e) {}
            
            isConnected = false;
            currentAccount = null;
            roleInfo = null;
            updateConnectionStatus('disconnected');
            
            // éšè—èº«ä»½ç‰Œ
            document.getElementById('identityCard').style.display = 'none';
            
            showToast('å·²æ–­å¼€è¿æ¥', 'info');
        }
        
        function updateConnectionStatus(status) {
            const badge = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            badge.className = 'status-badge ' + status;
            
            if (status === 'connected') {
                badge.innerHTML = '<div class="status-dot"></div><span>å·²è¿æ¥</span>';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
            } else if (status === 'connecting') {
                badge.innerHTML = '<div class="status-dot"></div><span>è¿æ¥ä¸­...</span>';
                connectBtn.disabled = true;
            } else {
                badge.innerHTML = '<div class="status-dot"></div><span>æœªè¿æ¥</span>';
                connectBtn.style.display = 'inline-block';
                connectBtn.disabled = false;
                disconnectBtn.style.display = 'none';
            }
        }
        
        function updateTaskStatus(taskId, isRunning) {
            const badge = document.getElementById(taskId + 'Status');
            if (!badge) return;
            
            if (isRunning) {
                badge.className = 'status-badge active';
                badge.innerHTML = '<div class="status-dot"></div><span>è¿è¡Œä¸­</span>';
            } else {
                badge.className = 'status-badge';
                badge.innerHTML = '<div class="status-dot"></div><span>å·²åœæ­¢</span>';
            }
        }

        // ==================== å·¥å…·æ“ä½œ ====================
        async function openBoxes() {
            if (!checkConnection()) return;
            
            const boxType = parseInt(document.getElementById('boxType').value);
            const boxCount = parseInt(document.getElementById('boxCount').value);
            
            updateTaskStatus('box', true);
            showToast('å¼€å§‹å¼€å¯å®ç®±...', 'info');
            
            try {
                const res = await fetch('/api/tools/openbox', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        boxType: boxType,
                        count: boxCount
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('å®ç®±å¼€å¯å®Œæˆï¼', 'success');
                } else {
                    showToast('å¼€å¯å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('å¼€å¯å¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('box', false);
            }
        }
        
        async function claimBoxPoints() {
            if (!checkConnection()) return;
            
            try {
                const res = await fetch('/api/tools/claimboxpoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('ç§¯åˆ†é¢†å–æˆåŠŸï¼', 'success');
                } else {
                    showToast('é¢†å–å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('é¢†å–å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function startFishing() {
            if (!checkConnection()) return;
            
            const fishType = parseInt(document.getElementById('fishType').value);
            const fishCount = parseInt(document.getElementById('fishCount').value);
            
            updateTaskStatus('fish', true);
            showToast('å¼€å§‹é’“é±¼...', 'info');
            
            try {
                const res = await fetch('/api/tools/fish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        fishType: fishType,
                        count: fishCount
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('é’“é±¼å®Œæˆï¼', 'success');
                } else {
                    showToast('é’“é±¼å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('é’“é±¼å¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('fish', false);
            }
        }
        
        async function startRecruit() {
            if (!checkConnection()) return;
            
            const recruitCount = parseInt(document.getElementById('recruitCount').value);
            
            updateTaskStatus('recruit', true);
            showToast('å¼€å§‹æ‹›å‹Ÿ...', 'info');
            
            try {
                const res = await fetch('/api/tools/recruit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        recruitType: 1,
                        count: recruitCount
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('æ‹›å‹Ÿå®Œæˆï¼', 'success');
                } else {
                    showToast('æ‹›å‹Ÿå¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('æ‹›å‹Ÿå¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('recruit', false);
            }
        }
        
        // ==================== æ¶ˆè€—æ´»åŠ¨è¿›åº¦ ====================
        const activityTasks = {
            1: { name: 'æ‹›å‹Ÿ', targets: [80,160,240,320,400,560,720,880,1040,1200,1440,1680,1920,2160,2400,2720,3040,3360,3680,4000] },
            2: { name: 'å®ç®±', targets: [2000,4000,6000,8000,10000,14000,18000,22000,26000,30000,36000,42000,48000,54000,60000,68000,76000,84000,92000,100000] },
            3: { name: 'æ•è·', targets: [25,50,75,125,175,225,300,375,450,525,625,725,825,925,1050,1175,1300,1450,1600,1750] },
            4: { name: 'ç›ç½', targets: [3,6,9,12,15,18,21,24,27,30,33,36,39,42,45,48,51,54,57,60] },
            5: { name: 'é‡‘ç –', targets: [10000,20000,30000,40000,50000,70000,90000,110000,130000,150000,180000,210000,240000,270000,300000,340000,380000,420000,460000,500000] }
        };
        
        function updateActivityProgress(activityInfo) {
            if (!activityInfo) return;
            
            // æŸ¥æ‰¾æ¶ˆè€—æ´»åŠ¨æ•°æ®
            let taskData = null;
            const activities = activityInfo.commonActivityInfo || activityInfo.activity?.commonActivityInfo || {};
            for (const activity of Object.values(activities)) {
                if (activity?.task) {
                    const hasValidTask = Object.keys(activity.task).some(k => Number(k) >= 1 && Number(k) <= 5);
                    if (hasValidTask) {
                        taskData = activity.task;
                        break;
                    }
                }
            }
            
            if (!taskData) return;
            
            // æ›´æ–°å„é¡¹è¿›åº¦
            const progressMap = {
                1: { text: 'progressRecruit', bar: 'progressRecruitBar', footer: 'progressRecruitFooter' },
                2: { text: 'progressBox', bar: 'progressBoxBar', footer: 'progressBoxFooter' },
                3: { text: 'progressCapture', bar: 'progressCaptureBar', footer: 'progressCaptureFooter' },
                4: { text: 'progressBottle', bar: 'progressBottleBar', footer: 'progressBottleFooter' },
                5: { text: 'progressDiamond', bar: 'progressDiamondBar', footer: 'progressDiamondFooter' }
            };
            
            for (const [id, config] of Object.entries(activityTasks)) {
                const current = taskData[id] || 0;
                const targets = config.targets;
                const nextTarget = targets.find(t => t > current) || targets[targets.length - 1];
                const isCompleted = current >= targets[targets.length - 1];
                const percentage = isCompleted ? 100 : Math.min(100, (current / nextTarget) * 100);
                
                const els = progressMap[id];
                document.getElementById(els.text).textContent = current + '/' + nextTarget;
                document.getElementById(els.bar).style.width = percentage + '%';
                
                const footer = document.getElementById(els.footer);
                if (isCompleted) {
                    footer.textContent = 'å·²å®Œæˆæ‰€æœ‰æ¡£ä½';
                    footer.classList.add('completed');
                } else {
                    footer.textContent = 'ä¸‹ä¸€æ¡£: ' + nextTarget + ' (è¿˜éœ€ ' + (nextTarget - current) + ')';
                    footer.classList.remove('completed');
                }
            }
        }
        
        async function openActivityItem() {
            if (!checkConnection()) return;
            
            const count = parseInt(document.getElementById('activityCount').value);
            showToast('æ‰“å¼€æ´»åŠ¨é“å…·...', 'info');
            
            try {
                const res = await fetch('/api/tools/openactivityitem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name, count })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('é“å…·å¼€å¯å®Œæ¯•ï¼', 'success');
                    // åˆ·æ–°æ´»åŠ¨è¿›åº¦
                    loadActivityInfo();
                } else {
                    showToast('å¼€å¯å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('å¼€å¯å¤±è´¥: ' + e.message, 'error');
            }
        }
        
        async function loadActivityInfo() {
            if (!isConnected || !currentAccount) return;
            
            try {
                const res = await fetch('/api/tools/getactivityinfo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name })
                });
                
                const data = await res.json();
                if (data.success && data.activityInfo) {
                    updateActivityProgress(data.activityInfo);
                }
            } catch (e) {
                console.error('è·å–æ´»åŠ¨ä¿¡æ¯å¤±è´¥:', e);
            }
        }
        
        // ==================== å‡æ˜ŸåŠ©æ‰‹ ====================
        let starTaskRunning = false;
        let starStopRequested = false;
        
        async function startHeroUpgrade() {
            if (!checkConnection()) return;
            if (starTaskRunning) { showToast('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­', 'warning'); return; }
            
            const delay = parseInt(document.getElementById('starDelay').value);
            starTaskRunning = true;
            starStopRequested = false;
            updateTaskStatus('star', true);
            document.getElementById('stopStarBtn').disabled = false;
            
            showToast('å¼€å§‹è‹±é›„å‡æ˜Ÿ...', 'info');
            
            try {
                const res = await fetch('/api/tools/heroupgradestar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name, delay })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    document.getElementById('starProgressText').textContent = data.done + '/' + data.total + ' 100%';
                    document.getElementById('starProgressBar').style.width = '100%';
                    showToast('è‹±é›„å‡æ˜Ÿå®Œæˆï¼', 'success');
                } else {
                    showToast('å‡æ˜Ÿå¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('å‡æ˜Ÿå¤±è´¥: ' + e.message, 'error');
            } finally {
                starTaskRunning = false;
                updateTaskStatus('star', false);
                document.getElementById('stopStarBtn').disabled = true;
            }
        }
        
        async function startBookUpgrade() {
            if (!checkConnection()) return;
            if (starTaskRunning) { showToast('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­', 'warning'); return; }
            
            const delay = parseInt(document.getElementById('starDelay').value);
            starTaskRunning = true;
            starStopRequested = false;
            updateTaskStatus('star', true);
            document.getElementById('stopStarBtn').disabled = false;
            
            showToast('å¼€å§‹å›¾é‰´å‡æ˜Ÿ...', 'info');
            
            try {
                const res = await fetch('/api/tools/bookupgrade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name, delay })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    document.getElementById('starProgressText').textContent = data.done + '/' + data.total + ' 100%';
                    document.getElementById('starProgressBar').style.width = '100%';
                    showToast('å›¾é‰´å‡æ˜Ÿå®Œæˆï¼', 'success');
                } else {
                    showToast('å›¾é‰´å‡æ˜Ÿå¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('å›¾é‰´å‡æ˜Ÿå¤±è´¥: ' + e.message, 'error');
            } finally {
                starTaskRunning = false;
                updateTaskStatus('star', false);
                document.getElementById('stopStarBtn').disabled = true;
            }
        }
        
        async function startClaimRewards() {
            if (!checkConnection()) return;
            if (starTaskRunning) { showToast('ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­', 'warning'); return; }
            
            starTaskRunning = true;
            updateTaskStatus('star', true);
            
            showToast('å¼€å§‹é¢†å–å¥–åŠ±...', 'info');
            
            try {
                const res = await fetch('/api/tools/claimbookreward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountName: currentAccount.name })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('é¢†å–å¥–åŠ±å®Œæˆï¼', 'success');
                } else {
                    showToast('é¢†å–å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('é¢†å–å¤±è´¥: ' + e.message, 'error');
            } finally {
                starTaskRunning = false;
                updateTaskStatus('star', false);
            }
        }
        
        function stopStarTask() {
            starStopRequested = true;
            showToast('æ­£åœ¨åœæ­¢...', 'info');
        }
        
        // ==================== æ­¦å°†å‡çº§ ====================
        const HERO_DICT = {
            101:{name:'å…³ç¾½',avatar:''},102:{name:'å¼ é£',avatar:''},103:{name:'èµµäº‘',avatar:''},104:{name:'é©¬è¶…',avatar:''},105:{name:'é»„å¿ ',avatar:''},
            106:{name:'é­å»¶',avatar:''},107:{name:'å§œç»´',avatar:''},108:{name:'è¯¸è‘›äº®',avatar:''},109:{name:'åºç»Ÿ',avatar:''},110:{name:'å¾åº¶',avatar:''},
            111:{name:'æ³•æ­£',avatar:''},112:{name:'åˆ˜å¤‡',avatar:''},113:{name:'å¼ æ˜Ÿå½©',avatar:''},114:{name:'å…³é“¶å±',avatar:''},115:{name:'å¤ä¾¯æ°',avatar:''},
            116:{name:'å­™å°šé¦™',avatar:''},117:{name:'é»„æœˆè‹±',avatar:''},118:{name:'ç¥è',avatar:''},119:{name:'è²‚è‰',avatar:''},120:{name:'å¤§ä¹”',avatar:''},
            201:{name:'å¼ è¾½',avatar:''},202:{name:'å¾æ™ƒ',avatar:''},203:{name:'å¤ä¾¯æƒ‡',avatar:''},204:{name:'å¤ä¾¯æ¸Š',avatar:''},205:{name:'è®¸è¤š',avatar:''},
            206:{name:'å…¸éŸ¦',avatar:''},207:{name:'åºå¾·',avatar:''},208:{name:'å¸é©¬æ‡¿',avatar:''},209:{name:'éƒ­å˜‰',avatar:''},210:{name:'è´¾è¯©',avatar:''},
            211:{name:'è€å½§',avatar:''},212:{name:'ç¨‹æ˜±',avatar:''},213:{name:'æ›¹æ“',avatar:''},214:{name:'æ›¹ä¸•',avatar:''},215:{name:'æ›¹æ¤',avatar:''},
            216:{name:'æ›¹ä»',avatar:''},217:{name:'æ›¹æ´ª',avatar:''},218:{name:'äºç¦',avatar:''},219:{name:'ä¹è¿›',avatar:''},220:{name:'æå…¸',avatar:''},
            221:{name:'å¼ éƒƒ',avatar:''},222:{name:'ç”„å§¬',avatar:''},223:{name:'è”¡æ–‡å§¬',avatar:''},224:{name:'ç‹å¼‚',avatar:''},225:{name:'å¼ æ˜¥å',avatar:''},
            226:{name:'é‚¹æ°',avatar:''},227:{name:'å°ä¹”',avatar:''},228:{name:'æ­¥ç»ƒå¸ˆ',avatar:''},
            301:{name:'å‘¨ç‘œ',avatar:''},302:{name:'é™†é€Š',avatar:''},303:{name:'å•è’™',avatar:''},304:{name:'å¤ªå²æ…ˆ',avatar:''},305:{name:'ç”˜å®',avatar:''},
            306:{name:'å‡Œç»Ÿ',avatar:''},307:{name:'é»„ç›–',avatar:''},308:{name:'å­™ç­–',avatar:''},309:{name:'å­™æƒ',avatar:''},310:{name:'å­™åš',avatar:''},
            311:{name:'é²è‚ƒ',avatar:''},312:{name:'è¯¸è‘›ç‘¾',avatar:''},313:{name:'å‘¨æ³°',avatar:''},314:{name:'ä¸å¥‰',avatar:''}
        };
        
        let selectedHero = null;
        
        function updateHeroSelect(roleInfo) {
            if (!roleInfo || !roleInfo.role || !roleInfo.role.heroes) return;
            
            const heroes = roleInfo.role.heroes;
            const select = document.getElementById('heroSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ­¦å°† --</option>';
            
            for (const [heroId, hero] of Object.entries(heroes)) {
                const heroInfo = HERO_DICT[heroId];
                if (!heroInfo) continue;
                
                const opt = document.createElement('option');
                opt.value = heroId;
                opt.textContent = heroInfo.name + ' (Lv.' + hero.level + ')';
                opt.disabled = hero.level >= 6000;
                select.appendChild(opt);
            }
        }
        
        function onHeroSelect() {
            const heroId = document.getElementById('heroSelect').value;
            const panel = document.getElementById('heroDetailPanel');
            
            if (!heroId || !roleInfo || !roleInfo.role || !roleInfo.role.heroes) {
                panel.style.display = 'none';
                selectedHero = null;
                return;
            }
            
            const hero = roleInfo.role.heroes[heroId];
            const heroInfo = HERO_DICT[heroId];
            
            if (!hero || !heroInfo) {
                panel.style.display = 'none';
                selectedHero = null;
                return;
            }
            
            selectedHero = { ...hero, heroId: parseInt(heroId), ...heroInfo };
            
            document.getElementById('heroDetailAvatar').src = heroInfo.avatar || 'icons/default-avatar.png';
            document.getElementById('heroAttack').textContent = hero.attack || 0;
            document.getElementById('heroSpeed').textContent = hero.speed || 0;
            panel.style.display = 'block';
        }
        
        // è¿›é˜¶ç­‰çº§è¡¨
        const levelArr = [
            {level:100,order:1},{level:200,order:2},{level:300,order:3},{level:500,order:4},{level:700,order:5},
            {level:900,order:6},{level:1100,order:7},{level:1300,order:8},{level:1500,order:9},{level:1800,order:10},
            {level:2100,order:11},{level:2400,order:12},{level:2800,order:13},{level:3200,order:14},{level:3600,order:15},
            {level:4000,order:16},{level:4500,order:17},{level:5000,order:18},{level:5500,order:19}
        ];
        
        function judgeLevelUpgrade(level, levelNum, order) {
            for (const item of levelArr) {
                if (order != item.order && level <= item.level && item.level < (level + levelNum)) {
                    return item.level;
                }
            }
            return false;
        }
        
        async function levelHeroUpgrade() {
            if (!checkConnection()) return;
            if (!selectedHero) { showToast('è¯·å…ˆé€‰æ‹©æ­¦å°†', 'warning'); return; }
            
            const levelNum = parseInt(document.getElementById('heroLevelNum').value);
            const judgement = judgeLevelUpgrade(selectedHero.level, levelNum, selectedHero.order);
            
            if (judgement !== false) {
                showToast('è¯·æ‰‹åŠ¨å‡çº§åˆ°' + judgement + 'çº§ï¼Œç„¶åè¿›è¡Œè¿›é˜¶', 'warning');
                return;
            }
            
            updateTaskStatus('heroUpgrade', true);
            showToast('å‡çº§ä¸­...', 'info');
            
            try {
                const res = await fetch('/api/tools/heroupgradelevel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        heroId: selectedHero.heroId,
                        upgradeNum: levelNum
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    roleInfo = data.roleInfo;
                    updateItemCounts(data.roleInfo);
                    updateHeroSelect(data.roleInfo);
                    onHeroSelect();
                    showToast('å‡çº§æˆåŠŸï¼', 'success');
                } else {
                    showToast('å‡çº§å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('å‡çº§å¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('heroUpgrade', false);
            }
        }
        
        async function orderHeroUpgrade() {
            if (!checkConnection()) return;
            if (!selectedHero) { showToast('è¯·å…ˆé€‰æ‹©æ­¦å°†', 'warning'); return; }
            
            updateTaskStatus('heroUpgrade', true);
            showToast('è¿›é˜¶ä¸­...', 'info');
            
            try {
                const res = await fetch('/api/tools/heroupgradeorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        heroId: selectedHero.heroId
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    roleInfo = data.roleInfo;
                    updateItemCounts(data.roleInfo);
                    updateHeroSelect(data.roleInfo);
                    onHeroSelect();
                    showToast('è¿›é˜¶æˆåŠŸï¼', 'success');
                } else {
                    showToast('è¿›é˜¶å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('è¿›é˜¶å¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('heroUpgrade', false);
            }
        }
        
        // ==================== ç«æŠ€åœºåŠ©æ‰‹ ====================
        async function startArenaFight() {
            if (!checkConnection()) return;
            
            const count = parseInt(document.getElementById('arenaCount').value);
            const ticketCount = parseInt(document.getElementById('arenaTicket').textContent) || 0;
            
            if (ticketCount < count) {
                showToast('å’¸ç¥é—¨ç¥¨ä¸è¶³ä»¥å®Œæˆè¯¥æˆ˜æ–—æ¬¡æ•°', 'warning');
                return;
            }
            
            updateTaskStatus('arena', true);
            showToast('ç«æŠ€åœºæˆ˜æ–—ä¸­...', 'info');
            
            try {
                const res = await fetch('/api/tools/arenafight', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountName: currentAccount.name,
                        count: count
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    if (data.roleInfo) updateItemCounts(data.roleInfo);
                    showToast('ç«æŠ€åœºæˆ˜æ–—å®Œæ¯•ï¼æˆåŠŸ' + (data.successCount || 0) + 'æ¬¡', 'success');
                } else {
                    showToast('æˆ˜æ–—å¤±è´¥: ' + data.error, 'error');
                }
            } catch (e) {
                showToast('æˆ˜æ–—å¤±è´¥: ' + e.message, 'error');
            } finally {
                updateTaskStatus('arena', false);
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        function checkConnection() {
            if (!isConnected || !currentAccount) {
                showToast('è¯·å…ˆè¿æ¥è´¦å·', 'warning');
                return false;
            }
            return true;
        }
        
        // ==================== å¯åŠ¨ ====================
        init();
    </script>
</body>
</html>
