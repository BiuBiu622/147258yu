// ==UserScript==
// @name         æ¢¦å¢ƒ
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  æ¢¦å¢ƒç³»ç»Ÿï¼šæˆ˜æ–—ä¸è´­ä¹°ä¸€ä½“åŒ–åŠ©æ‰‹
// @author       å°å¡æ‹‰ç±³
// @match        *://xxz-xyzw-res.hortorgames.com/h5web/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_setClipboard
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    // ==================== å…¨å±€é…ç½® ====================
    const globalConfig = {
        ui: {
            colors: {
                primary: '#8b5cf6',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#06b6d4',
                dark: '#1e293b',
                lightDark: '#334155',
                text: '#f8fafc',
                textLight: '#94a3b8',
                border: 'rgba(148, 163, 184, 0.3)',
                gold: '#ffa500',
                fishingRod: '#ffd700',
                other: '#00ffff'
            },
            shadows: {
                btn: '0 2px 4px rgba(0,0,0,0.2)',
                tip: '0 3px 8px rgba(0,0,0,0.15)',
                panel: '0 6px 15px rgba(0,0,0,0.2)'
            },
            zIndex: {
                panel: 99999,
                toggleBtn: 100000
            },
            baseWidth: 380,
            mobileWidth: '95vw',
            maxMobileWidth: 400,
            defaultOpacity: 0.95
        },
        position: {
            toggleBtn: { top: '60%', left: '5px', transform: 'translateY(-50%)' },
            panel: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }
        },
        isPanelVisible: false,
        isMobile: false,
        currentTab: 'battle' // battle, buy
    };

    // ==================== è‹±é›„æ•°æ®æ˜ å°„ ====================
    const heroData = {
        "101": { name: "å¸é©¬æ‡¿", type: "é­å›½" },
        "102": { name: "éƒ­å˜‰", type: "é­å›½" },
        "103": { name: "å…³ç¾½", type: "èœ€å›½" },
        "104": { name: "è¯¸è‘›äº®", type: "èœ€å›½" },
        "105": { name: "å‘¨ç‘œ", type: "å´å›½" },
        "106": { name: "å¤ªå²æ…ˆ", type: "å´å›½" },
        "107": { name: "å•å¸ƒ", type: "ç¾¤é›„" },
        "108": { name: "åä½—", type: "ç¾¤é›„" },
        "109": { name: "ç”„å§¬", type: "é­å›½" },
        "110": { name: "é»„æœˆè‹±", type: "èœ€å›½" },
        "111": { name: "å­™ç­–", type: "å´å›½" },
        "112": { name: "è´¾è¯©", type: "ç¾¤é›„" },
        "113": { name: "æ›¹ä»", type: "é­å›½" },
        "114": { name: "å§œç»´", type: "èœ€å›½" },
        "115": { name: "å­™åš", type: "å´å›½" },
        "116": { name: "å…¬å­™ç“’", type: "ç¾¤é›„" },
        "117": { name: "å…¸éŸ¦", type: "é­å›½" },
        "118": { name: "èµµäº‘", type: "èœ€å›½" },
        "119": { name: "å¤§ä¹”", type: "å´å›½" },
        "120": { name: "å¼ è§’", type: "ç¾¤é›„" }
    };

    // ==================== å•†äººé…ç½® ====================
    const merchantConfig = {
        1: { name: 'åˆçº§å•†äºº', items: ['è¿›é˜¶çŸ³', 'ç²¾é“', 'æœ¨è´¨å®ç®±', 'é’é“œå®ç®±', 'æ™®é€šé±¼ç«¿', 'æŒ‘æˆ˜ç¥¨', 'å’¸ç¥ç«æŠŠ'] },
        2: { name: 'ä¸­çº§å•†äºº', items: ['æ¢¦é­‡æ™¶çŸ³', 'è¿›é˜¶çŸ³', 'ç²¾é“', 'é»„é‡‘å®ç®±', 'é»„é‡‘é±¼ç«¿', 'æ‹›å‹Ÿä»¤', 'æ©™å°†ç¢ç‰‡', 'ç´«å°†ç¢ç‰‡'] },
        3: { name: 'é«˜çº§å•†äºº', items: ['æ¢¦é­‡æ™¶çŸ³', 'é“‚é‡‘å®ç®±', 'é»„é‡‘é±¼ç«¿', 'æ‹›å‹Ÿä»¤', 'çº¢å°†ç¢ç‰‡', 'æ©™å°†ç¢ç‰‡', 'çº¢å°†ç¢ç‰‡'] }
    };

    // é‡‘å¸è´­ä¹°çš„å•†å“é…ç½® [å•†äººID][å•†å“ç´¢å¼•]
    const goldItemsConfig = {
        1: [5, 6], // åˆçº§å•†äºº: æŒ‘æˆ˜ç¥¨, å’¸ç¥ç«æŠŠ
        2: [6, 7], // ä¸­çº§å•†äºº: æ©™å°†ç¢ç‰‡, ç´«å°†ç¢ç‰‡
        3: [5, 6]  // é«˜çº§å•†äºº: æ©™å°†ç¢ç‰‡, çº¢å°†ç¢ç‰‡(ç¬¬äºŒä¸ª)
    };

    // ==================== å…¨å±€çŠ¶æ€ ====================
    let globalState = {
        // æˆ˜æ–—æ¨¡å—çŠ¶æ€
        battle: {
            isLoading: false,
            defaultTeam: null,
            currentTeamHeroes: [],
            hasDefaultInfo: false,
            continuousBattles: {},
            battleInterval: null
        },
        // è´­ä¹°æ¨¡å—çŠ¶æ€
        buy: {
            merchantData: { 1: [], 2: [], 3: [] },
            levelId: 0,
            selectedItems: new Set(),
            isRunning: false
        },
        // WebSocketçŠ¶æ€
        wsConnected: false
    };

    // ==================== å·¥å…·å‡½æ•° ====================

    // æ£€æŸ¥æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰
    function isDungeonOpen() {
        const now = new Date();
        const day = now.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€, 2=å‘¨äºŒ, 3=å‘¨ä¸‰, 4=å‘¨å››, 5=å‘¨äº”, 6=å‘¨å…­
        return day === 0 || day === 1 || day === 3 || day === 4; // å‘¨æ—¥ã€å‘¨ä¸€ã€å‘¨ä¸‰ã€å‘¨å››
    }

    function showTip(text, type = 'info') {
        const tip = document.createElement('div');
        tip.textContent = text;
        let bg = globalConfig.ui.colors.primary;
        if (type === 'success') bg = globalConfig.ui.colors.success;
        if (type === 'error') bg = globalConfig.ui.colors.error;
        if (type === 'warning') bg = globalConfig.ui.colors.warning;
        if (type === 'info') bg = globalConfig.ui.colors.info;
        
        tip.style.cssText = `
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: ${bg}; color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 13px; z-index: ${globalConfig.ui.zIndex.toggleBtn + 1}; 
            box-shadow: ${globalConfig.ui.shadows.tip}; white-space: nowrap; 
            opacity: 0; transition: opacity 0.3s ease; max-width: 80vw;
        `;
        document.body.appendChild(tip);
        setTimeout(() => tip.style.opacity = '1', 10);
        setTimeout(() => { tip.style.opacity = '0'; setTimeout(() => tip.remove(), 300); }, 2000);
    }

    function delay(seconds) {
        return new Promise(resolve => setTimeout(resolve, seconds * 1000));
    }

    // ==================== WebSocketé€šä¿¡å‡½æ•° ====================

    async function waitForWebSocketConnection(maxWaitTime = 15000) {
        return new Promise((resolve, reject) => {
            const gameWS = window.ws || (window.h5websocket && window.h5websocket.ws) || (window.game && window.game.ws);
            if (gameWS && (typeof gameWS.send === 'function' || typeof gameWS.sendAsync === 'function')) {
                globalState.wsConnected = true;
                resolve(true);
                return;
            }

            const startTime = Date.now();
            const checkInterval = 200;

            const checkConnection = () => {
                const gameWS = window.ws || (window.h5websocket && window.h5websocket.ws) || (window.game && window.game.ws);
                if (gameWS && (typeof gameWS.send === 'function' || typeof gameWS.sendAsync === 'function')) {
                    globalState.wsConnected = true;
                    resolve(true);
                    return;
                }

                const elapsedTime = Date.now() - startTime;
                if (elapsedTime >= maxWaitTime) {
                    reject(new Error('WebSocketè¿æ¥ç­‰å¾…è¶…æ—¶'));
                    return;
                }

                setTimeout(checkConnection, checkInterval);
            };

            checkConnection();
        });
    }

    async function sendCommand(cmd, params = {}) {
        try {
            await waitForWebSocketConnection();
            
            const gameWS = window.ws || (window.h5websocket && window.h5websocket.ws) || (window.game && window.game.ws);
            if (!gameWS || !(typeof gameWS.send === 'function' || typeof gameWS.sendAsync === 'function')) {
                throw new Error('WebSocketè¿æ¥ä¸å¯ç”¨');
            }

            const message = {
                ack: 0,
                cmd,
                params,
                seq: Date.now(),
                time: Date.now()
            };
            
            let response;
            if (typeof gameWS.sendAsync === 'function') {
                response = await gameWS.sendAsync(message);
            } else {
                response = await new Promise((resolve, reject) => {
                    const originalOnMessage = gameWS.onmessage;
                    gameWS.onmessage = function(event) {
                        try {
                            const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                            if (data.seq === message.seq) {
                                gameWS.onmessage = originalOnMessage;
                                resolve(data);
                            }
                        } catch (e) {
                            reject(e);
                        }
                    };
                    gameWS.send(JSON.stringify(message));
                    
                    setTimeout(() => {
                        gameWS.onmessage = originalOnMessage;
                        reject(new Error('å‘½ä»¤å“åº”è¶…æ—¶'));
                    }, 5000);
                });
            }
            
            if (response?.code === 0 || response?.body?.["0"] === 8) {
                return response;
            } else {
                const errorCode = response?.code || response?.body?.["0"];
                throw new Error(`å‘½ä»¤å¤±è´¥ï¼Œé”™è¯¯ç : ${errorCode}`);
            }
            
        } catch (error) {
            throw error;
        }
    }

    // ==================== æ—¥å¿—ç³»ç»Ÿ ====================

    function logMessage(content, type = 'info') {
        const logContainer = document.getElementById('dreamLogContainer');
        if (!logContainer) return;
        
        const logItem = document.createElement('div');
        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        logItem.textContent = `[${time}] ${content}`;
        
        let color = globalConfig.ui.colors.text;
        if (type === 'success') color = globalConfig.ui.colors.success;
        if (type === 'error') color = globalConfig.ui.colors.error;
        if (type === 'warning') color = globalConfig.ui.colors.warning;
        if (type === 'info') color = globalConfig.ui.colors.info;
        
        logItem.style.cssText = `
            margin: 1px 0; padding: 3px 5px; border-radius: 3px; color: ${color};
            font-size: 11px; line-height: 1.3; 
            font-family: 'Consolas', monospace; word-wrap: break-word; 
            white-space: normal;
        `;
        
        logContainer.appendChild(logItem);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        console.log(`[æ¢¦å¢ƒç³»ç»Ÿ] ${content}`);
    }

    // ==================== æ¢¦å¢ƒæˆ˜æ–—æ¨¡å— ====================

    // æå–é»˜è®¤é˜Ÿä¼ä¿¡æ¯
    function extractDefaultInfoFromResponse(response) {
        try {
            if (!response) {
                return false;
            }

            let extracted = false;

            if (response._rawData && response._rawData.role && response._rawData.role.battleTeam) {
                globalState.battle.defaultTeam = response._rawData.role.battleTeam;
                
                // æå–è‹±é›„ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                globalState.battle.currentTeamHeroes = [];
                for (let i = 0; i < 5; i++) {
                    const heroKey = i.toString();
                    if (globalState.battle.defaultTeam[heroKey]) {
                        const heroInfo = globalState.battle.defaultTeam[heroKey];
                        const heroId = heroInfo.heroId || heroInfo;
                        if (heroId !== 0 && heroData[heroId]) {
                            globalState.battle.currentTeamHeroes.push({
                                id: heroId,
                                name: heroData[heroId].name,
                                type: heroData[heroId].type,
                                position: i
                            });
                        }
                    }
                }
                
                logMessage('âœ… æå–åˆ°é»˜è®¤é˜Ÿä¼ä¿¡æ¯', 'success');
                extracted = true;
            }

            if (extracted) {
                globalState.battle.hasDefaultInfo = true;
            }

            return extracted;
        } catch (error) {
            logMessage(`âŒ æå–é»˜è®¤ä¿¡æ¯å‡ºé”™: ${error.message}`, 'error');
            return false;
        }
    }

    // è·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯
    async function getDefaultTeamInfo() {
        if (globalState.battle.isLoading) {
            showTip('æ“ä½œæ­£åœ¨è¿›è¡Œä¸­', 'warning');
            return false;
        }

        if (!isDungeonOpen()) {
            showTip('å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰', 'error');
            logMessage('âŒ å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´', 'error');
            return false;
        }

        globalState.battle.isLoading = true;
        updateButtonStates();
        
        logMessage('è·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯...', 'info');
        showTip('æ­£åœ¨è·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯...', 'info');

        try {
            const roleInfo = await sendCommand('role_getroleinfo', {});
            
            if (roleInfo) {
                const extracted = extractDefaultInfoFromResponse(roleInfo);
                if (extracted) {
                    logMessage('âœ… é»˜è®¤é˜Ÿä¼ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    showTip('é˜Ÿä¼ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                    updateTeamDisplay();
                    updateQuickActionButtons();
                    return true;
                } else {
                    logMessage('âŒ æ— æ³•æå–é˜Ÿä¼æ•°æ®', 'error');
                    showTip('è·å–é˜Ÿä¼ä¿¡æ¯å¤±è´¥', 'error');
                    return false;
                }
            } else {
                logMessage('âŒ è·å–è§’è‰²ä¿¡æ¯å¤±è´¥', 'error');
                showTip('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥', 'error');
                return false;
            }
        } catch (error) {
            logMessage(`âŒ è·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯å‡ºé”™: ${error.message}`, 'error');
            showTip('è·å–é˜Ÿä¼ä¿¡æ¯å¤±è´¥', 'error');
            return false;
        } finally {
            globalState.battle.isLoading = false;
            updateButtonStates();
        }
    }

    // é€‰æ‹©æ¢¦å¢ƒé˜µå®¹
    async function selectDreamTeam() {
        if (globalState.battle.isLoading) {
            showTip('æ“ä½œæ­£åœ¨è¿›è¡Œä¸­', 'warning');
            return;
        }

        if (!isDungeonOpen()) {
            showTip('å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰', 'error');
            logMessage('âŒ å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´', 'error');
            return;
        }

        if (!globalState.battle.hasDefaultInfo) {
            const success = await getDefaultTeamInfo();
            if (!success) {
                showTip('è¯·å…ˆè·å–é»˜è®¤é˜Ÿä¼', 'warning');
                return;
            }
        }

        globalState.battle.isLoading = true;
        updateButtonStates();
        
        logMessage('é€‰æ‹©æ¢¦å¢ƒé˜µå®¹...', 'info');
        showTip('æ­£åœ¨é€‰æ‹©æ¢¦å¢ƒé˜µå®¹...', 'info');

        try {
            // ä½¿ç”¨dungeon_selectheroå‘½ä»¤é€‰æ‹©é˜µå®¹
            const battleTeam = {};
            let hasHero = false;
            
            for (let i = 0; i < 5; i++) {
                if (globalState.battle.defaultTeam && globalState.battle.defaultTeam[i.toString()]) {
                    const heroInfo = globalState.battle.defaultTeam[i.toString()];
                    const heroId = heroInfo.heroId || heroInfo;
                    battleTeam[i.toString()] = heroId;
                    
                    if (heroId !== 0) {
                        hasHero = true;
                    }
                } else {
                    battleTeam[i.toString()] = 0;
                }
            }

            if (!hasHero) {
                logMessage('âš ï¸ é»˜è®¤é˜Ÿä¼ä¸­æ²¡æœ‰è‹±é›„', 'warning');
                showTip('é˜Ÿä¼ä¸­æ²¡æœ‰è‹±é›„', 'warning');
                return;
            }

            const response = await sendCommand('dungeon_selecthero', {
                battleTeam: battleTeam
            });
            
            if (response && (response.code === 0 || response.body?.["0"] === 8)) {
                logMessage(`âœ… æ¢¦å¢ƒé˜µå®¹é€‰æ‹©æˆåŠŸ`, 'success');
                showTip('æ¢¦å¢ƒé˜µå®¹é€‰æ‹©æˆåŠŸ', 'success');
                
                // è§£æå¥–åŠ±æ•°æ®
                const rawData = response._rawData;
                if (rawData && rawData.reward) {
                    const rewards = Array.isArray(rawData.reward) ? rawData.reward : [rawData.reward];
                    rewards.forEach(reward => {
                        if (reward.type === 3) { // ç‰©å“ç±»å‹
                            logMessage(`ğŸ è·å¾—ç‰©å“: ID=${reward.itemId}, æ•°é‡=${reward.value}`, 'success');
                        } else if (reward.type === 12) {
                            logMessage(`ğŸ“¦ è·å¾—ç‰¹æ®Šç‰©å“: ID=${reward.itemId}, æ•°é‡=${reward.value}`, 'success');
                        }
                    });
                }
                
            } else {
                throw new Error('é€‰æ‹©æ¢¦å¢ƒé˜µå®¹å¤±è´¥');
            }
            
        } catch (error) {
            logMessage(`âŒ é€‰æ‹©æ¢¦å¢ƒé˜µå®¹å‡ºé”™: ${error.message}`, 'error');
            showTip('é€‰æ‹©é˜µå®¹å¤±è´¥', 'error');
        } finally {
            globalState.battle.isLoading = false;
            updateButtonStates();
        }
    }

    // å•ä¸ªè‹±é›„æˆ˜æ–—
    async function startSingleBattle(heroId) {
        const heroName = heroData[heroId] ? heroData[heroId].name : `ID:${heroId}`;
        
        logMessage(`âš”ï¸ å¼€å§‹æˆ˜æ–—: ${heroName}`, 'info');

        try {
            const response = await sendCommand('fight_startdungeon', {
                heroId: parseInt(heroId)
            });
            
            if (response && (response.code === 0 || response.body?.["0"] === 8)) {
                // è§£ææˆ˜æ–—ç»“æœ
                const rawData = response._rawData;
                if (rawData) {
                    if (rawData.isWin) {
                        logMessage(`ğŸ‰ ${heroName} æˆ˜æ–—èƒœåˆ©!`, 'success');
                    } else {
                        logMessage(`ğŸ’” ${heroName} æˆ˜æ–—å¤±è´¥`, 'warning');
                    }
                    
                    // è§£æå¥–åŠ±
                    if (rawData.reward) {
                        const rewards = Array.isArray(rawData.reward) ? rawData.reward : [rawData.reward];
                        rewards.forEach(reward => {
                            if (reward.type === 3) {
                                logMessage(`ğŸ ${heroName} æˆ˜æ–—è·å¾—ç‰©å“: ID=${reward.itemId}, æ•°é‡=${reward.value}`, 'success');
                            }
                        });
                    }
                }
                return true;
            } else {
                throw new Error('å¼€å§‹æˆ˜æ–—å¤±è´¥');
            }
            
        } catch (error) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯2600080æˆ–2600050é”™è¯¯ç 
            if (error.message.includes('2600080') || error.message.includes('2600050')) {
                const errorCode = error.message.includes('2600080') ? '2600080' : '2600050';
                logMessage(`â¹ï¸ ${heroName} è¿ç»­æˆ˜æ–—å·²åœæ­¢ (é”™è¯¯ç : ${errorCode})`, 'warning');
                return 'stop'; // è¿”å›ç‰¹æ®Šå€¼è¡¨ç¤ºéœ€è¦åœæ­¢
            } else {
                logMessage(`âŒ ${heroName} å¼€å§‹æˆ˜æ–—å‡ºé”™: ${error.message}`, 'error');
                return false;
            }
        }
    }

    // è¿ç»­æˆ˜æ–—åŠŸèƒ½
    async function startContinuousBattle(heroId) {
        const heroName = heroData[heroId] ? heroData[heroId].name : `ID:${heroId}`;
        
        // å¦‚æœå·²ç»åœ¨è¿ç»­æˆ˜æ–—ä¸­ï¼Œå…ˆåœæ­¢
        if (globalState.battle.continuousBattles[heroId]) {
            stopContinuousBattle(heroId);
            return;
        }
        
        // è®¾ç½®è¿ç»­æˆ˜æ–—çŠ¶æ€
        globalState.battle.continuousBattles[heroId] = true;
        updateQuickActionButtons();
        
        logMessage(`ğŸ”„ ${heroName} å¼€å§‹è¿ç»­æˆ˜æ–—`, 'info');
        showTip(`${heroName}å¼€å§‹è¿ç»­æˆ˜æ–—`, 'info');
        
        // è¿ç»­æˆ˜æ–—å¾ªç¯
        const battleLoop = async () => {
            while (globalState.battle.continuousBattles[heroId]) {
                const result = await startSingleBattle(heroId);
                
                // å¦‚æœè¿”å›stopï¼Œè¡¨ç¤ºé‡åˆ°2600080æˆ–2600050é”™è¯¯ï¼Œåœæ­¢æˆ˜æ–—
                if (result === 'stop') {
                    stopContinuousBattle(heroId);
                    break;
                }
                
                // ç­‰å¾…0.1ç§’å†è¿›è¡Œä¸‹ä¸€æ¬¡æˆ˜æ–—
                if (globalState.battle.continuousBattles[heroId]) {
                    await delay(0.1);
                }
            }
        };
        
        battleLoop();
    }

    function stopContinuousBattle(heroId) {
        const heroName = heroData[heroId] ? heroData[heroId].name : `ID:${heroId}`;
        
        if (globalState.battle.continuousBattles[heroId]) {
            globalState.battle.continuousBattles[heroId] = false;
            updateQuickActionButtons();
            logMessage(`â¹ï¸ ${heroName} è¿ç»­æˆ˜æ–—å·²åœæ­¢`, 'info');
            showTip(`${heroName}è¿ç»­æˆ˜æ–—å·²åœæ­¢`, 'info');
        }
    }

    function stopAllContinuousBattles() {
        let stoppedAny = false;
        
        for (const heroId in globalState.battle.continuousBattles) {
            if (globalState.battle.continuousBattles[heroId]) {
                stopContinuousBattle(heroId);
                stoppedAny = true;
            }
        }
        
        if (stoppedAny) {
            logMessage('â¹ï¸ æ‰€æœ‰è¿ç»­æˆ˜æ–—å·²åœæ­¢', 'info');
            showTip('æ‰€æœ‰è¿ç»­æˆ˜æ–—å·²åœæ­¢', 'info');
        } else {
            showTip('æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„è¿ç»­æˆ˜æ–—', 'warning');
        }
    }

    // ==================== æ¢¦å¢ƒè´­ä¹°æ¨¡å— ====================

    // è·å–è§’è‰²ä¿¡æ¯ï¼ˆåŒ…å«å•†å“åˆ—è¡¨ï¼‰
    async function getRoleInfo() {
        try {
            const response = await sendCommand('role_getroleinfo', {});
            
            if (!response) {
                throw new Error('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥ï¼Œå“åº”ä¸ºç©º');
            }
            
            // è·å–å•†å“åˆ—è¡¨
            const merchantData = response?._rawData?.role?.dungeon?.merchant;
            if (merchantData) {
                globalState.buy.merchantData = merchantData;
            }
            
            // è·å–å…³å¡ID
            const levelId = response?._rawData?.role?.levelId;
            if (levelId !== undefined) {
                globalState.buy.levelId = levelId;
            }
            
            return { merchantData, levelId };
        } catch (error) {
            logMessage(`è·å–è§’è‰²ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            throw error;
        }
    }

    // è´­ä¹°å•†å“
    async function buyItem(merchantId, index, pos) {
        try {
            const message = {
                ack: 0,
                cmd: 'dungeon_buymerchant',
                params: {
                    id: merchantId,
                    index: index,
                    pos: pos
                },
                seq: Date.now(),
                time: Date.now()
            };

            const response = await window.ws.sendAsync(message);
            
            if (response?.code === 0) {
                return true;
            } else {
                throw new Error(`è´­ä¹°å¤±è´¥ï¼Œé”™è¯¯ç : ${response?.code}`);
            }
        } catch (error) {
            throw new Error(`è´­ä¹°å•†å“å¤±è´¥: ${error.message}`);
        }
    }

    // è·å–å•†å“æ˜¾ç¤ºåç§°
    function getItemName(merchantId, index) {
        const merchant = merchantConfig[merchantId];
        if (merchant && merchant.items[index] !== undefined) {
            return merchant.items[index];
        }
        return `æœªçŸ¥å•†å“(${index})`;
    }

    // è·å–å•†å“é¢œè‰²
    function getItemColor(merchantId, index) {
        const itemName = getItemName(merchantId, index);
        
        // é»„é‡‘é±¼ç«¿ç‰¹æ®Šé¢œè‰²
        if (itemName.includes('é»„é‡‘é±¼ç«¿')) {
            return globalConfig.ui.colors.fishingRod;
        }
        
        // é‡‘å¸å•†å“é¢œè‰²
        if (isGoldItem(parseInt(merchantId), index)) {
            return globalConfig.ui.colors.gold;
        }
        
        // å…¶ä»–å•†å“é¢œè‰²
        return globalConfig.ui.colors.other;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºé‡‘å¸å•†å“
    function isGoldItem(merchantId, index) {
        return goldItemsConfig[merchantId] && goldItemsConfig[merchantId].includes(index);
    }

    // è‡ªåŠ¨é€‰æ‹©æ‰€æœ‰é‡‘å¸å•†å“
    function selectAllGoldItems() {
        globalState.buy.selectedItems.clear();
        
        for (const merchantId in globalState.buy.merchantData) {
            const items = globalState.buy.merchantData[merchantId];
            items.forEach((index, pos) => {
                if (isGoldItem(parseInt(merchantId), index)) {
                    globalState.buy.selectedItems.add(`${merchantId}-${index}-${pos}`);
                }
            });
        }
        
        updateSelectionDisplay();
        renderMerchantItems();
        logMessage(`å·²é€‰æ‹© ${globalState.buy.selectedItems.size} ä¸ªé‡‘å¸å•†å“`, 'success');
    }

    // å…¨é€‰/å…¨ä¸é€‰
    function toggleAllItems(selectAll) {
        globalState.buy.selectedItems.clear();
        
        if (selectAll) {
            for (const merchantId in globalState.buy.merchantData) {
                const items = globalState.buy.merchantData[merchantId];
                items.forEach((index, pos) => {
                    globalState.buy.selectedItems.add(`${merchantId}-${index}-${pos}`);
                });
            }
        }
        
        updateSelectionDisplay();
        renderMerchantItems();
        logMessage(selectAll ? 'å·²å…¨é€‰æ‰€æœ‰å•†å“' : 'å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰å•†å“', 'info');
    }

    // æ‰¹é‡è´­ä¹°é€‰ä¸­çš„å•†å“
    async function batchBuySelected() {
        if (globalState.buy.selectedItems.size === 0) {
            logMessage('è¯·å…ˆé€‰æ‹©è¦è´­ä¹°çš„å•†å“', 'warning');
            return;
        }

        if (!isDungeonOpen()) {
            logMessage('å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰', 'error');
            return;
        }

        if (globalState.buy.levelId < 4000) {
            logMessage('å…³å¡æ•°å°äº4000ï¼Œæ— æ³•è´­ä¹°é‡‘å¸å•†å“', 'error');
            return;
        }

        globalState.buy.isRunning = true;
        updateButtonStates();

        const items = Array.from(globalState.buy.selectedItems);
        let successCount = 0;
        let failCount = 0;

        logMessage(`å¼€å§‹æ‰¹é‡è´­ä¹° ${items.length} ä»¶å•†å“...`, 'info');

        // æŒ‰å•†äººIDå’Œä½ç½®æ’åºï¼Œä»å¤§åˆ°å°è´­ä¹°
        items.sort((a, b) => {
            const [aMerchant, aIndex, aPos] = a.split('-').map(Number);
            const [bMerchant, bIndex, bPos] = b.split('-').map(Number);
            
            if (aMerchant !== bMerchant) return bMerchant - aMerchant;
            return bPos - aPos;
        });

        for (const itemKey of items) {
            const [merchantId, index, pos] = itemKey.split('-').map(Number);
            
            try {
                await buyItem(merchantId, index, pos);
                globalState.buy.selectedItems.delete(itemKey);
                successCount++;
                logMessage(`æˆåŠŸè´­ä¹°: ${merchantConfig[merchantId].name} - ${getItemName(merchantId, index)}`, 'success');
            } catch (error) {
                failCount++;
                logMessage(`è´­ä¹°å¤±è´¥: ${merchantConfig[merchantId].name} - ${getItemName(merchantId, index)} - ${error.message}`, 'error');
            }
            
            // å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
            await delay(0.5);
        }

        // é‡æ–°è·å–å•†å“åˆ—è¡¨æ›´æ–°ç•Œé¢
        await refreshMerchantList();
        
        logMessage(`æ‰¹é‡è´­ä¹°å®Œæˆ: æˆåŠŸ ${successCount} ä»¶, å¤±è´¥ ${failCount} ä»¶`, 
                   failCount === 0 ? 'success' : 'warning');
        
        globalState.buy.isRunning = false;
        updateButtonStates();
    }

    // ä¸€é”®è´­ä¹°æ‰€æœ‰é‡‘å¸å•†å“
    async function buyAllGoldItems() {
        if (!isDungeonOpen()) {
            logMessage('å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰', 'error');
            return;
        }

        if (globalState.buy.levelId < 4000) {
            logMessage('å…³å¡æ•°å°äº4000ï¼Œæ— æ³•è´­ä¹°é‡‘å¸å•†å“', 'error');
            return;
        }

        globalState.buy.isRunning = true;
        updateButtonStates();

        let successCount = 0;
        let failCount = 0;

        logMessage('å¼€å§‹ä¸€é”®è´­ä¹°æ‰€æœ‰é‡‘å¸å•†å“...', 'info');

        // éå†æ‰€æœ‰å•†äººçš„å•†å“
        for (const merchantId in globalState.buy.merchantData) {
            const items = globalState.buy.merchantData[merchantId];
            const numId = parseInt(merchantId);
            
            // ä»åå¾€å‰è´­ä¹°ï¼ˆposä»å¤§åˆ°å°ï¼‰
            for (let pos = items.length - 1; pos >= 0; pos--) {
                const index = items[pos];
                
                if (isGoldItem(numId, index)) {
                    try {
                        await buyItem(numId, index, pos);
                        successCount++;
                        logMessage(`æˆåŠŸè´­ä¹°: ${merchantConfig[numId].name} - ${getItemName(numId, index)}`, 'success');
                    } catch (error) {
                        failCount++;
                        logMessage(`è´­ä¹°å¤±è´¥: ${merchantConfig[numId].name} - ${getItemName(numId, index)} - ${error.message}`, 'error');
                    }
                    
                    // å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                    await delay(0.5);
                }
            }
        }

        // é‡æ–°è·å–å•†å“åˆ—è¡¨æ›´æ–°ç•Œé¢
        await refreshMerchantList();
        
        logMessage(`ä¸€é”®è´­ä¹°å®Œæˆ: æˆåŠŸ ${successCount} ä»¶, å¤±è´¥ ${failCount} ä»¶`, 
                   failCount === 0 ? 'success' : 'warning');
        
        globalState.buy.isRunning = false;
        updateButtonStates();
    }

    // è·å–å•†å“åˆ—è¡¨ï¼ˆåŒ…å«è‡ªåŠ¨è·å–é˜µå®¹ï¼‰
    async function refreshMerchantList() {
        if (!isDungeonOpen()) {
            logMessage('å½“å‰ä¸æ˜¯æ¢¦å¢ƒå¼€æ”¾æ—¶é—´ï¼ˆå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€ï¼‰', 'error');
            return;
        }

        try {
            logMessage('å¼€å§‹è‡ªåŠ¨è·å–å•†å“åˆ—è¡¨æµç¨‹...', 'info');
            
            // ç¬¬ä¸€æ­¥ï¼šè·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯
            logMessage('ç¬¬ä¸€æ­¥ï¼šè·å–é»˜è®¤é˜Ÿä¼ä¿¡æ¯...', 'info');
            const teamSuccess = await getDefaultTeamInfo();
            if (!teamSuccess) {
                logMessage('âŒ è·å–é»˜è®¤é˜Ÿä¼å¤±è´¥ï¼Œæ— æ³•ç»§ç»­', 'error');
                return;
            }
            
            // ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ¢¦å¢ƒé˜µå®¹
            logMessage('ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ¢¦å¢ƒé˜µå®¹...', 'info');
            await selectDreamTeam();
            
            // ç¬¬ä¸‰æ­¥ï¼šè·å–å•†å“åˆ—è¡¨
            logMessage('ç¬¬ä¸‰æ­¥ï¼šè·å–å•†å“åˆ—è¡¨...', 'info');
            await getRoleInfo();
            renderMerchantItems();
            updateSelectionDisplay();
            
            logMessage('âœ… å•†å“åˆ—è¡¨è·å–å®Œæˆ', 'success');
        } catch (error) {
            logMessage(`âŒ è·å–å•†å“åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
        }
    }

    // ==================== UIæ¸²æŸ“å‡½æ•° ====================

    // æ¸²æŸ“å•†äººå•†å“
    function renderMerchantItems() {
        const container = document.getElementById('merchantItemsContainer');
        if (!container) return;

        container.innerHTML = '';

        // åˆ›å»ºä¸‰åˆ—å®¹å™¨ - æ‰‹æœºé€‚é…
        const columnsContainer = document.createElement('div');
        columnsContainer.style.cssText = `
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-top: 8px;
            font-size: 10px;
        `;

        // ä¸ºæ¯ä¸ªå•†äººåˆ›å»ºä¸€åˆ—
        for (const merchantId in merchantConfig) {
            const merchant = merchantConfig[merchantId];
            const items = globalState.buy.merchantData[merchantId] || [];
            
            const column = document.createElement('div');
            column.style.cssText = `
                background: ${globalConfig.ui.colors.lightDark};
                border-radius: 4px;
                padding: 5px;
                min-height: 80px;
            `;
            
            // å•†äººæ ‡é¢˜
            const title = document.createElement('div');
            title.style.cssText = `
                font-weight: bold;
                color: ${globalConfig.ui.colors.primary};
                margin-bottom: 4px;
                text-align: center;
                font-size: 9px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            `;
            title.textContent = merchant.name;
            column.appendChild(title);
            
            // å•†å“åˆ—è¡¨
            if (items.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.cssText = `
                    color: ${globalConfig.ui.colors.textLight};
                    font-size: 8px;
                    text-align: center;
                    padding: 8px 0;
                `;
                emptyMsg.textContent = 'æ— å•†å“';
                column.appendChild(emptyMsg);
            } else {
                items.forEach((index, pos) => {
                    const itemKey = `${merchantId}-${index}-${pos}`;
                    const isSelected = globalState.buy.selectedItems.has(itemKey);
                    const itemColor = getItemColor(parseInt(merchantId), index);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        padding: 2px;
                        margin: 1px 0;
                        border-radius: 3px;
                        background: ${isSelected ? globalConfig.ui.colors.primary + '20' : 'transparent'};
                        cursor: pointer;
                        font-size: 8px;
                        min-height: 14px;
                    `;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = isSelected;
                    checkbox.style.cssText = `
                        margin-right: 4px;
                        transform: scale(0.8);
                    `;
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            globalState.buy.selectedItems.add(itemKey);
                        } else {
                            globalState.buy.selectedItems.delete(itemKey);
                        }
                        updateSelectionDisplay();
                        renderMerchantItems();
                    });
                    
                    const label = document.createElement('span');
                    label.textContent = getItemName(parseInt(merchantId), index);
                    label.style.cssText = `
                        color: ${itemColor};
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        flex: 1;
                    `;
                    
                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    column.appendChild(itemDiv);
                });
            }
            
            columnsContainer.appendChild(column);
        }
        
        container.appendChild(columnsContainer);
    }

    // æ›´æ–°é€‰æ‹©æ˜¾ç¤º
    function updateSelectionDisplay() {
        const selectedCount = document.getElementById('selectedCount');
        const batchBtn = document.getElementById('batchBuyBtn');
        
        if (selectedCount) {
            selectedCount.textContent = globalState.buy.selectedItems.size;
        }
        
        if (batchBtn) {
            batchBtn.textContent = `æ‰¹é‡è´­ä¹°(${globalState.buy.selectedItems.size})`;
            batchBtn.disabled = globalState.buy.selectedItems.size === 0 || globalState.buy.isRunning;
        }
    }

    // æ›´æ–°é˜Ÿä¼æ˜¾ç¤º
    function updateTeamDisplay() {
        const teamContainer = document.getElementById('dreamTeamContainer');
        if (!teamContainer) return;
        
        teamContainer.innerHTML = '';
        
        if (globalState.battle.currentTeamHeroes.length === 0) {
            teamContainer.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 10px;">æš‚æ— é˜Ÿä¼ä¿¡æ¯</div>';
            return;
        }
        
        globalState.battle.currentTeamHeroes.forEach(hero => {
            const heroElement = document.createElement('div');
            heroElement.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 8px;
                margin-bottom: 6px;
                background: rgba(0,0,0,0.3);
                border-radius: 6px;
                border-left: 3px solid ${getTypeColor(hero.type)};
            `;
            
            const isBattling = globalState.battle.continuousBattles[hero.id] || false;
            const buttonText = isBattling ? 'åœæ­¢æˆ˜æ–—' : 'è¿ç»­æˆ˜æ–—';
            const buttonColor = isBattling ? globalConfig.ui.colors.error : globalConfig.ui.colors.primary;
            
            heroElement.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-size: 12px; font-weight: bold;">${hero.name}</div>
                    <div style="font-size: 10px; color: ${globalConfig.ui.colors.textLight};">${hero.type} | ä½ç½®: ${hero.position + 1}</div>
                </div>
                <button class="hero-battle-btn" data-hero="${hero.id}" style="padding: 6px 10px; background: ${buttonColor}; border: none; border-radius: 4px; color: white; font-size: 10px; cursor: pointer;">${buttonText}</button>
            `;
            
            teamContainer.appendChild(heroElement);
        });
        
        // æ·»åŠ å•ä¸ªè‹±é›„è¿ç»­æˆ˜æ–—äº‹ä»¶
        document.querySelectorAll('.hero-battle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const heroId = this.getAttribute('data-hero');
                startContinuousBattle(heroId);
            });
        });
    }

    // æ›´æ–°å¿«é€Ÿæ“ä½œæŒ‰é’®
    function updateQuickActionButtons() {
        const quickActionContainer = document.getElementById('quickActionContainer');
        if (!quickActionContainer) return;
        
        quickActionContainer.innerHTML = '';
        
        if (globalState.battle.currentTeamHeroes.length === 0) {
            quickActionContainer.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 10px; font-size: 11px;">è·å–é»˜è®¤é˜µå®¹åæ˜¾ç¤º</div>';
            return;
        }
        
        // åªæ˜¾ç¤ºå‰6ä¸ªè‹±é›„ä½œä¸ºå¿«é€Ÿæ“ä½œ
        const heroesToShow = globalState.battle.currentTeamHeroes.slice(0, 6);
        
        heroesToShow.forEach(hero => {
            const isBattling = globalState.battle.continuousBattles[hero.id] || false;
            const buttonText = isBattling ? `åœæ­¢${hero.name}` : hero.name;
            const buttonColor = isBattling ? globalConfig.ui.colors.error : globalConfig.ui.colors.primary;
            
            const button = document.createElement('button');
            button.className = 'quick-hero-btn';
            button.setAttribute('data-hero', hero.id);
            button.textContent = buttonText;
            button.style.cssText = `
                padding: 8px;
                background: ${buttonColor};
                border: none;
                border-radius: 6px;
                color: white;
                font-size: 11px;
                cursor: pointer;
                flex: 1;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            `;
            
            button.addEventListener('click', function() {
                const heroId = this.getAttribute('data-hero');
                startContinuousBattle(heroId);
            });
            
            quickActionContainer.appendChild(button);
        });
    }

    // è·å–ç±»å‹é¢œè‰²
    function getTypeColor(type) {
        const colorMap = {
            'é­å›½': '#3b82f6',
            'èœ€å›½': '#10b981', 
            'å´å›½': '#f59e0b',
            'ç¾¤é›„': '#ef4444'
        };
        return colorMap[type] || globalConfig.ui.colors.primary;
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateButtonStates() {
        const buttons = [
            'dreamGetTeam', 'dreamSelectTeam', 'stopAllBattles',
            'getListBtn', 'goldBuyBtn', 'batchBuyBtn', 
            'selectAllBtn', 'unselectAllBtn'
        ];
        
        buttons.forEach(btnId => {
            const button = document.getElementById(btnId);
            if (button) {
                const isBattleLoading = globalState.battle.isLoading;
                const isBuyRunning = globalState.buy.isRunning;
                
                if (btnId.startsWith('dream') || btnId === 'stopAllBattles') {
                    button.disabled = isBattleLoading;
                    button.style.opacity = isBattleLoading ? '0.6' : '1';
                } else {
                    button.disabled = isBuyRunning;
                    button.style.opacity = isBuyRunning ? '0.6' : '1';
                }
            }
        });
    }

    // ==================== UIæ„å»º ====================

    // è·å–é¢æ¿å®½åº¦
    function getPanelWidth() {
        if (globalConfig.isMobile) {
            return `width: ${globalConfig.ui.mobileWidth}; max-width: ${globalConfig.ui.maxMobileWidth}px;`;
        } else {
            return `width: ${globalConfig.ui.baseWidth}px;`;
        }
    }

    // è·å–ä½ç½®æ ·å¼
    function getPositionStyle(position) {
        const style = [];
        
        if (position.top !== undefined) {
            style.push(`top: ${position.top};`);
        }
        if (position.right !== undefined) {
            style.push(`right: ${position.right};`);
        }
        if (position.left !== undefined) {
            style.push(`left: ${position.left};`);
        }
        if (position.transform !== undefined) {
            style.push(`transform: ${position.transform};`);
        }
        
        return style.join(' ');
    }

    // æ£€æµ‹è®¾å¤‡
    function detectDevice() {
        const isMobile = window.innerWidth <= 768;
        globalConfig.isMobile = isMobile;
        return isMobile;
    }

    // åˆ›å»ºæŒ‰é’®
    function createButton(text, onClick, isPrimary = false, id = null) {
        const btn = document.createElement('button');
        btn.textContent = text;
        if (id) btn.id = id;
        btn.style.cssText = `
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Microsoft YaHei', sans-serif;
            ${isPrimary ? 
                `background: ${globalConfig.ui.colors.primary}; color: white;` : 
                `background: ${globalConfig.ui.colors.lightDark}; color: ${globalConfig.ui.colors.text};`
            }
        `;
        btn.addEventListener('mouseover', () => !btn.disabled && (btn.style.transform = 'translateY(-1px)'));
        btn.addEventListener('mouseout', () => !btn.disabled && (btn.style.transform = 'translateY(0)'));
        btn.addEventListener('click', onClick);
        return btn;
    }

    // åˆ‡æ¢é€‰é¡¹å¡
    function switchTab(tabName) {
        globalConfig.currentTab = tabName;
        
        const battleTab = document.getElementById('battleTab');
        const buyTab = document.getElementById('buyTab');
        const battleContent = document.getElementById('battleContent');
        const buyContent = document.getElementById('buyContent');
        
        if (battleTab && buyTab && battleContent && buyContent) {
            if (tabName === 'battle') {
                battleTab.style.background = globalConfig.ui.colors.primary;
                buyTab.style.background = globalConfig.ui.colors.lightDark;
                battleContent.style.display = 'block';
                buyContent.style.display = 'none';
            } else {
                battleTab.style.background = globalConfig.ui.colors.lightDark;
                buyTab.style.background = globalConfig.ui.colors.primary;
                battleContent.style.display = 'none';
                buyContent.style.display = 'block';
            }
        }
    }

    // æ„å»ºä¸»UI
    function buildUI() {
        detectDevice();
        
        // ç§»é™¤å·²å­˜åœ¨çš„UIå…ƒç´ 
        document.getElementById('dreamToggleBtn')?.remove();
        document.getElementById('dreamMainPanel')?.remove();
        
        // åˆ›å»ºè§¦å‘å™¨æŒ‰é’®
        const toggleBtn = document.createElement('div');
        toggleBtn.id = 'dreamToggleBtn';
        toggleBtn.innerHTML = 'âš”ï¸';
        toggleBtn.style.cssText = `
            position: fixed;
            ${getPositionStyle(globalConfig.position.toggleBtn)}
            width: 40px;
            height: 40px;
            background: transparent;
            color: ${globalConfig.ui.colors.text};
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: ${globalConfig.ui.zIndex.toggleBtn};
            font-size: 24px;
            user-select: none;
            transition: all 0.3s ease;
            opacity: ${globalConfig.ui.defaultOpacity};
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        `;
        
        toggleBtn.addEventListener('click', () => {
            globalConfig.isPanelVisible = !globalConfig.isPanelVisible;
            const panel = document.getElementById('dreamMainPanel');
            if (panel) {
                panel.style.display = globalConfig.isPanelVisible ? 'block' : 'none';
            }
        });
        
        // åˆ›å»ºä¸»é¢æ¿
        const mainPanel = document.createElement('div');
        mainPanel.id = 'dreamMainPanel';
        mainPanel.style.cssText = `
            position: fixed;
            ${getPositionStyle(globalConfig.position.panel)}
            ${getPanelWidth()}
            background: linear-gradient(135deg, ${globalConfig.ui.colors.dark}, ${globalConfig.ui.colors.lightDark});
            border-radius: 12px;
            box-shadow: ${globalConfig.ui.shadows.panel};
            z-index: ${globalConfig.ui.zIndex.panel};
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: ${globalConfig.ui.colors.text};
            display: none;
            opacity: ${globalConfig.ui.defaultOpacity};
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            max-height: 90vh;
            overflow-y: auto;
        `;
        
        // é¢æ¿å†…å®¹
        mainPanel.innerHTML = `
            <div style="padding: 15px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 16px; font-weight: bold; color: ${globalConfig.ui.colors.primary}; margin-bottom: 5px;">æ¢¦å¢ƒç³»ç»Ÿ</div>
                    <div style="font-size: 11px; color: ${globalConfig.ui.colors.textLight};">v2.0 - æˆ˜æ–—ä¸è´­ä¹°ä¸€ä½“åŒ–</div>
                    <div style="font-size: 10px; color: ${globalConfig.ui.colors.warning}; background: ${globalConfig.ui.colors.warning}15; padding: 4px 8px; border-radius: 4px; margin: 5px 0; line-height: 1.2;">
                        å¼€æ”¾æ—¶é—´ï¼šå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€
                    </div>
                </div>
                
                <!-- é€‰é¡¹å¡ -->
                <div style="display: flex; margin-bottom: 15px; background: ${globalConfig.ui.colors.lightDark}; border-radius: 8px; padding: 4px;">
                    <button id="battleTab" style="flex: 1; padding: 8px; background: ${globalConfig.ui.colors.primary}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">æˆ˜æ–—æ¨¡å—</button>
                    <button id="buyTab" style="flex: 1; padding: 8px; background: ${globalConfig.ui.colors.lightDark}; border: none; border-radius: 6px; color: ${globalConfig.ui.colors.text}; font-size: 12px; cursor: pointer;">è´­ä¹°æ¨¡å—</button>
                </div>
                
                <!-- æˆ˜æ–—æ¨¡å—å†…å®¹ -->
                <div id="battleContent">
                    <div style="margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                            <button id="dreamGetTeam" style="padding: 10px; background: ${globalConfig.ui.colors.primary}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">è·å–é»˜è®¤é˜µå®¹</button>
                            <button id="dreamSelectTeam" style="padding: 10px; background: ${globalConfig.ui.colors.info}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">é€‰æ‹©æ¢¦å¢ƒé˜µå®¹</button>
                        </div>
                        <button id="stopAllBattles" style="width: 100%; padding: 8px; background: ${globalConfig.ui.colors.warning}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer; margin-top: 8px;">åœæ­¢æ‰€æœ‰æˆ˜æ–—</button>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 12px; color: ${globalConfig.ui.colors.textLight}; margin-bottom: 6px;">å¿«é€Ÿæ“ä½œ</div>
                        <div id="quickActionContainer" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; min-height: 40px;">
                            <div style="color: ${globalConfig.ui.colors.textLight}; text-align: center; padding: 10px; font-size: 11px; grid-column: 1 / -1;">è·å–é»˜è®¤é˜µå®¹åæ˜¾ç¤º</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 12px; color: ${globalConfig.ui.colors.textLight}; margin-bottom: 6px;">å½“å‰é˜µå®¹</div>
                        <div id="dreamTeamContainer" style="min-height: 60px; max-height: 200px; overflow-y: auto; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                            <div style="color: ${globalConfig.ui.colors.textLight}; text-align: center; padding: 10px;">ç‚¹å‡»"è·å–é»˜è®¤é˜µå®¹"åŠ è½½é˜Ÿä¼</div>
                        </div>
                    </div>
                </div>
                
                <!-- è´­ä¹°æ¨¡å—å†…å®¹ -->
                <div id="buyContent" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; gap: 8px;">
                            <button id="getListBtn" style="flex: 1; padding: 10px; background: ${globalConfig.ui.colors.primary}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">è·å–å•†å“åˆ—è¡¨</button>
                            <button id="goldBuyBtn" style="flex: 1; padding: 10px; background: ${globalConfig.ui.colors.warning}; border: none; border-radius: 6px; color: white; font-size: 12px; cursor: pointer;">é‡‘å¸ä¸€é”®è´­ä¹°</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div id="merchantItemsContainer" style="min-height: 150px; margin-bottom: 10px;">
                            <div style="color: ${globalConfig.ui.colors.textLight}; text-align: center; padding: 20px;">ç‚¹å‡»"è·å–å•†å“åˆ—è¡¨"åŠ è½½å•†å“</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 8px; border-top: 1px solid ${globalConfig.ui.colors.lightDark}; font-size: 10px;">
                        <div style="font-size: 10px;">é€‰æ‹©ï¼š<span id="selectedCount">0</span>ä»¶å•†å“</div>
                        <button id="batchBuyBtn" style="padding: 6px 10px; background: ${globalConfig.ui.colors.primary}; border: none; border-radius: 6px; color: white; font-size: 10px; cursor: pointer; margin: 0 5px;" disabled>æ‰¹é‡è´­ä¹°(0)</button>
                        <div style="display: flex; gap: 5px;">
                            <button id="selectAllBtn" style="padding: 4px 8px; background: ${globalConfig.ui.colors.lightDark}; border: none; border-radius: 4px; color: ${globalConfig.ui.colors.text}; font-size: 9px; cursor: pointer;">å…¨é€‰</button>
                            <button id="unselectAllBtn" style="padding: 4px 8px; background: ${globalConfig.ui.colors.lightDark}; border: none; border-radius: 4px; color: ${globalConfig.ui.colors.text}; font-size: 9px; cursor: pointer;">å…¨ä¸é€‰</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¥å¿—åŒºåŸŸ -->
                <div style="margin-top: 15px; border-top: 1px solid ${globalConfig.ui.colors.lightDark}; padding-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="font-size: 12px; color: ${globalConfig.ui.colors.warning}; font-weight: bold;">ç³»ç»Ÿæ—¥å¿—</div>
                        <button id="clearLogBtn" style="padding: 3px 6px; background: ${globalConfig.ui.colors.lightDark}; border: none; border-radius: 4px; color: ${globalConfig.ui.colors.text}; font-size: 10px; cursor: pointer;">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div id="dreamLogContainer" style="height: 120px; overflow-y: auto; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 11px; line-height: 1.3;">
                        <div style="color: ${globalConfig.ui.colors.textLight}; text-align: center; padding: 10px;">ç­‰å¾…æ“ä½œ...</div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(toggleBtn);
        document.body.appendChild(mainPanel);
        
        setupEventListeners();
        updateButtonStates();
        
        logMessage('æ¢¦å¢ƒç³»ç»Ÿå·²å°±ç»ª', 'success');
        logMessage('å¼€æ”¾æ—¶é—´ï¼šå‘¨ä¸‰/å‘¨å››/å‘¨æ—¥/å‘¨ä¸€', 'info');
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // é€‰é¡¹å¡åˆ‡æ¢
        const battleTab = document.getElementById('battleTab');
        const buyTab = document.getElementById('buyTab');
        if (battleTab) battleTab.addEventListener('click', () => switchTab('battle'));
        if (buyTab) buyTab.addEventListener('click', () => switchTab('buy'));
        
        // æˆ˜æ–—æ¨¡å—æŒ‰é’®
        const getTeamButton = document.getElementById('dreamGetTeam');
        if (getTeamButton) getTeamButton.addEventListener('click', getDefaultTeamInfo);
        
        const selectTeamButton = document.getElementById('dreamSelectTeam');
        if (selectTeamButton) selectTeamButton.addEventListener('click', selectDreamTeam);
        
        const stopAllButton = document.getElementById('stopAllBattles');
        if (stopAllButton) stopAllButton.addEventListener('click', stopAllContinuousBattles);
        
        // è´­ä¹°æ¨¡å—æŒ‰é’®
        const getListBtn = document.getElementById('getListBtn');
        if (getListBtn) getListBtn.addEventListener('click', refreshMerchantList);
        
        const goldBuyBtn = document.getElementById('goldBuyBtn');
        if (goldBuyBtn) goldBuyBtn.addEventListener('click', buyAllGoldItems);
        
        const batchBtn = document.getElementById('batchBuyBtn');
        if (batchBtn) batchBtn.addEventListener('click', batchBuySelected);
        
        const selectAllBtn = document.getElementById('selectAllBtn');
        if (selectAllBtn) selectAllBtn.addEventListener('click', () => toggleAllItems(true));
        
        const unselectAllBtn = document.getElementById('unselectAllBtn');
        if (unselectAllBtn) unselectAllBtn.addEventListener('click', () => toggleAllItems(false));
        
        // æ—¥å¿—æŒ‰é’®
        const clearLogBtn = document.getElementById('clearLogBtn');
        if (clearLogBtn) {
            clearLogBtn.addEventListener('click', () => {
                const logContainer = document.getElementById('dreamLogContainer');
                if (logContainer) {
                    logContainer.innerHTML = '';
                    logMessage('æ—¥å¿—å·²æ¸…ç©º', 'info');
                }
            });
        }
    }

    // ==================== åˆå§‹åŒ– ====================
    function init() {
        console.log("ğŸš€ æ¢¦å¢ƒç³»ç»Ÿå¼€å§‹åˆå§‹åŒ–");
        
        buildUI();
        
        window.addEventListener('resize', () => {
            const wasMobile = globalConfig.isMobile;
            const nowMobile = detectDevice();
            
            if (wasMobile !== nowMobile) {
                buildUI();
            }
        });
        
        console.log("âœ… æ¢¦å¢ƒç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ");
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

})();