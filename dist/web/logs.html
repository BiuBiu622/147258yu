<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒåº¦å™¨æ—¥å¿—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #252526;
            border-radius: 5px;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-refresh {
            background: #0e639c;
            color: white;
        }

        .btn-refresh:hover {
            background: #1177bb;
        }

        .btn-clear {
            background: #d73a49;
            color: white;
        }

        .btn-clear:hover {
            background: #cb2431;
        }

        .btn-auto {
            background: #28a745;
            color: white;
        }

        .btn-auto:hover {
            background: #218838;
        }

        .btn-auto.active {
            background: #218838;
        }

        .btn-scheduler {
            background: #10b981;
            color: white;
        }

        .btn-scheduler:hover {
            background: #059669;
        }

        .btn-scheduler.paused {
            background: #ef4444;
        }

        .btn-scheduler.paused:hover {
            background: #dc2626;
        }

        .btn-restart {
            background: #f59e0b;
            color: white;
        }

        .btn-restart:hover {
            background: #d97706;
        }

        .log-container {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            height: calc(100vh - 140px);
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-line {
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line:hover {
            background: #2d2d30;
        }

        .log-info {
            color: #569cd6;
        }

        .log-ok {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-warn {
            color: #dcdcaa;
        }

        .timestamp {
            color: #858585;
        }

        .empty {
            text-align: center;
            color: #858585;
            padding: 50px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #424242;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e4e;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }

            .title {
                font-size: 16px;
            }

            .controls {
                width: 100%;
                flex-direction: column;
            }

            button {
                width: 100%;
                padding: 10px;
            }

            .log-container {
                height: calc(100vh - 200px);
                padding: 10px;
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .log-container {
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="title">ğŸ“ è°ƒåº¦å™¨å®æ—¶æ—¥å¿—</div>
        <div class="controls">
            <button class="btn-scheduler" onclick="toggleScheduler()" id="schedulerBtn">â–¶ï¸ è¿è¡Œä¸­</button>
            <button class="btn-restart" onclick="restartScheduler()" id="restartBtn">ğŸ”„ é‡å¯è°ƒåº¦å™¨</button>
            <button class="btn-auto active" onclick="toggleAuto()">ğŸ”„ è‡ªåŠ¨åˆ·æ–°</button>
            <button class="btn-refresh" onclick="loadLogs()">ğŸ”ƒ æ‰‹åŠ¨åˆ·æ–°</button>
            <button class="btn-clear" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ˜¾ç¤º</button>
        </div>
    </div>

    <div class="log-container" id="logContainer">
        <div class="empty">æ­£åœ¨åŠ è½½æ—¥å¿—...</div>
    </div>

    <script>
        const API_BASE = `http://${window.location.hostname}:3000`;
        let autoRefresh = true;
        let refreshInterval = null;
        let schedulerPaused = false;

        // ===== è°ƒåº¦å™¨æ§åˆ¶åŠŸèƒ½ =====

        // è·å–è°ƒåº¦å™¨çŠ¶æ€
        async function getSchedulerStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/status`);
                const data = await res.json();
                if (data.success) {
                    schedulerPaused = data.paused || false;
                    updateSchedulerUI();
                }
            } catch (error) {
                console.error('è·å–è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢è°ƒåº¦å™¨çŠ¶æ€
        async function toggleScheduler() {
            const btn = document.getElementById('schedulerBtn');
            btn.disabled = true;

            try {
                const url = schedulerPaused ? `${API_BASE}/api/scheduler/resume` : `${API_BASE}/api/scheduler/pause`;
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    schedulerPaused = data.paused;
                    updateSchedulerUI();
                    console.log(data.message);
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ‡æ¢è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        }

        // æ›´æ–°è°ƒåº¦å™¨æŒ‰é’®UI
        function updateSchedulerUI() {
            const btn = document.getElementById('schedulerBtn');

            if (schedulerPaused) {
                btn.classList.add('paused');
                btn.textContent = 'â¸ï¸ å·²æš‚åœ';
            } else {
                btn.classList.remove('paused');
                btn.textContent = 'â–¶ï¸ è¿è¡Œä¸­';
            }
        }

        async function restartScheduler() {
            if (!confirm('ç¡®å®šè¦é‡å¯è°ƒåº¦å™¨å—ï¼Ÿå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šè¢«ä¸­æ–­ã€‚')) return;
            const btn = document.getElementById('restartBtn');
            btn.disabled = true;
            btn.textContent = 'â³ é‡å¯ä¸­...';
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/restart`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert('è°ƒåº¦å™¨é‡å¯æŒ‡ä»¤å·²å‘é€ï¼');
                    setTimeout(() => getSchedulerStatus(), 2000);
                } else {
                    alert('é‡å¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('é‡å¯è°ƒåº¦å™¨å¤±è´¥:', error);
                alert('é‡å¯å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ é‡å¯è°ƒåº¦å™¨';
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs`);
                const result = await response.json();

                if (result.success) {
                    displayLogs(result.logs);
                } else {
                    showError('åŠ è½½å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showError('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ—¥å¿—
        function displayLogs(logs) {
            const container = document.getElementById('logContainer');

            if (!logs || logs.trim() === '') {
                container.innerHTML = '<div class="empty">æš‚æ— æ—¥å¿—</div>';
                return;
            }

            const lines = logs.split('\n').filter(line => line.trim());

            let html = '';
            lines.forEach(line => {
                let className = 'log-line';

                if (line.includes('[INFO]')) {
                    className += ' log-info';
                } else if (line.includes('[OK]')) {
                    className += ' log-ok';
                } else if (line.includes('[ERROR]')) {
                    className += ' log-error';
                } else if (line.includes('[WARN]')) {
                    className += ' log-warn';
                }

                // é«˜äº®æ—¶é—´æˆ³
                line = line.replace(/\[(\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2})\]/, '<span class="timestamp">[$1]</span>');

                html += `<div class="${className}">${line}</div>`;
            });

            container.innerHTML = html;

            // æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const container = document.getElementById('logContainer');
            container.innerHTML = `<div class="empty log-error">${message}</div>`;
        }

        // æ¸…ç©ºæ˜¾ç¤º
        function clearLogs() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '<div class="empty">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAuto() {
            autoRefresh = !autoRefresh;
            const btn = document.querySelector('.btn-auto');

            if (autoRefresh) {
                btn.classList.add('active');
                btn.textContent = 'ğŸ”„ è‡ªåŠ¨åˆ·æ–°';
                startAutoRefresh();
            } else {
                btn.classList.remove('active');
                btn.textContent = 'â¸ï¸ å·²æš‚åœ';
                stopAutoRefresh();
            }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            loadLogs(); // ç«‹å³åŠ è½½ä¸€æ¬¡
            refreshInterval = setInterval(loadLogs, 3000); // æ¯3ç§’åˆ·æ–°
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // é¡µé¢åŠ è½½æ—¶å¯åŠ¨
        window.addEventListener('load', () => {
            getSchedulerStatus();  // è·å–è°ƒåº¦å™¨çŠ¶æ€
            startAutoRefresh();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>

</html>