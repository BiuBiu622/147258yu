<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆåŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        /* ==================== æ–°ç‰ˆè¯¦æƒ…é¢æ¿ ==================== */
        .detail-panel-v2 {
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.01) 100%);
            border-left: 4px solid;
            border-image: var(--gradient-primary) 1;
        }

        .task-groups {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .task-group {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .task-group-header {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            border-bottom: 1px solid #f1f5f9;
        }

        .task-group-header.daily {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%);
            color: #2563eb;
        }

        .task-group-header.battle {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(52, 211, 153, 0.05) 100%);
            color: #059669;
        }

        .task-group-header.monthly {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(192, 132, 252, 0.05) 100%);
            color: #7c3aed;
        }

        .task-group-header.activity {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
            color: #d97706;
        }

        .task-group-body {
            padding: 8px 10px;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        .task-item-name {
            color: var(--text-medium);
            font-weight: 500;
        }

        .badge-sm {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .badge-sm.success {
            background: rgba(16, 185, 129, 0.15);
            color: #059669;
        }

        .badge-sm.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .badge-sm.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .badge-sm.info {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        .badge-sm.gray {
            background: rgba(148, 163, 184, 0.15);
            color: #64748b;
        }

        .btn.danger {
            background: #ef4444 !important;
            color: white;
        }

        .btn.danger:hover {
            background: #dc2626 !important;
        }

        .btn.warning {
            background: #f59e0b !important;
            color: white;
        }

        .btn.warning:hover {
            background: #d97706 !important;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-inner">
            <a href="/" class="navbar-brand">ğŸ’ æ¸¸æˆåŠ©æ‰‹</a>
            <div class="navbar-nav">
                <div class="nav-link active" onclick="showPage('status')">ğŸ“Š è´¦å·çŠ¶æ€</div>
                <div class="nav-link" onclick="showPage('tools')">ğŸ§° å·¥å…·ç®±</div>
                <div class="nav-link" onclick="showPage('bin')">ğŸ“ BINç®¡ç†</div>
                <div class="nav-link" onclick="showPage('logs')">ğŸ“ è¿è¡Œæ—¥å¿—</div>
                <a class="nav-link" href="/license.html" title="æŸ¥çœ‹æˆ–æ›´æ–°ç³»ç»Ÿæˆæƒ">ğŸ” æˆæƒä¸­å¿ƒ</a>
                <a class="nav-link" href="/boss-assist.html" target="_blank" style="text-decoration: none;">ğŸ°
                    BOSSå¡”åŠ©æˆ˜</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="save-status" id="saveStatus">âœ“ ä¿å­˜æˆåŠŸ</div>
        <!-- è´¦å·çŠ¶æ€é¡µ -->
        <div id="page-status" class="page active">
            <div class="page-header">
                <h2>ğŸ“Š è´¦å·çŠ¶æ€ç›‘æ§</h2>
                <div class="header-right">
                    <div class="stat-box">
                        <div class="stat-value" id="totalAccounts">0</div>
                        <div class="stat-label">æ€»è´¦å·</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="withStatus">0</div>
                        <div class="stat-label">æœ‰çŠ¶æ€</div>
                    </div>
                    <button class="btn" onclick="loadStatusData()">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>
            <div class="table-container">
                <table class="status-table" id="statusTable">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding-left:16px;">è´¦å·</th>
                            <th>æ¯æ—¥ä»»åŠ¡</th>
                            <th>ç›ç½</th>
                            <th>æŒ‚æœº</th>
                            <th>ç«æŠ€åœº</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody">
                        <tr>
                            <td colspan="6">
                                <div class="no-data">
                                    <div class="no-data-icon">â³</div>
                                    <div class="no-data-text">åŠ è½½ä¸­...</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- å·¥å…·ç®±é¡µ -->
        <div id="page-tools" class="page">
            <iframe id="toolsFrame" src="tools.html"></iframe>
        </div>

        <!-- BINç®¡ç†é¡µ -->
        <div id="page-bin" class="page">
            <div class="page-header">
                <h2>ğŸ“ BINæ–‡ä»¶ç®¡ç†</h2>
            </div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½BINæ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div class="upload-hint">æ”¯æŒ .bin æ ¼å¼æ–‡ä»¶ï¼Œä¸Šä¼ åè‡ªåŠ¨è½¬æ¢Token</div>
                <input type="file" id="fileInput" accept=".bin" multiple>
            </div>
            <div class="file-list">
                <div class="file-list-header">
                    <h3>æ–‡ä»¶åˆ—è¡¨</h3><button class="btn" onclick="loadBinFiles()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="fileListContent">
                    <div class="no-data">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- è¿è¡Œæ—¥å¿—é¡µ -->
        <div id="page-logs" class="page">
            <div class="page-header">
                <h2>ğŸ“ è°ƒåº¦å™¨æ—¥å¿—</h2>
                <div class="header-right">
                    <button class="btn" id="schedulerBtn" onclick="toggleScheduler()">â–¶ï¸ è¿è¡Œä¸­</button>
                    <button class="btn warning" id="restartBtn" onclick="restartScheduler()">ğŸ”„ é‡å¯è°ƒåº¦å™¨</button>
                    <button class="btn" id="autoLogBtn" onclick="toggleAutoLog()">ğŸ”„ è‡ªåŠ¨åˆ·æ–°</button>
                    <button class="btn secondary" onclick="loadLogs()">åˆ·æ–°</button>
                </div>
            </div>
            <div class="log-container" id="logContainer">
                <div class="no-data">åŠ è½½ä¸­...</div>
            </div>
        </div>


    </div>

    <style>
        /* ==================== é…ç½®å¼¹çª— ==================== */
        .config-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .config-modal-overlay.show {
            display: flex;
        }

        .config-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 960px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .config-modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-modal-title {
            font-size: 15px;
            font-weight: 700;
        }

        .config-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .config-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .config-modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        /* é…ç½®å¼¹çª—å†…å®¹ - ç´§å‡‘æµå¼å¸ƒå±€ */
        .config-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* é…ç½®è¡Œ - æ°´å¹³æ’åˆ—å¤šä¸ªä»»åŠ¡ */
        .config-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* é…ç½®åŒºå— - å†…è”ç´§å‡‘ */
        .config-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 14px;
            flex: 1;
            min-width: 220px;
        }

        .config-section.wide {
            min-width: 340px;
        }

        .config-section.wider {
            min-width: 380px;
        }

        .config-section.narrow {
            min-width: 140px;
            max-width: 180px;
            flex: 0.6;
        }

        .config-section.full {
            flex: 100%;
        }

        /* åŒºå—æ ‡é¢˜è¡Œ - æ ‡é¢˜å’Œæ€»å¼€å…³åœ¨åŒä¸€è¡Œ */
        .config-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        .config-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #667eea;
        }

        /* é…ç½®é¡¹ç½‘æ ¼ */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px 16px;
        }

        .config-grid.cols-1 {
            grid-template-columns: 1fr;
        }

        .config-grid.cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .config-grid.cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        /* å•ä¸ªé…ç½®é¡¹ */
        .cfg-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            color: #64748b;
            gap: 8px;
        }

        .cfg-item span {
            font-weight: 500;
            white-space: nowrap;
        }

        /* æ•°å­—è¾“å…¥ç»„ - æ›´ç´§å‡‘ */
        .cfg-num {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .cfg-num input {
            width: 36px;
            height: 22px;
            text-align: center;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
        }

        .cfg-num button {
            width: 20px;
            height: 20px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .cfg-num button:hover {
            background: #f1f5f9;
        }

        /* æ¢¦å¢ƒå•†äºº - æ¨ªå‘ç´§å‡‘ */
        .merchant-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 0;
            border-top: 1px dashed #e2e8f0;
            margin-top: 8px;
        }

        .merchant-row:first-of-type {
            border-top: none;
            margin-top: 0;
        }

        .merchant-label {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .merchant-label.green {
            color: #059669;
            background: rgba(16, 185, 129, 0.15);
        }

        .merchant-label.yellow {
            color: #d97706;
            background: rgba(245, 158, 11, 0.15);
        }

        .merchant-label.red {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.15);
        }

        .merchant-items-inline {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .merchant-items-inline .cfg-item {
            gap: 5px;
        }

        /* å¼€å…³ - æ ‡å‡†å°ºå¯¸ */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 20px;
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* æ•°å­—è¾“å…¥ - å°å· */
        .number-input-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .number-input-group input {
            width: 32px;
            height: 20px;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 11px;
            padding: 0;
        }

        .number-btn {
            width: 18px;
            height: 18px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-btn:hover {
            background: #f1f5f9;
        }

        /* æ¢¦å¢ƒå•†äºº - ç´§å‡‘ç‰ˆ */
        .merchant-group {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed #e5e7eb;
        }

        .merchant-tag {
            font-size: 10px;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .merchant-tag.green {
            color: #059669;
            background: rgba(16, 185, 129, 0.15);
        }

        .merchant-tag.yellow {
            color: #d97706;
            background: rgba(245, 158, 11, 0.15);
        }

        .merchant-tag.red {
            color: #dc2626;
            background: rgba(239, 68, 68, 0.15);
        }

        .merchant-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px 8px;
        }

        .merchant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 10px;
            padding: 2px 0;
        }

        /* å“åº”å¼ */
        @media (max-width: 700px) {
            .config-modal {
                max-width: 95vw;
            }

            .config-row {
                flex-direction: column;
            }

            .config-section {
                min-width: 100%;
            }
        }

        @media (max-width: 1200px) {
            .task-groups {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .task-groups {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- é…ç½®å¼¹çª—å®¹å™¨ -->
    <div class="config-modal-overlay" id="configModal" onclick="closeConfigModal(event)">
        <div class="config-modal" onclick="event.stopPropagation()">
            <div class="config-modal-header">
                <span class="config-modal-title" id="configModalTitle">âš™ï¸ ä»»åŠ¡é…ç½®</span>
                <button class="config-modal-close" onclick="closeConfigModal()">âœ•</button>
            </div>
            <div class="config-modal-body" id="configModalBody"></div>
        </div>
    </div>

    <script>
        // ==================== APIé…ç½® ====================
        function getApiBase() {
            if (typeof window.API_BASE_URL !== 'undefined') return window.API_BASE_URL;
            const hostname = window.location.hostname;
            const port = window.location.port;
            if (port === '8080') return `http://${hostname}:3000`;
            return `http://${hostname}:3000`;
        }
        const API_BASE = getApiBase();

        let currentConfig = null, statusData = {}, tokens = [], countdowns = {}, expandedAccount = null;
        let autoLogInterval = null, autoHangupInterval = null, isAutoLog = false, isAutoHangup = false;
        let schedulerPaused = false;

        // ===== è°ƒåº¦å™¨æ§åˆ¶åŠŸèƒ½ =====
        async function getSchedulerStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/status`);
                const data = await res.json();
                if (data.success) {
                    schedulerPaused = data.paused || false;
                    updateSchedulerUI();
                }
            } catch (error) {
                console.error('è·å–è°ƒåº¦å™¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        async function toggleScheduler() {
            const btn = document.getElementById('schedulerBtn');
            btn.disabled = true;
            try {
                const url = schedulerPaused ? `${API_BASE}/api/scheduler/resume` : `${API_BASE}/api/scheduler/pause`;
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    schedulerPaused = data.paused;
                    updateSchedulerUI();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
            }
        }

        function updateSchedulerUI() {
            const btn = document.getElementById('schedulerBtn');
            if (schedulerPaused) {
                btn.textContent = 'â¸ï¸ å·²æš‚åœ';
                btn.classList.add('danger');
            } else {
                btn.textContent = 'â–¶ï¸ è¿è¡Œä¸­';
                btn.classList.remove('danger');
            }
        }

        async function restartScheduler() {
            if (!confirm('ç¡®å®šè¦é‡å¯è°ƒåº¦å™¨å—ï¼Ÿå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ä¼šè¢«ä¸­æ–­ã€‚')) return;
            const btn = document.getElementById('restartBtn');
            btn.disabled = true;
            btn.textContent = 'â³ é‡å¯ä¸­...';
            try {
                const res = await fetch(`${API_BASE}/api/scheduler/restart`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('è°ƒåº¦å™¨é‡å¯æˆåŠŸï¼');
                    setTimeout(() => getSchedulerStatus(), 2000);
                } else {
                    alert('é‡å¯å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('é‡å¯å¤±è´¥: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„ é‡å¯è°ƒåº¦å™¨';
            }
        }

        // é¡µé¢åˆ‡æ¢
        function showPage(page, updateHash = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(n => {
                if (n.getAttribute('onclick')?.includes(`'${page}'`)) n.classList.add('active');
            });
            if (updateHash) window.location.hash = page;
            if (page === 'tools') document.body.style.overflow = 'hidden';
            else document.body.style.overflow = '';
            if (page === 'status') loadStatusData();
            else if (page === 'bin') loadBinFiles();
            else if (page === 'logs') loadLogs();
            else if (page === 'hangup') loadHangupData();
        }

        // æ´»åŠ¨å‘¨è®¡ç®—
        const æ´»åŠ¨ç±»å‹ = { 0: 'é»‘å¸‚å‘¨', 1: 'æ‹›å‹Ÿå‘¨', 2: 'å®ç®±å‘¨' };
        const åŸºå‡†æ—¶é—´ = new Date('2025-11-21 12:00:00').getTime();
        function è®¡ç®—æ´»åŠ¨å‘¨å¼€å§‹æ—¶é—´(now) {
            const d = new Date(now), w = d.getDay();
            const fri = new Date(d); fri.setDate(d.getDate() + (w < 5 ? 5 - w : w === 5 ? 0 : 12 - w));
            fri.setHours(12, 0, 0, 0);
            if (d.getTime() < fri.getTime()) fri.setDate(fri.getDate() - 7);
            return fri.getTime();
        }
        function è·å–å½“å‰æ´»åŠ¨å‘¨ç±»å‹() {
            const start = è®¡ç®—æ´»åŠ¨å‘¨å¼€å§‹æ—¶é—´(new Date());
            const idx = Math.floor((start - åŸºå‡†æ—¶é—´) / 604800000) % 3;
            return æ´»åŠ¨ç±»å‹[idx >= 0 ? idx : idx + 3];
        }
        function formatShortTime(s) {
            if (!s || s <= 0) return '-';
            const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                if (h > 0) return `${h}h${m}m`;
                if (m > 0) return `${m}m${sec}s`;
                return `${sec}s`;
            }
            if (h > 0) return `${h}å°æ—¶${m}åˆ†${sec}ç§’`;
            if (m > 0) return `${m}åˆ†${sec}ç§’`;
            return `${sec}ç§’`;
        }

        // åŠ è½½æ•°æ®
        async function loadStatusData() {
            try {
                const t = Date.now();
                try { await fetch(`${API_BASE}/api/sync-accounts`, { method: 'POST' }); } catch (e) { }
                const tokensRes = await fetch(`/data/tokens.json?t=${t}`);
                if (!tokensRes.ok) throw new Error('æœªæ‰¾åˆ°tokens.json');
                tokens = await tokensRes.json();
                try { const r = await fetch(`/data/account-status.json?t=${t}`); if (r.ok) statusData = await r.json(); } catch (e) { }
                try {
                    const r = await fetch(`/data/task-config.json?t=${t}`); if (r.ok) {
                        const fullConfig = await r.json();
                        currentConfig = fullConfig.è´¦å·é…ç½® || {};
                    }
                } catch (e) { }

                let scheduleData = {};
                try { const r = await fetch(`/data/task-schedule-record.json?t=${t}`); if (r.ok) scheduleData = await r.json(); } catch (e) { }
                if (scheduleData.BOSSæˆ˜æ–—?.accounts) {
                    Object.keys(statusData).forEach(accountName => {
                        const scheduleRecord = scheduleData.BOSSæˆ˜æ–—.accounts[accountName];
                        if (scheduleRecord && scheduleRecord.lastStatus === 'success') {
                            if (!statusData[accountName].BOSSæˆ˜æ–—) statusData[accountName].BOSSæˆ˜æ–— = {};
                            statusData[accountName].BOSSæˆ˜æ–—.çŠ¶æ€ = 'success';
                        }
                    });
                }

                Object.keys(countdowns).forEach(k => { if (countdowns[k]) { clearInterval(countdowns[k]); delete countdowns[k]; } });
                renderStatusTable();
                document.getElementById('totalAccounts').textContent = tokens.length;
                document.getElementById('withStatus').textContent = Object.keys(statusData).length;
            } catch (e) {
                document.getElementById('statusTableBody').innerHTML = `<tr><td colspan="6"><div class="no-data"><div class="no-data-icon">âŒ</div><div class="no-data-text">${e.message}</div></div></td></tr>`;
            }
        }

        function renderStatusTable() {
            const tbody = document.getElementById('statusTableBody');
            if (!tokens.length) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="no-data"><div class="no-data-icon">ğŸ“­</div><div class="no-data-text">æš‚æ— è´¦å·</div></div></td></tr>`;
                return;
            }
            let html = '';
            tokens.forEach(t => {
                html += renderAccountRow(t.name, statusData[t.name]);
                html += renderDetailRow(t.name, statusData[t.name]);
            });
            tbody.innerHTML = html;
            tokens.forEach(t => { if (statusData[t.name]) startCountdown(t.name, statusData[t.name]); });
            if (expandedAccount) {
                const dr = document.getElementById(`detail-row-${expandedAccount}`);
                const row = document.getElementById(`data-row-${expandedAccount}`);
                if (dr) dr.classList.add('show');
                if (row) row.classList.add('expanded');
            }
        }

        function renderAccountRow(name, status) {
            const now = Date.now() / 1000;
            const dp = status?.dailyTask?.dailyPoint || 0;
            const percentage = Math.min(100, (dp / 110) * 100);
            let progressClass = 'low';
            if (percentage >= 100) progressClass = 'complete';
            else if (percentage >= 70) progressClass = 'high';
            else if (percentage >= 40) progressClass = 'medium';

            const dailyCell = `<div class="progress-container"><div class="progress-bar ${progressClass}" style="width: ${percentage}%"></div><div class="progress-text">${dp}/110</div></div>`;

            const bottleHelper = status?.bottleHelper;
            let bottleCell = '<span class="badge gray">æœªå¯åŠ¨</span>';
            if (bottleHelper) {
                const hst = bottleHelper.helperStopTime || 0;
                const isRunning = bottleHelper.isRunning || (hst > now);
                if (isRunning && hst > now) {
                    const timeStr = formatShortTime(Math.floor(hst - now));
                    const isMobile = window.innerWidth <= 768;
                    bottleCell = `<span class="time-cell">ğŸŸ¢${isMobile ? '' : 'å‰©ä½™'}<span id="bottle-${name}">${timeStr}</span></span>`;
                } else {
                    bottleCell = '<span class="badge gray">å·²åœæ­¢</span>';
                }
            }

            const hangUp = status?.hangUp;
            let hangUpCell = '<span class="badge gray">æœªæŒ‚æœº</span>';
            if (hangUp && hangUp.lastTime > 0) {
                const lastTime = hangUp.lastTime, hangUpTime = hangUp.hangUpTime || 0;
                const elapsedTime = Math.floor(now - lastTime);
                if (hangUpTime > 0) {
                    const remainingTime = Math.max(0, Math.floor(hangUpTime - (now - lastTime)));
                    const isMobile = window.innerWidth <= 768;
                    hangUpCell = remainingTime > 0 ? `<span class="time-cell">ğŸŸ¢${isMobile ? '' : 'å·²æŒ‚'}<span id="hangup-${name}">${formatShortTime(elapsedTime)}</span></span>` : '<span class="badge warning">å·²å®Œæˆ</span>';
                } else {
                    const isMobile = window.innerWidth <= 768;
                    hangUpCell = `<span class="time-cell">ğŸŸ¢${isMobile ? '' : 'å·²æŒ‚'}<span id="hangup-${name}">${formatShortTime(elapsedTime)}</span></span>`;
                }
            }

            const as = status?.arena?.status || 'pending', asc = status?.arena?.successCount || 0;
            let arenaBadge = '<span class="badge gray">-</span>';
            if (as === 'success') arenaBadge = `<span class="badge success">${asc}/3âœ“</span>`;
            else if (as === 'partial') arenaBadge = `<span class="badge warning">${asc}/3</span>`;
            else if (as === 'failed') arenaBadge = `<span class="badge danger">${asc}/3</span>`;

            return `<tr id="data-row-${name}" class="${expandedAccount === name ? 'expanded' : ''}">
                <td class="account-name-cell" onclick="toggleDetail('${name}')"><span class="expand-icon ${expandedAccount === name ? 'open' : ''}">â–¶</span>${name}</td>
                <td>${dailyCell}</td><td>${bottleCell}</td><td>${hangUpCell}</td><td>${arenaBadge}</td>
                <td>
                    <button class="action-btn settings" onclick="openConfigModal('${name}')" title="é…ç½®">âš™ï¸</button>
                    <button class="action-btn ${(currentConfig?.[name]?.å¯ç”¨ !== false) ? 'enabled' : 'disabled'}" onclick="toggleAccountEnabled('${name}')" title="${(currentConfig?.[name]?.å¯ç”¨ !== false) ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}">
                        ${(currentConfig?.[name]?.å¯ç”¨ !== false) ? 'âœ…' : 'â›”'}
                    </button>
                </td>
            </tr>`;
        }

        // è¯¦æƒ…é¢æ¿ - åˆ†ç»„å¸ƒå±€ï¼ˆç”¨æˆ·è‡ªå®šä¹‰åˆ†ç»„ï¼‰
        function renderDetailRow(name, status) {
            const awt = è·å–å½“å‰æ´»åŠ¨å‘¨ç±»å‹();
            const ä»Šå¤©å‘¨å‡  = new Date().getDay();
            const æ˜¯å®åº“å¼€æ”¾æ—¥ = (ä»Šå¤©å‘¨å‡  !== 1 && ä»Šå¤©å‘¨å‡  !== 2);

            // === æ¯æ—¥ä»»åŠ¡ ===
            // ä¿±ä¹éƒ¨ç­¾åˆ°
            let signinBadge = '<span class="badge-sm gray">æœªç­¾</span>';
            if (status?.signin?.isSignedIn) {
                signinBadge = '<span class="badge-sm success">å·²ç­¾</span>';
            }

            // æ¯æ—¥å’¸ç‹
            let kingBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (status?.æ¯æ—¥å’¸ç‹?.çŠ¶æ€ === 'success') {
                kingBadge = '<span class="badge-sm success">å·²å®Œæˆ</span>';
            } else if (status?.æ¯æ—¥å’¸ç‹?.çŠ¶æ€ === 'failed') {
                kingBadge = '<span class="badge-sm danger">å¤±è´¥</span>';
            } else if (status?.æ¯æ—¥å’¸ç‹?.çŠ¶æ€ === 'pending') {
                kingBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
            }

            // ç¯ç¥
            let genieBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (status?.ç¯ç¥?.çŠ¶æ€ === 'success') {
                genieBadge = '<span class="badge-sm success">å·²å®Œæˆ</span>';
            } else if (status?.ç¯ç¥?.çŠ¶æ€ === 'failed') {
                genieBadge = '<span class="badge-sm danger">å¤±è´¥</span>';
            } else if (status?.ç¯ç¥?.çŠ¶æ€ === 'pending') {
                genieBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
            }

            // BOSSæˆ˜æ–—
            let bossBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (status?.BOSSæˆ˜æ–—?.çŠ¶æ€ === 'success') {
                bossBadge = '<span class="badge-sm success">å·²å®Œæˆ</span>';
            } else if (status?.BOSSæˆ˜æ–—?.çŠ¶æ€ === 'failed') {
                bossBadge = '<span class="badge-sm danger">å¤±è´¥</span>';
            } else if (status?.BOSSæˆ˜æ–—?.çŠ¶æ€ === 'pending') {
                bossBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
            }

            // ç«æŠ€åœº
            let arenaBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (status?.arena) {
                const sc = status.arena.successCount || 0;
                const st = status.arena.status;
                if (st === 'success') {
                    arenaBadge = `<span class="badge-sm success">${sc}/3èƒœ</span>`;
                } else if (st === 'partial') {
                    arenaBadge = `<span class="badge-sm warning">${sc}/3èƒœ</span>`;
                } else if (st === 'failed') {
                    arenaBadge = `<span class="badge-sm danger">${sc}/3è´¥</span>`;
                } else if (st === 'pending') {
                    arenaBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
                }
            }

            // === æ¯å‘¨ä»»åŠ¡ ===
            // å’¸é±¼å¤§å†²å…³ï¼ˆç­”é¢˜ï¼‰
            let studyBadge = '<span class="badge-sm gray">æœªç­”é¢˜</span>';
            if (status?.study?.hasAnswered) {
                const score = status.study.score || 0;
                studyBadge = score >= 10
                    ? `<span class="badge-sm success">${score}åˆ†âœ“</span>`
                    : `<span class="badge-sm warning">${score}åˆ†</span>`;
            }

            // æ¢¦å¢ƒ
            let dreamBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (status?.æ¢¦å¢ƒ?.çŠ¶æ€ === 'success') {
                dreamBadge = '<span class="badge-sm success">å·²å®Œæˆ</span>';
            } else if (status?.æ¢¦å¢ƒ?.çŠ¶æ€ === 'failed') {
                dreamBadge = '<span class="badge-sm danger">å¤±è´¥</span>';
            } else if (status?.æ¢¦å¢ƒ?.çŠ¶æ€ === 'pending') {
                dreamBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
            }

            // å››åœ£ç¢ç‰‡ï¼ˆå†›å›¢å•†åº—ï¼‰
            let legionBadge = '<span class="badge-sm gray">æœªè´­ä¹°</span>';
            if (status?.legionShop?.æ˜¾ç¤ºçŠ¶æ€ === 'purchased') {
                legionBadge = '<span class="badge-sm success">å·²è´­ä¹°</span>';
            } else if (status?.legionShop?.æ˜¾ç¤ºçŠ¶æ€ === 'insufficient') {
                legionBadge = '<span class="badge-sm warning">è´§å¸ä¸è¶³</span>';
            } else if (status?.legionShop?.æ˜¾ç¤ºçŠ¶æ€ === 'failed') {
                legionBadge = '<span class="badge-sm danger">è´­ä¹°å¤±è´¥</span>';
            }

            // å®åº“
            let baokuBadge = '<span class="badge-sm gray">æœªæ‰§è¡Œ</span>';
            if (!æ˜¯å®åº“å¼€æ”¾æ—¥) {
                baokuBadge = '<span class="badge-sm gray">ä¼‘æ¯æ—¥</span>';
            } else if (status?.å®åº“?.çŠ¶æ€ === 'success') {
                baokuBadge = '<span class="badge-sm success">å·²å®Œæˆ</span>';
            } else if (status?.å®åº“?.æœ€åæ‰§è¡Œæ—¶é—´) {
                baokuBadge = '<span class="badge-sm success">å·²æ‰§è¡Œ</span>';
            }

            // ç–¯ç‹‚èµ›è½¦
            let carBadge = '<span class="badge-sm gray">æœªå‘è½¦</span>';
            const carDays = status?.carKing?.å·²æ‰§è¡Œæ—¥æœŸ?.length || 0;
            if (carDays > 0) {
                if (carDays >= 3) {
                    carBadge = '<span class="badge-sm success">3/3å¤©</span>';
                } else {
                    carBadge = `<span class="badge-sm warning">${carDays}/3å¤©</span>`;
                }
            }

            // === å¾ªç¯ä»»åŠ¡ ===
            // å’¸å°†å¡”
            let towerBadge = '<span class="badge-sm gray">æ— æ•°æ®</span>';
            if (status?.tower?.towerId > 0) {
                const å±‚æ•° = Math.floor(status.tower.towerId / 10) + 1;
                const å…³å¡ = status.tower.towerId % 10;
                const energy = status.tower.energy || 0;
                towerBadge = `<span class="badge-sm info">${å±‚æ•°}å±‚${å…³å¡}å…³</span>`;
            }

            // === å…¶ä»–ä»»åŠ¡ ===
            // é»‘å¸‚å‘¨è´­ä¹°
            let blackMarketBadge = '<span class="badge-sm gray">éé»‘å¸‚å‘¨</span>';
            if (awt === 'é»‘å¸‚å‘¨') {
                if (status?.blackMarketWeek?.è´­ä¹°æ—¥æœŸ) {
                    const buyTime = new Date(status.blackMarketWeek.è´­ä¹°æ—¥æœŸ).getTime();
                    if (buyTime >= è®¡ç®—æ´»åŠ¨å‘¨å¼€å§‹æ—¶é—´(new Date())) {
                        blackMarketBadge = '<span class="badge-sm success">å·²è´­ä¹°</span>';
                    } else {
                        blackMarketBadge = '<span class="badge-sm warning">å¾…è´­ä¹°</span>';
                    }
                } else {
                    blackMarketBadge = '<span class="badge-sm info">å¾…è´­ä¹°</span>';
                }
            } else {
                blackMarketBadge = `<span class="badge-sm gray">${awt}</span>`;
            }

            // é’“é±¼æœˆåº¦
            const fishCfg = currentConfig?.[name]?.æ¯æ—¥ä»»åŠ¡?.é’“é±¼æœˆåº¦è¡¥é½;
            let fishBadge = '<span class="badge-sm gray">æœªå¼€å¯</span>';
            if (fishCfg) {
                const fm = status?.é’“é±¼æœˆåº¦;
                if (fm?.å½“å‰è¿›åº¦ !== undefined) {
                    const current = fm.å½“å‰è¿›åº¦;
                    const target = fm.åº”è¾¾è¿›åº¦ || 0;
                    if (current >= target) {
                        fishBadge = `<span class="badge-sm success">${current}æ¬¡âœ“</span>`;
                    } else {
                        fishBadge = `<span class="badge-sm warning">${current}/${target}</span>`;
                    }
                } else {
                    fishBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
                }
            }

            // ç«æŠ€åœºæœˆåº¦
            const arenaCfg = currentConfig?.[name]?.ç«æŠ€åœº?.æœˆåº¦è¡¥é½;
            let arenaMonthBadge = '<span class="badge-sm gray">æœªå¼€å¯</span>';
            if (arenaCfg) {
                const am = status?.arena;
                if (am?.æœˆåº¦è¿›åº¦ !== undefined) {
                    const current = am.æœˆåº¦è¿›åº¦;
                    const target = am.æœˆåº¦åº”è¾¾ || 0;
                    if (current >= target) {
                        arenaMonthBadge = `<span class="badge-sm success">${current}æ¬¡âœ“</span>`;
                    } else {
                        arenaMonthBadge = `<span class="badge-sm warning">${current}/${target}</span>`;
                    }
                } else {
                    arenaMonthBadge = '<span class="badge-sm info">å¾…æ‰§è¡Œ</span>';
                }
            }

            return `<tr id="detail-row-${name}" class="detail-row"><td colspan="6"><div class="detail-panel-v2"><div class="task-groups">
                <div class="task-group"><div class="task-group-header daily">ğŸ“‹ æ¯æ—¥ä»»åŠ¡</div><div class="task-group-body">
                    <div class="task-item"><span class="task-item-name">ä¿±ä¹éƒ¨ç­¾åˆ°</span>${signinBadge}</div>
                    <div class="task-item"><span class="task-item-name">æ¯æ—¥å’¸ç‹</span>${kingBadge}</div>
                    <div class="task-item"><span class="task-item-name">ç¯ç¥</span>${genieBadge}</div>
                    <div class="task-item"><span class="task-item-name">BOSSæˆ˜æ–—</span>${bossBadge}</div>
                    <div class="task-item"><span class="task-item-name">ç«æŠ€åœº</span>${arenaBadge}</div>
                </div></div>
                <div class="task-group"><div class="task-group-header battle">ğŸ“… æ¯å‘¨ä»»åŠ¡</div><div class="task-group-body">
                    <div class="task-item"><span class="task-item-name">å’¸é±¼å¤§å†²å…³</span>${studyBadge}</div>
                    <div class="task-item"><span class="task-item-name">æ¢¦å¢ƒ</span>${dreamBadge}</div>
                    <div class="task-item"><span class="task-item-name">å››åœ£ç¢ç‰‡</span>${legionBadge}</div>
                    <div class="task-item"><span class="task-item-name">å®åº“</span>${baokuBadge}</div>
                    <div class="task-item"><span class="task-item-name">ç–¯ç‹‚èµ›è½¦</span>${carBadge}</div>
                </div></div>
                <div class="task-group"><div class="task-group-header monthly">ğŸ”„ å¾ªç¯ä»»åŠ¡</div><div class="task-group-body">
                    <div class="task-item"><span class="task-item-name">å’¸å°†å¡”</span>${towerBadge}</div>
                </div></div>
                <div class="task-group"><div class="task-group-header activity">ğŸ“Œ å…¶ä»–ä»»åŠ¡</div><div class="task-group-body">
                    <div class="task-item"><span class="task-item-name">é»‘å¸‚å‘¨è´­ä¹°</span>${blackMarketBadge}</div>
                    <div class="task-item"><span class="task-item-name">é’“é±¼æœˆåº¦</span>${fishBadge}</div>
                    <div class="task-item"><span class="task-item-name">ç«æŠ€åœºæœˆåº¦</span>${arenaMonthBadge}</div>
                </div></div>
            </div></div></td></tr>`;
        }

        // ç”Ÿæˆé…ç½®å¼¹çª—å†…å®¹
        let currentConfigAccount = null;

        function renderConfigContent(name) {
            const c = currentConfig?.[name] || {};
            const sw = (task, key, checked) => `<label class="toggle-switch"><input type="checkbox" ${checked ? 'checked' : ''} onchange="updateNestedConfig('${name}', '${task}', '${key}', this.checked)"><span class="slider"></span></label>`;
            const swRoot = (key, checked) => `<label class="toggle-switch"><input type="checkbox" ${checked ? 'checked' : ''} onchange="updateNestedConfig('${name}', '${key}', null, this.checked)"><span class="slider"></span></label>`;
            const num = (task, key, val, min, max) => `<div class="cfg-num"><button onclick="adjustNum('${name}','${task}','${key}',-1)">-</button><input type="number" value="${val}" min="${min}" max="${max}" onchange="updateNestedConfig('${name}','${task}','${key}',parseInt(this.value))"><button onclick="adjustNum('${name}','${task}','${key}',1)">+</button></div>`;
            const item = (label, ctrl) => `<div class="cfg-item"><span>${label}</span>${ctrl}</div>`;

            return `<div class="config-content">
                <!-- ç¬¬1è¡Œï¼šæ¯æ—¥ä»»åŠ¡ + ç«æŠ€åœº + BOSSæˆ˜æ–— -->
                <div class="config-row">
                    <div class="config-section wider">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸ“‹ æ¯æ—¥ä»»åŠ¡</span>
                            ${sw('æ¯æ—¥ä»»åŠ¡', 'å¯ç”¨', c.æ¯æ—¥ä»»åŠ¡?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid cols-3">
                            ${item('ä»˜è´¹æ‹›å‹Ÿ', sw('æ¯æ—¥ä»»åŠ¡', 'ä»˜è´¹æ‹›å‹Ÿ', c.æ¯æ—¥ä»»åŠ¡?.ä»˜è´¹æ‹›å‹Ÿ !== false))}
                            ${item('é¢†å–æŒ‚æœº', sw('æ¯æ—¥ä»»åŠ¡', 'é¢†å–æŒ‚æœºå¥–åŠ±', c.æ¯æ—¥ä»»åŠ¡?.é¢†å–æŒ‚æœºå¥–åŠ± !== false))}
                            ${item('å¼€å¯å®ç®±', sw('æ¯æ—¥ä»»åŠ¡', 'å¼€å¯å®ç®±', c.æ¯æ—¥ä»»åŠ¡?.å¼€å¯å®ç®± !== false))}
                            ${item('é¢†å–ç›ç½', sw('æ¯æ—¥ä»»åŠ¡', 'é¢†å–ç›ç½', c.æ¯æ—¥ä»»åŠ¡?.é¢†å–ç›ç½ !== false))}
                            ${item('é¢†å–é‚®ä»¶', sw('æ¯æ—¥ä»»åŠ¡', 'é¢†å–é‚®ä»¶', c.æ¯æ—¥ä»»åŠ¡?.é¢†å–é‚®ä»¶ !== false))}
                            ${item('é»‘å¸‚è´­ä¹°', sw('æ¯æ—¥ä»»åŠ¡', 'é»‘å¸‚è´­ä¹°', c.æ¯æ—¥ä»»åŠ¡?.é»‘å¸‚è´­ä¹° !== false))}
                            ${item('è´­ä¹°æ¸…å•', sw('æ¯æ—¥ä»»åŠ¡', 'è´­ä¹°æ¸…å•', c.æ¯æ—¥ä»»åŠ¡?.è´­ä¹°æ¸…å• !== false))}
                            ${item('æ‰‹åŠ¨è´­ä¹°', sw('æ¯æ—¥ä»»åŠ¡', 'æ‰‹åŠ¨è´­ä¹°', c.æ¯æ—¥ä»»åŠ¡?.æ‰‹åŠ¨è´­ä¹° !== false))}
                            ${item('ğŸ£é’“é±¼æœˆåº¦', sw('æ¯æ—¥ä»»åŠ¡', 'é’“é±¼æœˆåº¦è¡¥é½', c.æ¯æ—¥ä»»åŠ¡?.é’“é±¼æœˆåº¦è¡¥é½ === true))}
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-header">
                            <span class="config-section-title">âš”ï¸ ç«æŠ€åœº</span>
                            ${sw('ç«æŠ€åœº', 'å¯ç”¨', c.ç«æŠ€åœº?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid cols-1">
                            ${item('æœˆåº¦è¡¥é½', sw('ç«æŠ€åœº', 'æœˆåº¦è¡¥é½', c.ç«æŠ€åœº?.æœˆåº¦è¡¥é½ === true))}
                            ${item('é˜µå®¹', num('ç«æŠ€åœº', 'ç«æŠ€åœºé˜µå®¹', c.ç«æŠ€åœº?.ç«æŠ€åœºé˜µå®¹ || 1, 1, 5))}
                            ${item('æˆ˜æ–—æ¬¡æ•°', num('ç«æŠ€åœº', 'æˆ˜æ–—æ¬¡æ•°', c.ç«æŠ€åœº?.æˆ˜æ–—æ¬¡æ•° || 3, 1, 10))}
                        </div>
                    </div>
                    <div class="config-section narrow">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸ‘¹ BOSSæˆ˜æ–—</span>
                            ${sw('BOSSæˆ˜æ–—', 'å¯ç”¨', c.BOSSæˆ˜æ–—?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid cols-1">
                            ${item('é˜µå®¹', num('BOSSæˆ˜æ–—', 'BOSSé˜µå®¹', c.BOSSæˆ˜æ–—?.BOSSé˜µå®¹ || 1, 1, 5))}
                            ${item('æˆ˜æ–—æ¬¡æ•°', num('BOSSæˆ˜æ–—', 'æˆ˜æ–—æ¬¡æ•°', c.BOSSæˆ˜æ–—?.æˆ˜æ–—æ¬¡æ•° || 2, 1, 10))}
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬2è¡Œï¼šå’¸å°†å¡” + é»‘å¸‚å‘¨ + å…¶ä»–ç®€å•ä»»åŠ¡ -->
                <div class="config-row">
                    <div class="config-section narrow">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸ—¼ å’¸å°†å¡”</span>
                            ${sw('å’¸å°†å¡”', 'å¯ç”¨', c.å’¸å°†å¡”?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid cols-1">
                            ${item('é˜µå®¹', num('å’¸å°†å¡”', 'çˆ¬å¡”é˜µå®¹', c.å’¸å°†å¡”?.çˆ¬å¡”é˜µå®¹ || 1, 1, 5))}
                        </div>
                    </div>
                    <div class="config-section">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸ›’ é»‘å¸‚å‘¨è´­ä¹°</span>
                            ${sw('é»‘å¸‚å‘¨è´­ä¹°', 'å¯ç”¨', c.é»‘å¸‚å‘¨è´­ä¹°?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid">
                            ${item('å®ç®±', sw('é»‘å¸‚å‘¨è´­ä¹°', 'è´­ä¹°å®ç®±', c.é»‘å¸‚å‘¨è´­ä¹°?.è´­ä¹°å®ç®± !== false))}
                            ${item('é‡‘é±¼æ†', sw('é»‘å¸‚å‘¨è´­ä¹°', 'è´­ä¹°é‡‘é±¼æ†', c.é»‘å¸‚å‘¨è´­ä¹°?.è´­ä¹°é‡‘é±¼æ† !== false))}
                            ${item('è´å£³', sw('é»‘å¸‚å‘¨è´­ä¹°', 'è´­ä¹°è´å£³', c.é»‘å¸‚å‘¨è´­ä¹°?.è´­ä¹°è´å£³ !== false))}
                            ${item('ç™½ç‰', sw('é»‘å¸‚å‘¨è´­ä¹°', 'è´­ä¹°ç™½ç‰', c.é»‘å¸‚å‘¨è´­ä¹°?.è´­ä¹°ç™½ç‰ !== false))}
                        </div>
                    </div>
                    <div class="config-section wider">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸ® å…¶ä»–ä»»åŠ¡</span>
                        </div>
                        <div class="config-grid cols-3">
                            ${item('æŒ‚æœºå¥–åŠ±', sw('æŒ‚æœºå¥–åŠ±', 'å¯ç”¨', c.æŒ‚æœºå¥–åŠ±?.å¯ç”¨ !== false))}
                            ${item('ç›ç½æœºå™¨', sw('ç›ç½æœºå™¨', 'å¯ç”¨', c.ç›ç½æœºå™¨?.å¯ç”¨ !== false))}
                            ${item('å’¸é±¼å†²å…³', sw('å’¸é±¼å¤§å†²å…³', 'å¯ç”¨', c.å’¸é±¼å¤§å†²å…³?.å¯ç”¨ !== false))}
                            ${item('ç–¯ç‹‚èµ›è½¦', sw('ç–¯ç‹‚èµ›è½¦', 'å¯ç”¨', c.ç–¯ç‹‚èµ›è½¦?.å¯ç”¨ !== false))}
                            ${item('ä¿±ä¹éƒ¨ç­¾åˆ°', sw('ä¿±ä¹éƒ¨ç­¾åˆ°', 'å¯ç”¨', c.ä¿±ä¹éƒ¨ç­¾åˆ°?.å¯ç”¨ !== false))}
                            ${item('å†›å›¢å•†åº—', sw('å†›å›¢å•†åº—è´­ä¹°', 'å¯ç”¨', c.å†›å›¢å•†åº—è´­ä¹°?.å¯ç”¨ !== false))}
                            ${item('æ¯æ—¥å’¸ç‹', sw('æ¯æ—¥å’¸ç‹', 'å¯ç”¨', c.æ¯æ—¥å’¸ç‹?.å¯ç”¨ !== false))}
                            ${item('ç¯ç¥', sw('ç¯ç¥', 'å¯ç”¨', c.ç¯ç¥?.å¯ç”¨ !== false))}
                            ${item('å®åº“', sw('å®åº“', 'å¯ç”¨', c.å®åº“?.å¯ç”¨ !== false))}
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬3è¡Œï¼šæ¢¦å¢ƒï¼ˆç‹¬å ä¸€è¡Œï¼Œæ¨ªå‘å±•å¼€ï¼‰ -->
                <div class="config-row">
                    <div class="config-section full">
                        <div class="config-section-header">
                            <span class="config-section-title">ğŸŒ™ æ¢¦å¢ƒ</span>
                            ${sw('æ¢¦å¢ƒ', 'å¯ç”¨', c.æ¢¦å¢ƒ?.å¯ç”¨ !== false)}
                        </div>
                        <div class="config-grid cols-4" style="margin-bottom:6px;">
                            ${item('è‡ªåŠ¨æˆ˜æ–—', sw('æ¢¦å¢ƒ', 'è‡ªåŠ¨æˆ˜æ–—', c.æ¢¦å¢ƒ?.è‡ªåŠ¨æˆ˜æ–— !== false))}
                            ${item('é˜µå®¹', num('æ¢¦å¢ƒ', 'æ¢¦å¢ƒé˜µå®¹', c.æ¢¦å¢ƒ?.æ¢¦å¢ƒé˜µå®¹ || 1, 1, 5))}
                        </div>
                        <div class="merchant-row">
                            <span class="merchant-label green">ğŸŸ¢åˆçº§</span>
                            <div class="merchant-items-inline">
                                ${item('æŒ‘æˆ˜ç¥¨', sw('æ¢¦å¢ƒ', 'åˆçº§_æŒ‘æˆ˜ç¥¨', c.æ¢¦å¢ƒ?.åˆçº§_æŒ‘æˆ˜ç¥¨ !== false))}
                                ${item('ç«æŠŠ', sw('æ¢¦å¢ƒ', 'åˆçº§_å’¸ç¥ç«æŠŠ', c.æ¢¦å¢ƒ?.åˆçº§_å’¸ç¥ç«æŠŠ))}
                                ${item('å®ç®±', sw('æ¢¦å¢ƒ', 'åˆçº§_å®ç®±', c.æ¢¦å¢ƒ?.åˆçº§_å®ç®±))}
                            </div>
                        </div>
                        <div class="merchant-row">
                            <span class="merchant-label yellow">ğŸŸ¡ä¸­çº§</span>
                            <div class="merchant-items-inline">
                                ${item('æ™¶çŸ³', sw('æ¢¦å¢ƒ', 'ä¸­çº§_æ¢¦é­‡æ™¶çŸ³', c.æ¢¦å¢ƒ?.ä¸­çº§_æ¢¦é­‡æ™¶çŸ³))}
                                ${item('é±¼ç«¿', sw('æ¢¦å¢ƒ', 'ä¸­çº§_é»„é‡‘é±¼ç«¿', c.æ¢¦å¢ƒ?.ä¸­çº§_é»„é‡‘é±¼ç«¿))}
                                ${item('æ‹›å‹Ÿä»¤', sw('æ¢¦å¢ƒ', 'ä¸­çº§_æ‹›å‹Ÿä»¤', c.æ¢¦å¢ƒ?.ä¸­çº§_æ‹›å‹Ÿä»¤))}
                                ${item('å®ç®±', sw('æ¢¦å¢ƒ', 'ä¸­çº§_å®ç®±', c.æ¢¦å¢ƒ?.ä¸­çº§_å®ç®±))}
                                ${item('å°†é­‚', sw('æ¢¦å¢ƒ', 'ä¸­çº§_å°†é­‚ç¢ç‰‡', c.æ¢¦å¢ƒ?.ä¸­çº§_å°†é­‚ç¢ç‰‡))}
                            </div>
                        </div>
                        <div class="merchant-row">
                            <span class="merchant-label red">ğŸ”´é«˜çº§</span>
                            <div class="merchant-items-inline">
                                ${item('æ™¶çŸ³', sw('æ¢¦å¢ƒ', 'é«˜çº§_æ¢¦é­‡æ™¶çŸ³', c.æ¢¦å¢ƒ?.é«˜çº§_æ¢¦é­‡æ™¶çŸ³))}
                                ${item('é±¼ç«¿', sw('æ¢¦å¢ƒ', 'é«˜çº§_é»„é‡‘é±¼ç«¿', c.æ¢¦å¢ƒ?.é«˜çº§_é»„é‡‘é±¼ç«¿ !== false))}
                                ${item('æ‹›å‹Ÿä»¤', sw('æ¢¦å¢ƒ', 'é«˜çº§_æ‹›å‹Ÿä»¤', c.æ¢¦å¢ƒ?.é«˜çº§_æ‹›å‹Ÿä»¤))}
                                ${item('å®ç®±', sw('æ¢¦å¢ƒ', 'é«˜çº§_å®ç®±', c.æ¢¦å¢ƒ?.é«˜çº§_å®ç®± !== false))}
                                ${item('å°†é­‚', sw('æ¢¦å¢ƒ', 'é«˜çº§_å°†é­‚ç¢ç‰‡', c.æ¢¦å¢ƒ?.é«˜çº§_å°†é­‚ç¢ç‰‡))}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // æ‰“å¼€é…ç½®å¼¹çª—
        function openConfigModal(name) {
            currentConfigAccount = name;
            document.getElementById('configModalTitle').textContent = `âš™ï¸ ${name} - ä»»åŠ¡é…ç½®`;
            document.getElementById('configModalBody').innerHTML = renderConfigContent(name);
            document.getElementById('configModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // å…³é—­é…ç½®å¼¹çª—
        function closeConfigModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('configModal').classList.remove('show');
            document.body.style.overflow = '';
            currentConfigAccount = null;
        }

        // äº¤äº’å‡½æ•°
        function toggleDetail(name) {
            const detailRow = document.getElementById(`detail-row-${name}`);
            const dataRow = document.getElementById(`data-row-${name}`);
            const expandIcon = dataRow.querySelector('.expand-icon');

            if (expandedAccount === name) {
                expandedAccount = null;
                detailRow.classList.remove('show');
                dataRow.classList.remove('expanded');
                expandIcon.classList.remove('open');
            } else {
                if (expandedAccount) {
                    document.getElementById(`detail-row-${expandedAccount}`)?.classList.remove('show');
                    const prevData = document.getElementById(`data-row-${expandedAccount}`);
                    prevData?.classList.remove('expanded');
                    prevData?.querySelector('.expand-icon')?.classList.remove('open');
                }
                expandedAccount = name;
                detailRow.classList.add('show');
                dataRow.classList.add('expanded');
                expandIcon.classList.add('open');
            }
        }

        function openTools(name) {
            showPage('tools');
            document.getElementById('toolsFrame').src = 'tools.html?account=' + encodeURIComponent(name);
        }

        // åˆ‡æ¢è´¦å·å¯ç”¨çŠ¶æ€
        function toggleAccountEnabled(name) {
            if (!currentConfig) currentConfig = {};
            if (!currentConfig[name]) currentConfig[name] = {};
            const newValue = currentConfig[name].å¯ç”¨ === false ? true : false;
            currentConfig[name].å¯ç”¨ = newValue;
            autoSaveConfig(name);
            renderStatusTable();
        }

        function updateNestedConfig(name, taskName, key, value) {
            if (!currentConfig) currentConfig = {};
            if (!currentConfig[name]) currentConfig[name] = {};
            if (key === null) {
                currentConfig[name][taskName] = value;
            } else {
                if (!currentConfig[name][taskName]) currentConfig[name][taskName] = {};
                currentConfig[name][taskName][key] = value;
            }
            autoSaveConfig(name);
        }

        let saveTimers = {};
        function autoSaveConfig(name) {
            if (saveTimers[name]) clearTimeout(saveTimers[name]);
            saveTimers[name] = setTimeout(() => saveAccountConfig(name), 500);
        }

        function adjustNum(name, task, key, delta) {
            const ranges = { 'ç«æŠ€åœºé˜µå®¹': [1, 5], 'æˆ˜æ–—æ¬¡æ•°': [1, 10], 'BOSSé˜µå®¹': [1, 5], 'æ¢¦å¢ƒé˜µå®¹': [1, 5], 'çˆ¬å¡”é˜µå®¹': [1, 5], 'æœ€å¤§å°é±¼å¹²æ•°': [1, 50] };
            const [min, max] = ranges[key] || [1, 10];
            const current = currentConfig?.[name]?.[task]?.[key] || (key === 'æœ€å¤§å°é±¼å¹²æ•°' ? 10 : key === 'æˆ˜æ–—æ¬¡æ•°' ? 3 : 1);
            const newVal = Math.max(min, Math.min(max, current + delta));
            updateNestedConfig(name, task, key, newVal);
            // åˆ·æ–°å¼¹çª—å†…å®¹
            if (currentConfigAccount === name) {
                document.getElementById('configModalBody').innerHTML = renderConfigContent(name);
            }
        }

        async function saveAccountConfig(name) {
            try {
                const response = await fetch(`/data/task-config.json?t=${Date.now()}`);
                let fullConfig = response.ok ? await response.json() : {};
                if (!fullConfig.è´¦å·é…ç½®) fullConfig.è´¦å·é…ç½® = {};
                fullConfig.è´¦å·é…ç½®[name] = currentConfig[name];
                const saveRes = await fetch(`${API_BASE}/api/save-config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(fullConfig)
                });
                const result = await saveRes.json();
                if (result.success) {
                    const status = document.getElementById('saveStatus');
                    status.classList.add('show');
                    setTimeout(() => status.classList.remove('show'), 2000);
                }
            } catch (e) { console.error('ä¿å­˜å¤±è´¥:', e); }
        }

        function startCountdown(name, status) {
            const now = Date.now() / 1000;
            const bottleHelper = status?.bottleHelper;
            if (bottleHelper) {
                const hst = bottleHelper.helperStopTime || 0;
                if ((bottleHelper.isRunning || hst > now) && hst > now) {
                    countdowns[`bottle-${name}`] = setInterval(() => {
                        const elem = document.getElementById(`bottle-${name}`);
                        if (elem) {
                            const remaining = Math.floor(hst - Date.now() / 1000);
                            if (remaining > 0) elem.textContent = formatShortTime(remaining);
                            else {
                                elem.parentElement.innerHTML = '<span class="badge gray">å·²åœæ­¢</span>';
                                clearInterval(countdowns[`bottle-${name}`]);
                            }
                        } else clearInterval(countdowns[`bottle-${name}`]);
                    }, 1000);
                }
            }
            const hangUp = status?.hangUp;
            if (hangUp && hangUp.lastTime > 0) {
                const lastTime = hangUp.lastTime, hangUpTime = hangUp.hangUpTime || 0;
                countdowns[`hangup-${name}`] = setInterval(() => {
                    const elem = document.getElementById(`hangup-${name}`);
                    if (elem) {
                        const currentTime = Date.now() / 1000;
                        const elapsedTime = Math.floor(currentTime - lastTime);
                        if (hangUpTime > 0) {
                            const remainingTime = Math.floor(hangUpTime - (currentTime - lastTime));
                            if (remainingTime > 0) elem.textContent = formatShortTime(elapsedTime);
                            else {
                                elem.parentElement.innerHTML = '<span class="badge warning">å·²å®Œæˆ</span>';
                                clearInterval(countdowns[`hangup-${name}`]);
                            }
                        } else elem.textContent = formatShortTime(elapsedTime);
                    } else clearInterval(countdowns[`hangup-${name}`]);
                }, 1000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ä» URL hash æ¢å¤é¡µé¢çŠ¶æ€
            const hash = window.location.hash.replace('#', '');
            const validPages = ['status', 'tools', 'bin', 'logs', 'hangup'];
            if (hash && validPages.includes(hash)) {
                showPage(hash, false);
            } else {
                loadStatusData();
            }

            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            document.getElementById('uploadArea')?.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput')?.addEventListener('change', handleFileUpload);

            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
                uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
                uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFileUpload({ target: { files: e.dataTransfer.files } }); });
            }
        });

        // ç›‘å¬æµè§ˆå™¨å‰è¿›/åé€€
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.replace('#', '');
            const validPages = ['status', 'tools', 'bin', 'logs', 'hangup'];
            if (hash && validPages.includes(hash)) showPage(hash, false);
        });

        // ==================== BINç®¡ç†é¡µ ====================
        async function loadBinFiles() {
            try {
                const response = await fetch(`${API_BASE}/api/bin-files`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                const container = document.getElementById('fileListContent');
                if (!data.success) { container.innerHTML = '<div class="no-data"><div class="no-data-icon">âŒ</div><div class="no-data-text">åŠ è½½å¤±è´¥</div></div>'; return; }
                const files = data.files || [];
                if (!files.length) { container.innerHTML = '<div class="no-data"><div class="no-data-icon">ğŸ“</div><div class="no-data-text">æš‚æ— BINæ–‡ä»¶</div></div>'; return; }

                let hangupConfig = {};
                try { const r = await fetch(`${API_BASE}/api/hangup-config`); const d = await r.json(); if (d.success) hangupConfig = d.config || {}; } catch (e) { }

                let html = '';
                files.forEach(file => {
                    const accountName = file.name.replace(/\.bin$/i, '');
                    const isEnabled = hangupConfig[accountName] === true;
                    html += `<div class="file-item">
                        <div class="file-info"><div class="file-name">${file.name}</div><div class="file-meta">å¤§å°: ${(file.size / 1024).toFixed(1)}KB | åˆ›å»ºæ—¶é—´: ${new Date(file.created).toLocaleString()}</div></div>
                        <div class="file-actions">
                            <span class="hangup-label">æŒ‚æœº:</span>
                            <label class="toggle-switch"><input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleHangup('${file.name}', this.checked)"><span class="slider"></span></label>
                            <button class="btn danger" onclick="deleteBinFile('${file.name}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } catch (e) { document.getElementById('fileListContent').innerHTML = '<div class="no-data"><div class="no-data-icon">âŒ</div><div class="no-data-text">åŠ è½½å¤±è´¥: ' + e.message + '</div></div>'; }
        }

        async function deleteBinFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${filename} å—ï¼Ÿ`)) return;
            try {
                const response = await fetch(`${API_BASE}/api/delete-bin/${encodeURIComponent(filename)}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) { alert(`âœ“ ${filename} åˆ é™¤æˆåŠŸï¼`); setTimeout(() => loadBinFiles(), 1000); }
                else throw new Error(data.message || 'åˆ é™¤å¤±è´¥');
            } catch (e) { alert('åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + e.message); }
        }

        async function toggleHangup(filename, enabled) {
            try {
                const accountName = filename.replace(/\.bin$/i, '');
                const response = await fetch(`${API_BASE}/api/hangup-config/${encodeURIComponent(accountName)}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled })
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'æ“ä½œå¤±è´¥');
            } catch (e) { alert('æŒ‚æœºè®¾ç½®å¤±è´¥: ' + e.message); event.target.checked = !enabled; }
        }

        async function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            for (const file of files) {
                if (!file.name.endsWith('.bin')) { alert(`${file.name} ä¸æ˜¯BINæ–‡ä»¶`); continue; }
                const formData = new FormData(); formData.append('file', file);
                try {
                    const response = await fetch(`${API_BASE}/api/upload-bin`, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.success) alert(`âœ“ ${file.name} ä¸Šä¼ æˆåŠŸï¼`);
                    else throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
                } catch (e) { alert(`ä¸Šä¼  ${file.name} å¤±è´¥: ${e.message}`); }
            }
            setTimeout(() => loadBinFiles(), 1000);
            document.getElementById('fileInput').value = '';
        }

        // ==================== æ—¥å¿—é¡µ ====================
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs`);
                const result = await response.json();
                const container = document.getElementById('logContainer');
                if (!result.success || !result.logs?.trim()) { container.innerHTML = '<div class="no-data"><div class="no-data-icon">ğŸ“</div><div class="no-data-text">æš‚æ— æ—¥å¿—</div></div>'; return; }
                const lines = result.logs.split('\n').slice(-500);
                let html = '';
                lines.forEach(line => {
                    if (!line.trim()) return;
                    let className = 'log-line';
                    if (line.includes('[INFO]')) className += ' log-info';
                    else if (line.includes('[OK]')) className += ' log-ok';
                    else if (line.includes('[ERROR]')) className += ' log-error';
                    else if (line.includes('[WARN]')) className += ' log-warn';
                    html += `<div class="${className}">${line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
                });
                container.innerHTML = html;
                container.scrollTop = container.scrollHeight;
            } catch (e) { document.getElementById('logContainer').innerHTML = '<div class="no-data"><div class="no-data-icon">âŒ</div><div class="no-data-text">åŠ è½½æ—¥å¿—å¤±è´¥</div></div>'; }
        }

        function toggleAutoLog() {
            const btn = document.getElementById('autoLogBtn');
            if (isAutoLog) { clearInterval(autoLogInterval); isAutoLog = false; btn.textContent = 'ğŸ”„ è‡ªåŠ¨åˆ·æ–°'; btn.classList.remove('success'); }
            else { autoLogInterval = setInterval(loadLogs, 3000); isAutoLog = true; btn.textContent = 'â¸ï¸ åœæ­¢åˆ·æ–°'; btn.classList.add('success'); loadLogs(); }
        }

        // ==================== æŒ‚æœºæ—¥å¿—é¡µ ====================
        async function loadHangupData() {
            try {
                const [statusRes, logsRes] = await Promise.all([fetch(`${API_BASE}/api/hangup-status`), fetch(`${API_BASE}/api/hangup-logs`)]);
                const status = await statusRes.json();
                const logsResult = await logsRes.json();
                const logs = logsResult.logs || '';
                const stats = status.data?.stats || {};
                document.getElementById('hTotal').textContent = stats.total || 0;
                document.getElementById('hEnabled').textContent = stats.enabled || 0;
                document.getElementById('hOnline').textContent = stats.online || 0;
                document.getElementById('hOffline').textContent = stats.offline || 0;

                const logContainer = document.getElementById('hangupLogContainer');
                if (logs.trim()) {
                    const lines = logs.split('\n').slice(-100);
                    let html = '';
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        let className = 'log-line';
                        if (line.includes('ä¸Šçº¿')) className += ' log-ok';
                        else if (line.includes('ç¦»çº¿') || line.includes('æ–­å¼€')) className += ' log-error';
                        else if (line.includes('è¿æ¥')) className += ' log-info';
                        html += `<div class="${className}">${line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
                    });
                    logContainer.innerHTML = html;
                    logContainer.scrollTop = logContainer.scrollHeight;
                } else { logContainer.innerHTML = '<div class="no-data">æš‚æ— æŒ‚æœºæ—¥å¿—</div>'; }

                const grid = document.getElementById('hangupAccountGrid');
                const accounts = status.data?.accounts || [];
                if (accounts.length) {
                    let html = '';
                    accounts.forEach(acc => {
                        const cardClass = acc.hangupEnabled ? (acc.windowExists ? 'hangup-on' : 'hangup-off') : 'hangup-off';
                        const statusText = acc.windowExists ? 'åœ¨çº¿' : (acc.waitingLogin ? `ç­‰å¾…${acc.waitingMinutes}åˆ†é’Ÿ` : 'ç¦»çº¿');
                        const statusClass = acc.windowExists ? 'online' : (acc.waitingLogin ? 'waiting' : 'offline');
                        html += `<div class="account-card ${cardClass}">
                            <div class="account-card-name">${acc.accountName}</div>
                            <div class="account-card-status">
                                <div class="status-row"><span class="label">æŒ‚æœºçŠ¶æ€:</span><span class="value">${acc.hangupEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}</span></div>
                                <div class="status-row"><span class="label">çª—å£çŠ¶æ€:</span><span class="value ${statusClass}">${statusText}</span></div>
                                <div class="status-row"><span class="label">æœ€åä»»åŠ¡:</span><span class="value">${acc.lastTaskTime || '-'}</span></div>
                            </div>
                        </div>`;
                    });
                    grid.innerHTML = html;
                } else { grid.innerHTML = '<div class="no-data">æš‚æ— æŒ‚æœºè´¦å·</div>'; }
            } catch (e) { console.error('åŠ è½½æŒ‚æœºæ•°æ®å¤±è´¥:', e); }
        }

        function toggleAutoHangup() {
            const btn = document.getElementById('autoHangupBtn');
            if (isAutoHangup) { clearInterval(autoHangupInterval); isAutoHangup = false; btn.textContent = 'ğŸ”„ è‡ªåŠ¨åˆ·æ–°'; btn.classList.remove('success'); }
            else { autoHangupInterval = setInterval(loadHangupData, 5000); isAutoHangup = true; btn.textContent = 'â¸ï¸ åœæ­¢åˆ·æ–°'; btn.classList.add('success'); loadHangupData(); }
        }

        // åˆå§‹åŒ–è·å–è°ƒåº¦å™¨çŠ¶æ€
        getSchedulerStatus();
    </script>
</body>

</html>